<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tutorials/Miscellaneous/Building-Realtime-rt_preempt-kernel-for-ROS-2</title>
</head>
<body>
  <div class="section" id="building-a-real-time-linux-kernel-community-contributed">
<h1>构建实时Linux内核[社区贡献] <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6468">[6468]</a><a class="headerlink" href="#building-a-real-time-linux-kernel-community-contributed" title="永久链接至标题"></a></h1>
<p>本教程以在 Intel x86_64 上进行干净的 Ubuntu 20.04.1安装为起点。实际内核版本为 5.4.0-54-generic，但我们将安装最新稳定的 RT_PREEMPT 版本。要构建内核，您需要至少 30 GB 的可用磁盘空间。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6469">[6469]</a></p>
<p>请查看https://wiki.linuxfoundation.org/realtime/start，了解最新的稳定版本。目前是&quot;Latest Stable Version 5.4-rt&quot;。如果我们点击`链接 &lt;<a class="reference external" href="http://cdn.kernel.org/pub/linux/kernel/projects/rt/5.4/">http://cdn.kernel.org/pub/linux/kernel/projects/rt/5.4/</a>&gt;`_，我们将得到确切的版本。目前的版本是patch-5.4.78-rt44.patch.gz。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6470">[6470]</a></p>
<img alt="../../_images/realtime-kernel-patch-version.png" src="../../_images/realtime-kernel-patch-version.png" />
<p>我们在我们的主目录中创建一个目录，名称为 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6471">[6471]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir ~/kernel
</pre></div>
</div>
<p>并切换到该目录，使用 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6472">[6472]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> ~/kernel
</pre></div>
</div>
<p>我们可以使用浏览器访问 <a class="reference external" href="https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/">https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/</a> ，查看该版本是否存在。您可以从该网站下载并手动将其从/Downloads移动到/kernel文件夹中，或者使用wget下载，方法是右键点击链接并选择“复制链接地址”。示例： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6473">[6473]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/linux-5.4.78.tar.gz
</pre></div>
</div>
<p>使用以下命令解压缩 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6474">[6474]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tar -xzf linux-5.4.78.tar.gz
</pre></div>
</div>
<p>在 <a class="reference external" href="http://cdn.kernel.org/pub/linux/kernel/projects/rt/5.4/">http://cdn.kernel.org/pub/linux/kernel/projects/rt/5.4/</a> 下载与刚刚下载的内核版本匹配的rt_preempt补丁 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6475">[6475]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget http://cdn.kernel.org/pub/linux/kernel/projects/rt/5.4/older/patch-5.4.78-rt44.patch.gz
</pre></div>
</div>
<p>使用以下命令解压缩 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6474">[6474]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gunzip patch-5.4.78-rt44.patch.gz
</pre></div>
</div>
<p>然后切换到linux目录，使用命令 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6476">[6476]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> linux-5.4.78/
</pre></div>
</div>
<p>并使用实时补丁对内核进行补丁 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6477">[6477]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>patch -p1 &lt; ../patch-5.4.78-rt44.patch
</pre></div>
</div>
<p>我们只想使用我们的Ubuntu安装的配置，所以我们使用以下命令获取Ubuntu的配置 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6478">[6478]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cp /boot/config-5.4.0-54-generic .config
</pre></div>
</div>
<p>在Ubuntu软件菜单中的“开放软件和更新”中勾选“源代码”框 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6479">[6479]</a></p>
<p>我们需要一些构建内核的工具，使用以下命令进行安装 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6480">[6480]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt-get build-dep linux
sudo apt-get install libncurses-dev flex bison openssl libssl-dev dkms libelf-dev libudev-dev libpci-dev libiberty-dev autoconf fakeroot
</pre></div>
</div>
<p>为了启用所有的Ubuntu配置，我们只需要使用以下命令 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6481">[6481]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>yes <span class="s1">&#39;&#39;</span> <span class="p">|</span> make oldconfig
</pre></div>
</div>
<p>然后我们需要在内核中启用rt_preempt。我们调用以下命令 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6482">[6482]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make menuconfig
</pre></div>
</div>
<p>设置以下内容 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6483">[6483]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Enable CONFIG_PREEMPT_RT</span>
 -&gt; General Setup
  -&gt; Preemption Model <span class="o">(</span>Fully Preemptible Kernel <span class="o">(</span>Real-Time<span class="o">))</span>
   <span class="o">(</span>X<span class="o">)</span> Fully Preemptible Kernel <span class="o">(</span>Real-Time<span class="o">)</span>

<span class="c1"># Enable CONFIG_HIGH_RES_TIMERS</span>
 -&gt; General setup
  -&gt; Timers subsystem
   <span class="o">[</span>*<span class="o">]</span> High Resolution Timer Support

<span class="c1"># Enable CONFIG_NO_HZ_FULL</span>
 -&gt; General setup
  -&gt; Timers subsystem
   -&gt; Timer tick handling <span class="o">(</span>Full dynticks system <span class="o">(</span>tickless<span class="o">))</span>
    <span class="o">(</span>X<span class="o">)</span> Full dynticks system <span class="o">(</span>tickless<span class="o">)</span>

<span class="c1"># Set CONFIG_HZ_1000 (note: this is no longer in the General Setup menu, go back twice)</span>
 -&gt; Processor <span class="nb">type</span> and features
  -&gt; Timer frequency <span class="o">(</span><span class="m">1000</span> HZ<span class="o">)</span>
   <span class="o">(</span>X<span class="o">)</span> <span class="m">1000</span> HZ

<span class="c1"># Set CPU_FREQ_DEFAULT_GOV_PERFORMANCE [=y]</span>
 -&gt;  Power management and ACPI options
  -&gt; CPU Frequency scaling
   -&gt; CPU Frequency scaling <span class="o">(</span>CPU_FREQ <span class="o">[=</span>y<span class="o">])</span>
    -&gt; Default CPUFreq governor <span class="o">(</span>&lt;choice&gt; <span class="o">[=</span>y<span class="o">])</span>
     <span class="o">(</span>X<span class="o">)</span> performance
</pre></div>
</div>
<p>保存并退出 menuconfig。现在我们要构建内核，这将需要相当长的时间。（在现代CPU上大约需要10-30分钟） <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6484">[6484]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make -j <span class="sb">`</span>nproc<span class="sb">`</span> deb-pkg
</pre></div>
</div>
<p>构建完成后，检查 Debian 软件包 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6485">[6485]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ls ../*deb
../linux-headers-5.4.78-rt41_5.4.78-rt44-1_amd64.deb  ../linux-image-5.4.78-rt44-dbg_5.4.78-rt44-1_amd64.deb
../linux-image-5.4.78-rt41_5.4.78-rt44-1_amd64.deb    ../linux-libc-dev_5.4.78-rt44-1_amd64.deb
</pre></div>
</div>
<p>然后安装所有内核 Debian 软件包 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6486">[6486]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo dpkg -i ../*.deb
</pre></div>
</div>
<p>现在应该已经安装了实时内核。重新启动系统并检查新的内核版本 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=6487">[6487]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo reboot
uname -a
Linux ros2host <span class="m">5</span>.4.78-rt44 <span class="c1">#1 SMP PREEMPT_RT Fri Nov 6 10:37:59 CET 2020 x86_64 xx</span>
</pre></div>
</div>
</div>

  <div id="footer">
    <p>欢迎帮助改进！</p>
  </div>
</body>
</html>