<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tutorials/Intermediate/Tf2/Time-Travel-With-Tf2-Cpp</title>
</head>
<body>
  <div class="section" id="traveling-in-time-c">
<span id="timetravelwithtf2cpp"></span><h1>时间旅行（C++）<a class="headerlink" href="#traveling-in-time-c" title="永久链接至标题"></a></h1>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a>目标：<a href="#id3"><span class="problematic" id="id4">**</span></a>学习有关tf2高级时间旅行功能的知识。</p>
<p><strong>教程级别：</strong> 中级</p>
<p><strong>时间:</strong> 10分钟</p>
<div class="contents local topic" id="contents">
<p class="topic-title">内容</p>
<ul class="simple">
<li><p><a class="reference internal" href="#background" id="id1">背景</a></p></li>
<li><p><a class="reference internal" href="#time-travel" id="id2">时间旅行</a></p></li>
<li><p><a class="reference internal" href="#advanced-api-for-lookuptransform" id="id3">高级API用于查找变换（lookupTransform()）</a></p></li>
<li><p><a class="reference internal" href="#checking-the-results" id="id4">检查结果</a></p></li>
<li><p><a class="reference internal" href="#summary" id="id5">总结</a></p></li>
</ul>
</div>
<div class="section" id="background">
<h2><a class="toc-backref" href="#id1">背景</a><a class="headerlink" href="#background" title="永久链接至标题"></a></h2>
<p>在前面的教程中，我们讨论了:doc:<a class="reference internal" href="Learning-About-Tf2-And-Time-Cpp.html"><span class="doc">tf2和时间的基础知识</span></a>。本教程将带我们迈出一步，并介绍一个强大的tf2技巧：时间旅行。简而言之，tf2库的一个关键功能是它能够在时间和空间上对数据进行转换。</p>
<p>这个tf2时间旅行功能在各种任务中都很有用，比如长时间监测机器人的姿态或构建一个会跟随领导者“步伐”的跟随机器人。我们将利用这个时间旅行功能，在时间上回溯并编程“turtle2”在“carrot1”之后追踪5秒钟。</p>
</div>
<div class="section" id="time-travel">
<h2><a class="toc-backref" href="#id2">时间旅行</a><a class="headerlink" href="#time-travel" title="永久链接至标题"></a></h2>
<p>首先，让我们回到上一教程 :doc:<a href="#id1"><span class="problematic" id="id2">`</span></a>使用时间 &lt;./Learning-About-Tf2-And-Time-Cpp&gt;`结束的地方。进入你的``learning_tf2_cpp``软件包。</p>
<p>现在，不再让第二只乌龟去当前胡萝卜所在的位置，而是让第二只乌龟去第一个胡萝卜5秒钟前所在的位置。在``turtle_tf2_listener.cpp``文件中编辑``lookupTransform()``调用：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_clock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Duration</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf_buffer_</span><span class="o">-&gt;</span><span class="n">lookupTransform</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">toFrameRel</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fromFrameRel</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="mi">50</span><span class="n">ms</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>如果现在运行这段代码，在前5秒钟内，第二只乌龟将不知道该去哪里，因为我们还没有5秒钟的胡萝卜位置历史记录。但是在这5秒钟之后会发生什么呢？让我们试一试：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 launch learning_tf2_cpp turtle_tf2_fixed_frame_demo.launch.py</span>
</pre></div>
</div>
<img alt="../../../_images/turtlesim_delay1.png" src="../../../_images/turtlesim_delay1.png" />
<p>现在你应该注意到，你的乌龟在像这个截图中一样无法控制地四处移动。让我们试着理解背后的原因。</p>
<ol class="arabic simple">
<li><p>在我们的代码中，我们向tf2提出了以下问题：“相对于5秒前的``turtle2``，<a href="#id1"><span class="problematic" id="id2">``</span></a>carrot1``的姿势是什么？” 这意味着我们控制第二只乌龟的位置是基于它5秒钟前的位置以及第一个胡萝卜5秒钟前的位置。</p></li>
<li><p>然而，我们真正想要问的是：“相对于当前``turtle2``的位置，<a href="#id1"><span class="problematic" id="id2">``</span></a>carrot1``在5秒钟前的姿势是什么？”</p></li>
</ol>
</div>
<div class="section" id="advanced-api-for-lookuptransform">
<h2><a class="toc-backref" href="#id3">高级API用于查找变换（lookupTransform()）</a><a class="headerlink" href="#advanced-api-for-lookuptransform" title="永久链接至标题"></a></h2>
<p>为了询问tf2这个特定问题，我们将使用一个高级API，使我们能够明确地指定何时获取指定的转换。这是通过调用``lookupTransform()``方法并使用附加参数来实现的。你的代码现在应该是这样的：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_clock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Duration</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf_buffer_</span><span class="o">-&gt;</span><span class="n">lookupTransform</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">toFrameRel</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">now</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fromFrameRel</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;world&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="mi">50</span><span class="n">ms</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a>lookupTransform()``的高级API接受六个参数：</p>
<ol class="arabic simple">
<li><p>目标帧</p></li>
<li><p>要进行转换的时间</p></li>
<li><p>源帧</p></li>
<li><p>评估源帧的时间</p></li>
<li><p>在这种情况下，<a href="#id1"><span class="problematic" id="id2">``</span></a>world``帧是随时间不变的帧</p></li>
<li><p>等待目标帧可用的时间</p></li>
</ol>
<p>总结一下，在后台，tf2会进行以下操作：它会计算从``carrot1``到``world``的变换。在``world``帧中，tf2会在过去到现在的时间上进行移动。而在当前时间，tf2会计算从``world``到``turtle2``的变换。</p>
</div>
<div class="section" id="checking-the-results">
<h2><a class="toc-backref" href="#id4">检查结果</a><a class="headerlink" href="#checking-the-results" title="永久链接至标题"></a></h2>
<p>让我们再次运行模拟，这次使用高级的时间旅行API：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 launch learning_tf2_cpp turtle_tf2_fixed_frame_demo.launch.py</span>
</pre></div>
</div>
<img alt="../../../_images/turtlesim_delay2.png" src="../../../_images/turtlesim_delay2.png" />
<p>是的，第二只乌龟被定向到了第一根胡萝卜5秒前的位置！</p>
</div>
<div class="section" id="summary">
<h2><a class="toc-backref" href="#id5">总结</a><a class="headerlink" href="#summary" title="永久链接至标题"></a></h2>
<p>在本教程中，您已经了解了tf2的一项高级功能。您了解到tf2可以在时间上对数据进行转换，并学习了如何在turtlesim示例中实现该功能。tf2允许您回溯时间，并通过使用高级的``lookupTransform()`` API在旧的和当前的乌龟姿势之间进行帧转换。</p>
</div>
</div>

  <div id="footer">
    <p>欢迎帮助改进！</p>
  </div>
</body>
</html>