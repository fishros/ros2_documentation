<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tutorials/Intermediate/Tf2/Quaternion-Fundamentals</title>
</head>
<body>
  <div class="section" id="quaternion-fundamentals">
<span id="quaternionfundamentals"></span><h1>四元数基础知识 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5874">[5874]</a><a class="headerlink" href="#quaternion-fundamentals" title="永久链接至标题"></a></h1>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a>目标：<a href="#id3"><span class="problematic" id="id4">**</span></a>学习 ROS 2 中四元数的基本用法。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5875">[5875]</a></p>
<p><strong>教程级别：</strong> 中级 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5286">[5286]</a></p>
<p><strong>时间:</strong> 10分钟 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3663">[3663]</a></p>
<div class="contents local topic" id="contents">
<p class="topic-title">内容 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3277">[3277]</a></p>
<ul class="simple">
<li><p><a class="reference internal" href="#background" id="id1">背景 [3072]</a></p></li>
<li><p><a class="reference internal" href="#prerequisites" id="id2">先决条件 [3124]</a></p></li>
<li><p><a class="reference internal" href="#components-of-a-quaternion" id="id3">四元数的组成部分 [5880]</a></p></li>
<li><p><a class="reference internal" href="#quaternion-types-in-ros-2" id="id4">ROS 2中的四元数类型 [5883]</a></p></li>
<li><p><a class="reference internal" href="#quaternion-operations" id="id5">四元数操作 [5885]</a></p>
<ul>
<li><p><a class="reference internal" href="#think-in-rpy-then-convert-to-quaternion" id="id6">1. 首先按照RPY（滚转、俯仰、偏航）的思维进行计算，然后再转换为四元数。 [5886]</a></p></li>
<li><p><a class="reference internal" href="#applying-a-quaternion-rotation" id="id7">2 应用四元数旋转 [5888]</a></p></li>
<li><p><a class="reference internal" href="#inverting-a-quaternion" id="id8">3 反转一个四元数 [5890]</a></p></li>
<li><p><a class="reference internal" href="#relative-rotations" id="id9">4 相对旋转 [5892]</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#summary" id="id10">总结 [3353]</a></p></li>
</ul>
</div>
<div class="section" id="background">
<h2>背景 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3072">[3072]</a><a class="headerlink" href="#background" title="永久链接至标题"></a></h2>
<p>四元数是表示方向的四元组表示法，比旋转矩阵更简洁。四元数在涉及三维旋转的情况下非常高效。四元数广泛应用于机器人技术、量子力学、计算机视觉和3D动画。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5876">[5876]</a></p>
<p>您可以在 <a class="reference external" href="https://zh.wikipedia.org/wiki/%E5%9B%9B%E5%85%83%E6%95%B0">维基百科</a> 上了解更多有关底层数学概念的内容。您还可以观看 <a class="reference external" href="https://www.youtube.com/3blue1brown">3blue1brown</a> 制作的可视化四元数视频系列 <a class="reference external" href="https://eater.net/quaternions">Visualizing quaternions</a>。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5877">[5877]</a></p>
<p>在本教程中，您将学习ROS 2中四元数和转换方法的工作原理。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5878">[5878]</a></p>
</div>
<div class="section" id="prerequisites">
<h2>先决条件 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3124">[3124]</a><a class="headerlink" href="#prerequisites" title="永久链接至标题"></a></h2>
<p>然而，这不是硬性要求，您可以选择最适合您的任何其他几何变换库。您可以查看像 <a class="reference external" href="https://github.com/matthew-brett/transforms3d">transforms3d</a>、<a class="reference external" href="https://github.com/scipy/scipy/tree/master/scipy/spatial/transform">scipy.spatial.transform</a>、<a class="reference external" href="https://github.com/rock-learning/pytransform3d">pytransform3d</a>、<a class="reference external" href="https://github.com/moble/quaternion">numpy-quaternion</a> 或 <a class="reference external" href="https://docs.blender.org/api/master/mathutils.html">blender.mathutils</a> 这样的库。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5879">[5879]</a></p>
</div>
<div class="section" id="components-of-a-quaternion">
<h2>四元数的组成部分 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5880">[5880]</a><a class="headerlink" href="#components-of-a-quaternion" title="永久链接至标题"></a></h2>
<p>ROS 2使用四元数来跟踪和应用旋转。一个四元数有四个分量 <code class="docutils literal notranslate"><span class="pre">(x,</span> <span class="pre">y,</span> <span class="pre">z,</span> <span class="pre">w)</span></code>。在ROS 2中，<code class="docutils literal notranslate"><span class="pre">w</span></code> 在最后一位，但在一些库中如Eigen中，<code class="docutils literal notranslate"><span class="pre">w</span></code> 可以放在第一位。常用的单位四元数在x/y/z轴上不产生旋转，表示为 <code class="docutils literal notranslate"><span class="pre">(0,</span> <span class="pre">0,</span> <span class="pre">0,</span> <span class="pre">1)</span></code>，可以用以下方式创建： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5881">[5881]</a></p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;tf2/LinearMath/Quaternion.h&gt;</span><span class="cp"></span>
<span class="p">...</span><span class="w"></span>

<span class="n">tf2</span><span class="o">::</span><span class="n">Quaternion</span><span class="w"> </span><span class="n">q</span><span class="p">;</span><span class="w"></span>
<span class="c1">// Create a quaternion from roll/pitch/yaw in radians (0, 0, 0)</span>
<span class="n">q</span><span class="p">.</span><span class="n">setRPY</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="c1">// Print the quaternion components (0, 0, 0, 1)</span>
<span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;%f %f %f %f&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">q</span><span class="p">.</span><span class="n">x</span><span class="p">(),</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">y</span><span class="p">(),</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">z</span><span class="p">(),</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">w</span><span class="p">());</span><span class="w"></span>
</pre></div>
</div>
<p>四元数的模应该始终为1。如果数值误差导致四元数模不为1，ROS 2将打印警告。为避免这些警告，请对四元数进行归一化： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5882">[5882]</a></p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">q</span><span class="p">.</span><span class="n">normalize</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="quaternion-types-in-ros-2">
<h2>ROS 2中的四元数类型 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5883">[5883]</a><a class="headerlink" href="#quaternion-types-in-ros-2" title="永久链接至标题"></a></h2>
<p>ROS 2使用两种四元数数据类型：<code class="docutils literal notranslate"><span class="pre">tf2::Quaternion``和它的等效类型``geometry_msgs::msg::Quaternion</span></code>。在C++中进行类型转换，可以使用``tf2_geometry_msgs``中的方法。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5884">[5884]</a></p>
<p>C++ <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3772">[3772]</a></p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;tf2_geometry_msgs/tf2_geometry_msgs.hpp&gt;</span><span class="cp"></span>
<span class="p">...</span><span class="w"></span>

<span class="n">tf2</span><span class="o">::</span><span class="n">Quaternion</span><span class="w"> </span><span class="n">tf2_quat</span><span class="p">,</span><span class="w"> </span><span class="n">tf2_quat_from_msg</span><span class="p">;</span><span class="w"></span>
<span class="n">tf2_quat</span><span class="p">.</span><span class="n">setRPY</span><span class="p">(</span><span class="n">roll</span><span class="p">,</span><span class="w"> </span><span class="n">pitch</span><span class="p">,</span><span class="w"> </span><span class="n">yaw</span><span class="p">);</span><span class="w"></span>
<span class="c1">// Convert tf2::Quaternion to geometry_msgs::msg::Quaternion</span>
<span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Quaternion</span><span class="w"> </span><span class="n">msg_quat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf2</span><span class="o">::</span><span class="n">toMsg</span><span class="p">(</span><span class="n">tf2_quat</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Convert geometry_msgs::msg::Quaternion to tf2::Quaternion</span>
<span class="n">tf2</span><span class="o">::</span><span class="n">convert</span><span class="p">(</span><span class="n">msg_quat</span><span class="p">,</span><span class="w"> </span><span class="n">tf2_quat_from_msg</span><span class="p">);</span><span class="w"></span>
<span class="c1">// or</span>
<span class="n">tf2</span><span class="o">::</span><span class="n">fromMsg</span><span class="p">(</span><span class="n">msg_quat</span><span class="p">,</span><span class="w"> </span><span class="n">tf2_quat_from_msg</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Python <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3771">[3771]</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Quaternion</span>
<span class="o">...</span>

<span class="c1"># Create a list of floats, which is compatible with tf2</span>
<span class="c1"># Quaternion methods</span>
<span class="n">quat_tf</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>

<span class="c1"># Convert a list to geometry_msgs.msg.Quaternion</span>
<span class="n">msg_quat</span> <span class="o">=</span> <span class="n">Quaternion</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">quat_tf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">quat_tf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">quat_tf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">w</span><span class="o">=</span><span class="n">quat_tf</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="quaternion-operations">
<h2>四元数操作 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5885">[5885]</a><a class="headerlink" href="#quaternion-operations" title="永久链接至标题"></a></h2>
<div class="section" id="think-in-rpy-then-convert-to-quaternion">
<h3>1. 首先按照RPY（滚转、俯仰、偏航）的思维进行计算，然后再转换为四元数。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5886">[5886]</a><a class="headerlink" href="#think-in-rpy-then-convert-to-quaternion" title="永久链接至标题"></a></h3>
<p>我们更容易以轴旋转的方式思考，但很难用四元数来思考。一个建议是首先按照滚转（绕X轴）、俯仰（绕Y轴）和偏航（绕Z轴）计算目标旋转，然后再将其转换为四元数。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5887">[5887]</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># quaternion_from_euler method is available in turtle_tf2_py/turtle_tf2_py/turtle_tf2_broadcaster.py</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">quaternion_from_euler</span><span class="p">(</span><span class="mf">1.5707</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5707</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The quaternion representation is x: </span><span class="si">{</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> y: </span><span class="si">{</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> z: </span><span class="si">{</span><span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1"> w: </span><span class="si">{</span><span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="applying-a-quaternion-rotation">
<h3>2 应用四元数旋转 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5888">[5888]</a><a class="headerlink" href="#applying-a-quaternion-rotation" title="永久链接至标题"></a></h3>
<p>要将一个四元数的旋转应用于姿势，只需将姿势的先前四元数乘以表示所需旋转的四元数。此乘法的顺序很重要。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5889">[5889]</a></p>
<p>C++ <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3772">[3772]</a></p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;tf2_geometry_msgs/tf2_geometry_msgs.hpp&gt;</span><span class="cp"></span>
<span class="p">...</span><span class="w"></span>

<span class="n">tf2</span><span class="o">::</span><span class="n">Quaternion</span><span class="w"> </span><span class="n">q_orig</span><span class="p">,</span><span class="w"> </span><span class="n">q_rot</span><span class="p">,</span><span class="w"> </span><span class="n">q_new</span><span class="p">;</span><span class="w"></span>

<span class="n">q_orig</span><span class="p">.</span><span class="n">setRPY</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span><span class="w"></span>
<span class="c1">// Rotate the previous pose by 180* about X</span>
<span class="n">q_rot</span><span class="p">.</span><span class="n">setRPY</span><span class="p">(</span><span class="mf">3.14159</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span><span class="w"></span>
<span class="n">q_new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q_rot</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q_orig</span><span class="p">;</span><span class="w"></span>
<span class="n">q_new</span><span class="p">.</span><span class="n">normalize</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
<p>Python <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3771">[3771]</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">q_orig</span> <span class="o">=</span> <span class="n">quaternion_from_euler</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="c1"># Rotate the previous pose by 180* about X</span>
<span class="n">q_rot</span> <span class="o">=</span> <span class="n">quaternion_from_euler</span><span class="p">(</span><span class="mf">3.14159</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">q_new</span> <span class="o">=</span> <span class="n">quaternion_multiply</span><span class="p">(</span><span class="n">q_rot</span><span class="p">,</span> <span class="n">q_orig</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="inverting-a-quaternion">
<h3>3 反转一个四元数 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5890">[5890]</a><a class="headerlink" href="#inverting-a-quaternion" title="永久链接至标题"></a></h3>
<p>反转一个四元数的简单方法是对 w 分量取负： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5891">[5891]</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="relative-rotations">
<h3>4 相对旋转 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5892">[5892]</a><a class="headerlink" href="#relative-rotations" title="永久链接至标题"></a></h3>
<p>假设您有来自同一帧的两个四元数 <code class="xref any docutils literal notranslate"><span class="pre">q_1</span></code> 和 <code class="xref any docutils literal notranslate"><span class="pre">q_2</span></code>。您希望找到相对旋转 <code class="xref any docutils literal notranslate"><span class="pre">q_r</span></code>，它以以下方式将 <code class="xref any docutils literal notranslate"><span class="pre">q_1</span></code> 转换为 <code class="xref any docutils literal notranslate"><span class="pre">q_2</span></code>： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5893">[5893]</a></p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">q_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q_r</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q_1</span><span class="w"></span>
</pre></div>
</div>
<p>你可以类似于解矩阵方程来解``q_r``。求``q_1``的逆矩阵，并将两边右乘。再次强调，乘法的顺序很重要： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5894">[5894]</a></p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">q_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q_2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q_1_inverse</span><span class="w"></span>
</pre></div>
</div>
<p>下面是一个示例，用Python计算从之前的机器人姿态到当前机器人姿态的相对旋转： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5895">[5895]</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">quaternion_multiply</span><span class="p">(</span><span class="n">q0</span><span class="p">,</span> <span class="n">q1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multiplies two quaternions.</span>

<span class="sd">    Input</span>
<span class="sd">    :param q0: A 4 element array containing the first quaternion (q01, q11, q21, q31)</span>
<span class="sd">    :param q1: A 4 element array containing the second quaternion (q02, q12, q22, q32)</span>

<span class="sd">    Output</span>
<span class="sd">    :return: A 4 element array containing the final quaternion (q03,q13,q23,q33)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract the values from q0</span>
    <span class="n">w0</span> <span class="o">=</span> <span class="n">q0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">q0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">q0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">z0</span> <span class="o">=</span> <span class="n">q0</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="c1"># Extract the values from q1</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="n">q1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">q1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">q1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">q1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="c1"># Computer the product of the two quaternions, term by term</span>
    <span class="n">q0q1_w</span> <span class="o">=</span> <span class="n">w0</span> <span class="o">*</span> <span class="n">w1</span> <span class="o">-</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">z0</span> <span class="o">*</span> <span class="n">z1</span>
    <span class="n">q0q1_x</span> <span class="o">=</span> <span class="n">w0</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">w1</span> <span class="o">+</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">z1</span> <span class="o">-</span> <span class="n">z0</span> <span class="o">*</span> <span class="n">y1</span>
    <span class="n">q0q1_y</span> <span class="o">=</span> <span class="n">w0</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">z1</span> <span class="o">+</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">w1</span> <span class="o">+</span> <span class="n">z0</span> <span class="o">*</span> <span class="n">x1</span>
    <span class="n">q0q1_z</span> <span class="o">=</span> <span class="n">w0</span> <span class="o">*</span> <span class="n">z1</span> <span class="o">+</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">z0</span> <span class="o">*</span> <span class="n">w1</span>

    <span class="c1"># Create a 4 element array containing the final quaternion</span>
    <span class="n">final_quaternion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">q0q1_w</span><span class="p">,</span> <span class="n">q0q1_x</span><span class="p">,</span> <span class="n">q0q1_y</span><span class="p">,</span> <span class="n">q0q1_z</span><span class="p">])</span>

    <span class="c1"># Return a 4 element array containing the final quaternion (q02,q12,q22,q32)</span>
    <span class="k">return</span> <span class="n">final_quaternion</span>

<span class="n">q1_inv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">x</span>
<span class="n">q1_inv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">y</span>
<span class="n">q1_inv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">z</span>
<span class="n">q1_inv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">prev_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span> <span class="c1"># Negate for inverse</span>

<span class="n">q2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">x</span>
<span class="n">q2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">y</span>
<span class="n">q2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">z</span>
<span class="n">q2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span>

<span class="n">qr</span> <span class="o">=</span> <span class="n">quaternion_multiply</span><span class="p">(</span><span class="n">q2</span><span class="p">,</span> <span class="n">q1_inv</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="summary">
<h2>总结 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3353">[3353]</a><a class="headerlink" href="#summary" title="永久链接至标题"></a></h2>
<p>在本教程中，你学习了四元数的基本概念及其相关的数学运算，如求逆和旋转。你还学习了ROS 2中的使用示例以及两个独立四元数类之间的转换方法。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5896">[5896]</a></p>
</div>
</div>

  <div id="footer">
    <p>欢迎帮助改进！</p>
  </div>
</body>
</html>