<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tutorials/Intermediate/Tf2/Learning-About-Tf2-And-Time-Cpp</title>
</head>
<body>
  <div class="section" id="using-time-c">
<span id="learningabouttf2andtimecpp"></span><h1>使用时间（C++）<a class="headerlink" href="#using-time-c" title="永久链接至标题"></a></h1>
<p><strong>目标：</strong> 学习如何使用 <code class="docutils literal notranslate"><span class="pre">lookupTransform()</span></code> 函数在特定时间获取变换，并等待 tf2 树上的变换可用。</p>
<p><strong>教程级别：</strong> 中级</p>
<p><strong>时间:</strong> 10分钟</p>
<div class="contents local topic" id="contents">
<p class="topic-title">内容</p>
<ul class="simple">
<li><p><a class="reference internal" href="#background" id="id1">背景</a></p></li>
<li><p><a class="reference internal" href="#tasks" id="id2">任务</a></p>
<ul>
<li><p><a class="reference internal" href="#tf2-and-time" id="id3">1 tf2 和时间</a></p></li>
<li><p><a class="reference internal" href="#wait-for-transforms" id="id4">2 等待转换</a></p></li>
<li><p><a class="reference internal" href="#checking-the-results" id="id5">3 检查结果</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#summary" id="id6">总结</a></p></li>
</ul>
</div>
<div class="section" id="background">
<h2><a class="toc-backref" href="#id1">背景</a><a class="headerlink" href="#background" title="永久链接至标题"></a></h2>
<p>在之前的教程中，我们通过编写 <a class="reference internal" href="Writing-A-Tf2-Broadcaster-Cpp.html"><span class="doc">tf2 广播器</span></a> 和 <a class="reference internal" href="Writing-A-Tf2-Listener-Cpp.html"><span class="doc">tf2 监听器</span></a> 来重新创建了乌龟演示。我们还学习了如何 <a class="reference internal" href="Adding-A-Frame-Cpp.html"><span class="doc">向变换树中添加新帧</span></a>，以及如何使用 tf2 来跟踪坐标帧的树结构。这个树随着时间的推移而改变，tf2 为每个变换存储了一个时间快照（默认为最近的 10 秒）。到目前为止，我们使用 <code class="docutils literal notranslate"><span class="pre">lookupTransform()</span></code> 函数来获取在 tf2 树中最新可用的变换，而不知道该变换是在何时记录的。本教程将教你如何在特定时间获取变换。</p>
</div>
<div class="section" id="tasks">
<h2><a class="toc-backref" href="#id2">任务</a><a class="headerlink" href="#tasks" title="永久链接至标题"></a></h2>
<div class="section" id="tf2-and-time">
<h3><a class="toc-backref" href="#id3">1 tf2 和时间</a><a class="headerlink" href="#tf2-and-time" title="永久链接至标题"></a></h3>
<p>让我们回到上一个教程 <a class="reference internal" href="Adding-A-Frame-Cpp.html"><span class="doc">添加一个帧</span></a> 结束的地方。打开 <code class="docutils literal notranslate"><span class="pre">learning_tf2_cpp</span></code> 包中的 <code class="docutils literal notranslate"><span class="pre">turtle_tf2_listener.cpp</span></code>，并查看 <code class="docutils literal notranslate"><span class="pre">lookupTransform()</span></code> 的调用：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">transformStamped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf_buffer_</span><span class="o">-&gt;</span><span class="n">lookupTransform</span><span class="p">(</span><span class="w"></span>
<span class="w">   </span><span class="n">toFrameRel</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">fromFrameRel</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">tf2</span><span class="o">::</span><span class="n">TimePointZero</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>你可以看到我们通过调用 <code class="docutils literal notranslate"><span class="pre">tf2::TimePointZero</span></code> 指定了时间为 0。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p><code class="docutils literal notranslate"><span class="pre">tf2</span></code> 包有自己的时间类型 <code class="docutils literal notranslate"><span class="pre">tf2::TimePoint</span></code>，与 <code class="docutils literal notranslate"><span class="pre">rclcpp::Time</span></code> 不同。在 <code class="docutils literal notranslate"><span class="pre">tf2_ros</span></code> 包中，许多 API 自动在 <code class="docutils literal notranslate"><span class="pre">rclcpp::Time</span></code> 和 <code class="docutils literal notranslate"><span class="pre">tf2::TimePoint</span></code> 之间进行转换。</p>
<p><code class="docutils literal notranslate"><span class="pre">rclcpp::Time(0,</span> <span class="pre">0,</span> <span class="pre">this-&gt;get_clock()-&gt;get_clock_type())</span></code> 可以在此处使用，但它最终会被转换为 <code class="docutils literal notranslate"><span class="pre">tf2::TimePointZero</span></code>。</p>
</div>
<p>对于 tf2，时间 0 表示缓冲区中的“最新可用”变换。现在，将此行更改为获取当前时间的变换，即 <code class="docutils literal notranslate"><span class="pre">this-&gt;get_clock()-&gt;now()</span></code>:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_clock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="n">transformStamped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf_buffer_</span><span class="o">-&gt;</span><span class="n">lookupTransform</span><span class="p">(</span><span class="w"></span>
<span class="w">   </span><span class="n">toFrameRel</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">fromFrameRel</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">now</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>现在尝试运行启动文件。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 launch learning_tf2_cpp turtle_tf2_demo.launch.py</span>
</pre></div>
</div>
<p>您会注意到它失败并输出类似于以下内容：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">[INFO] [1629873136.345688064] [listener]: Could not transform turtle1 to turtle2: Lookup would</span>
<span class="go">require extrapolation into the future.  Requested time 1629873136.345539 but the latest data</span>
<span class="go">is at time 1629873136.338804, when looking up transform from frame [turtle1] to frame [turtle2]</span>
</pre></div>
</div>
<p>它告诉您该帧不存在或数据位于未来。</p>
<p>要理解为什么会发生这种情况，我们需要了解缓冲区的工作原理。首先，每个监听器都有一个缓冲区，用于存储来自不同tf2广播器的所有坐标转换。其次，当广播器发送一个转换时，需要一些时间才能将该转换放入缓冲区（通常需要几毫秒）。因此，当您在“现在”时间请求帧转换时，您应该等待几毫秒，以便该信息到达。</p>
</div>
<div class="section" id="wait-for-transforms">
<h3><a class="toc-backref" href="#id4">2 等待转换</a><a class="headerlink" href="#wait-for-transforms" title="永久链接至标题"></a></h3>
<p>tf2提供了一个很好的工具，可以等待直到转换可用。您可以通过向“lookupTransform()”添加一个超时参数来使用该工具。要修复这个问题，请按照下面的代码进行编辑（添加最后一个超时参数）：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_clock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="n">transformStamped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf_buffer_</span><span class="o">-&gt;</span><span class="n">lookupTransform</span><span class="p">(</span><span class="w"></span>
<span class="w">   </span><span class="n">toFrameRel</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">fromFrameRel</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">now</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="mi">50</span><span class="n">ms</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a>lookupTransform()``可以接受四个参数，其中最后一个是可选的超时参数。它会阻塞最多该持续时间，直到超时。</p>
</div>
<div class="section" id="checking-the-results">
<h3><a class="toc-backref" href="#id5">3 检查结果</a><a class="headerlink" href="#checking-the-results" title="永久链接至标题"></a></h3>
<p>现在您可以运行启动文件。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 launch learning_tf2_cpp turtle_tf2_demo.launch.py</span>
</pre></div>
</div>
<p>请注意，<code class="docutils literal notranslate"><span class="pre">lookupTransform()</span></code> 函数将阻塞直到两个乌龟之间的变换可用（通常需要几毫秒）。一旦超时时间到达（此例中为50毫秒），仅当变换仍不可用时才会引发异常。</p>
</div>
</div>
<div class="section" id="summary">
<h2><a class="toc-backref" href="#id6">总结</a><a class="headerlink" href="#summary" title="永久链接至标题"></a></h2>
<p>在本教程中，您学会了如何在特定时间戳获取变换，并在使用``lookupTransform()``函数时等待变换在tf2树上可用。</p>
</div>
</div>

  <div id="footer">
    <p>欢迎帮助改进！</p>
  </div>
</body>
</html>