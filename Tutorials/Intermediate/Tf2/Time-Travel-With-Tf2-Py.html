<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tutorials/Intermediate/Tf2/Time-Travel-With-Tf2-Py</title>
</head>
<body>
  <div class="section" id="traveling-in-time-python">
<span id="timetravelwithtf2py"></span><h1>时间旅行（Python） <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5949">[5949]</a><a class="headerlink" href="#traveling-in-time-python" title="永久链接至标题"></a></h1>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a>目标：<a href="#id3"><span class="problematic" id="id4">**</span></a>学习有关tf2高级时间旅行功能的知识。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5925">[5925]</a></p>
<p><strong>教程级别：</strong> 中级 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5286">[5286]</a></p>
<p><strong>时间:</strong> 10分钟 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3663">[3663]</a></p>
<div class="contents local topic" id="contents">
<p class="topic-title">内容 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3277">[3277]</a></p>
<ul class="simple">
<li><p><a class="reference internal" href="#background" id="id1">背景 [3072]</a></p></li>
<li><p><a class="reference internal" href="#time-travel" id="id2">时间旅行 [5928]</a></p></li>
<li><p><a class="reference internal" href="#advanced-api-for-lookup-transform" id="id3">lookup_transform()的高级API [5953]</a></p></li>
<li><p><a class="reference internal" href="#checking-the-results" id="id4">检查结果 [5945]</a></p></li>
<li><p><a class="reference internal" href="#summary" id="id5">总结 [3353]</a></p></li>
</ul>
</div>
<div class="section" id="background">
<h2>背景 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3072">[3072]</a><a class="headerlink" href="#background" title="永久链接至标题"></a></h2>
<p>在前面的教程中，我们讨论了tf2和时间的基础知识。本教程将进一步介绍一个强大的tf2技巧：时间旅行。简而言之，tf2库的一个关键特性是它能够在时间和空间上对数据进行转换。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5950">[5950]</a></p>
<p>这个tf2时间旅行功能在各种任务中都很有用，比如长时间监测机器人的姿态或构建一个会跟随领导者“步伐”的跟随机器人。我们将利用这个时间旅行功能，在时间上回溯并编程“turtle2”在“carrot1”之后追踪5秒钟。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5927">[5927]</a></p>
</div>
<div class="section" id="time-travel">
<h2>时间旅行 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5928">[5928]</a><a class="headerlink" href="#time-travel" title="永久链接至标题"></a></h2>
<p>首先，让我们回到上一教程中结束的地方。转到您的``learning_tf2_py``包。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5951">[5951]</a></p>
<p>现在，我们不再让第二只乌龟去当前胡萝卜的位置，而是让第二只乌龟去5秒前第一只胡萝卜的位置。在``turtle_tf2_listener.py``文件中编辑``lookup_transform()``的调用为： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5952">[5952]</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">when</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_clock</span><span class="p">()</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">rclpy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span><span class="o">.</span><span class="n">lookup_transform</span><span class="p">(</span>
    <span class="n">to_frame_rel</span><span class="p">,</span>
    <span class="n">from_frame_rel</span><span class="p">,</span>
    <span class="n">when</span><span class="p">,</span>
    <span class="n">timeout</span><span class="o">=</span><span class="n">rclpy</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mf">0.05</span><span class="p">))</span>
</pre></div>
</div>
<p>如果现在运行这段代码，在前5秒钟内，第二只乌龟将不知道该去哪里，因为我们还没有5秒钟的胡萝卜位置历史记录。但是在这5秒钟之后会发生什么呢？让我们试一试： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5931">[5931]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 launch learning_tf2_py turtle_tf2_fixed_frame_demo.launch.py</span>
</pre></div>
</div>
<img alt="../../../_images/turtlesim_delay1.png" src="../../../_images/turtlesim_delay1.png" />
<p>现在你应该注意到，你的乌龟在像这个截图中一样无法控制地四处移动。让我们试着理解背后的原因。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5932">[5932]</a></p>
<ol class="arabic simple">
<li><p>在我们的代码中，我们向tf2提出了以下问题：“相对于5秒前的``turtle2``，<a href="#id1"><span class="problematic" id="id2">``</span></a>carrot1``的姿势是什么？” 这意味着我们控制第二只乌龟的位置是基于它5秒钟前的位置以及第一个胡萝卜5秒钟前的位置。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5933">[5933]</a></p></li>
<li><p>然而，我们真正想要问的是：“相对于当前``turtle2``的位置，<a href="#id1"><span class="problematic" id="id2">``</span></a>carrot1``在5秒钟前的姿势是什么？” <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5934">[5934]</a></p></li>
</ol>
</div>
<div class="section" id="advanced-api-for-lookup-transform">
<h2>lookup_transform()的高级API <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5953">[5953]</a><a class="headerlink" href="#advanced-api-for-lookup-transform" title="永久链接至标题"></a></h2>
<p>要向tf2提出特定的问题，我们将使用一个高级API，该API赋予我们显式指定何时获取指定的转换的能力。通过调用带有额外参数的``lookup_transform_full()``方法来实现。您的代码现在将如下所示： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5954">[5954]</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">when</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_clock</span><span class="p">()</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">rclpy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
<span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span><span class="o">.</span><span class="n">lookup_transform_full</span><span class="p">(</span>
        <span class="n">target_frame</span><span class="o">=</span><span class="n">to_frame_rel</span><span class="p">,</span>
        <span class="n">target_time</span><span class="o">=</span><span class="n">rclpy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">(),</span>
        <span class="n">source_frame</span><span class="o">=</span><span class="n">from_frame_rel</span><span class="p">,</span>
        <span class="n">source_time</span><span class="o">=</span><span class="n">when</span><span class="p">,</span>
        <span class="n">fixed_frame</span><span class="o">=</span><span class="s1">&#39;world&#39;</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="n">rclpy</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mf">0.05</span><span class="p">))</span>
</pre></div>
</div>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a>lookup_transform_full()``的高级API接受六个参数： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5955">[5955]</a></p>
<ol class="arabic simple">
<li><p>目标帧 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5938">[5938]</a></p></li>
<li><p>要进行转换的时间 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5939">[5939]</a></p></li>
<li><p>源帧 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5940">[5940]</a></p></li>
<li><p>评估源帧的时间 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5941">[5941]</a></p></li>
<li><p>在这种情况下，<a href="#id1"><span class="problematic" id="id2">``</span></a>world``帧是随时间不变的帧 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5942">[5942]</a></p></li>
<li><p>等待目标帧可用的时间 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5943">[5943]</a></p></li>
</ol>
<p>总结一下，在后台，tf2会进行以下操作：它会计算从``carrot1``到``world``的变换。在``world``帧中，tf2会在过去到现在的时间上进行移动。而在当前时间，tf2会计算从``world``到``turtle2``的变换。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5944">[5944]</a></p>
</div>
<div class="section" id="checking-the-results">
<h2>检查结果 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5945">[5945]</a><a class="headerlink" href="#checking-the-results" title="永久链接至标题"></a></h2>
<p>让我们再次运行模拟，这次使用高级的时间旅行API： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5946">[5946]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 launch learning_tf2_py turtle_tf2_fixed_frame_demo.launch.py</span>
</pre></div>
</div>
<img alt="../../../_images/turtlesim_delay2.png" src="../../../_images/turtlesim_delay2.png" />
<p>是的，第二只乌龟被定向到了第一根胡萝卜5秒前的位置！ <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5947">[5947]</a></p>
</div>
<div class="section" id="summary">
<h2>总结 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3353">[3353]</a><a class="headerlink" href="#summary" title="永久链接至标题"></a></h2>
<p>在本教程中，您已经看到了tf2的一项高级功能。您了解到tf2可以对数据进行时间转换，并学习了如何在turtlesim示例中进行转换。通过使用高级的``lookup_transform_full()``API，tf2允许您在时间上进行回溯，并在乌龟的旧姿势和当前姿势之间进行帧转换。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5956">[5956]</a></p>
</div>
</div>

  <div id="footer">
    <p>欢迎帮助改进！</p>
  </div>
</body>
</html>