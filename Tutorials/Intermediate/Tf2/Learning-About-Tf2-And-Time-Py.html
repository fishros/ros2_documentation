<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tutorials/Intermediate/Tf2/Learning-About-Tf2-And-Time-Py</title>
</head>
<body>
  <div class="section" id="using-time-python">
<span id="learningabouttf2andtimepy"></span><h1>使用时间（Python） <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5860">[5860]</a><a class="headerlink" href="#using-time-python" title="永久链接至标题"></a></h1>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a>目标：<a href="#id3"><span class="problematic" id="id4">**</span></a>学习如何在``lookup_transform``函数中使用``timeout``参数来等待变换在tf2树上可用。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5861">[5861]</a></p>
<p><strong>教程级别：</strong> 中级 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5286">[5286]</a></p>
<p><strong>时间:</strong> 10分钟 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3663">[3663]</a></p>
<div class="contents local topic" id="contents">
<p class="topic-title">内容 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3277">[3277]</a></p>
<ul class="simple">
<li><p><a class="reference internal" href="#background" id="id1">背景 [3072]</a></p></li>
<li><p><a class="reference internal" href="#tasks" id="id2">任务 [3282]</a></p>
<ul>
<li><p><a class="reference internal" href="#update-the-listener-node" id="id3">1. 更新监听器节点 [5863]</a></p></li>
<li><p><a class="reference internal" href="#fix-the-listener-node" id="id4">2 修复监听节点 [5868]</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#summary" id="id5">总结 [3353]</a></p></li>
</ul>
</div>
<div class="section" id="background">
<h2>背景 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3072">[3072]</a><a class="headerlink" href="#background" title="永久链接至标题"></a></h2>
<p>在之前的教程中，我们通过编写 <span class="xref std std-doc">tf2广播器</span>。现在我们将更深入了解``timeout``参数，它使``lookup_transform``在指定的持续时间内等待指定的变换，然后才抛出异常。这个工具对于监听以不同速率发布的变换或具有不可靠网络和非常大延迟的传入源非常有用。本教程将教您如何使用``lookup_transform``函数中的timeout来等待tf2树上的变换可用。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5862">[5862]</a></p>
</div>
<div class="section" id="tasks">
<h2>任务 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3282">[3282]</a><a class="headerlink" href="#tasks" title="永久链接至标题"></a></h2>
<div class="section" id="update-the-listener-node">
<h3>1. 更新监听器节点 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5863">[5863]</a><a class="headerlink" href="#update-the-listener-node" title="永久链接至标题"></a></h3>
<p>编辑 <code class="docutils literal notranslate"><span class="pre">turtle_tf2_listener.py</span></code> 并删除传递给第 76 行的 <code class="docutils literal notranslate"><span class="pre">lookup_transform()</span></code> 调用的 <code class="docutils literal notranslate"><span class="pre">timeout=Duration(seconds=1.0)</span></code> 参数。修改后的代码应如下所示： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5864">[5864]</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tf_buffer</span><span class="o">.</span><span class="n">lookup_transform</span><span class="p">(</span>
   <span class="n">to_frame_rel</span><span class="p">,</span>
   <span class="n">from_frame_rel</span><span class="p">,</span>
   <span class="n">now</span><span class="p">)</span>
</pre></div>
</div>
<p>此外，在文件开头导入额外的异常，我们将在文件开头处理它们： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5865">[5865]</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tf2_ros</span> <span class="kn">import</span> <span class="n">LookupException</span><span class="p">,</span> <span class="n">ConnectivityException</span><span class="p">,</span> <span class="n">ExtrapolationException</span>
</pre></div>
</div>
<p>通过添加新导入的异常和 <code class="docutils literal notranslate"><span class="pre">raise</span></code> 语句，编辑第 81 行的异常处理以查看异常信息： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5866">[5866]</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">except</span> <span class="p">(</span><span class="n">LookupException</span><span class="p">,</span> <span class="n">ConnectivityException</span><span class="p">,</span> <span class="n">ExtrapolationException</span><span class="p">):</span>
   <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;transform not ready&#39;</span><span class="p">)</span>
   <span class="k">raise</span>
   <span class="k">return</span>
</pre></div>
</div>
<p>如果你现在尝试运行启动文件，你会注意到它执行失败： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5867">[5867]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 launch learning_tf2_py turtle_tf2_demo.launch.py</span>
</pre></div>
</div>
</div>
<div class="section" id="fix-the-listener-node">
<h3>2 修复监听节点 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5868">[5868]</a><a class="headerlink" href="#fix-the-listener-node" title="永久链接至标题"></a></h3>
<p>现在你应该注意到 <code class="docutils literal notranslate"><span class="pre">lookup_transform()</span></code> 执行失败。它告诉你帧不存在或数据在未来。为了修复这个问题，在第 76 行的代码中做如下修改（返回 <code class="docutils literal notranslate"><span class="pre">timeout</span></code> 参数）： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5869">[5869]</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tf_buffer</span><span class="o">.</span><span class="n">lookup_transform</span><span class="p">(</span>
   <span class="n">to_frame_rel</span><span class="p">,</span>
   <span class="n">from_frame_rel</span><span class="p">,</span>
   <span class="n">now</span><span class="p">,</span>
   <span class="n">timeout</span><span class="o">=</span><span class="n">rclpy</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">lookup_transform</span></code> 可以接受四个参数，其中最后一个是可选的超时时间。它将阻塞等待，最多等待指定的时长后超时。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5870">[5870]</a></p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>在进行这个更改后，从上面添加的 <code class="docutils literal notranslate"><span class="pre">except()</span></code> 块中移除 <code class="docutils literal notranslate"><span class="pre">raise</span></code> 行，否则代码将继续失败。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5871">[5871]</a></p>
</div>
<p>现在您可以运行启动文件。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5857">[5857]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 launch learning_tf2_py turtle_tf2_demo.launch.py</span>
</pre></div>
</div>
<p>你应该注意到，<code class="docutils literal notranslate"><span class="pre">lookup_transform()</span></code> 实际上会阻塞，直到两个 turtle 之间的变换可用（通常需要几毫秒）。一旦达到超时时间（在本例中为一秒），只有当变换仍然不可用时才会引发异常。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5872">[5872]</a></p>
</div>
</div>
<div class="section" id="summary">
<h2>总结 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3353">[3353]</a><a class="headerlink" href="#summary" title="永久链接至标题"></a></h2>
<p>在本教程中，你学习了关于 <code class="docutils literal notranslate"><span class="pre">lookup_transform</span></code> 函数及其超时特性的更多内容。你还学会了如何捕获和处理 tf2 可能抛出的其他异常。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5873">[5873]</a></p>
</div>
</div>

  <div id="footer">
    <p>欢迎帮助改进！</p>
  </div>
</body>
</html>