<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tutorials/Intermediate/Monitoring-For-Parameter-Changes-CPP</title>
</head>
<body>
  <div class="section" id="monitoring-for-parameter-changes-c">
<h1>监视参数变化（C++） <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5593">[5593]</a><a class="headerlink" href="#monitoring-for-parameter-changes-c" title="永久链接至标题"></a></h1>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a>目标：<a href="#id3"><span class="problematic" id="id4">**</span></a>学习使用ParameterEventHandler类监视并响应参数变化。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5594">[5594]</a></p>
<p><strong>教程级别：</strong> 中级 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5286">[5286]</a></p>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a>时间：<a href="#id3"><span class="problematic" id="id4">**</span></a>20分钟 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3069">[3069]</a></p>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a>最低平台要求：<a href="#id3"><span class="problematic" id="id4">**</span></a>Galactic <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5595">[5595]</a></p>
<div class="contents local topic" id="contents">
<p class="topic-title">内容 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3277">[3277]</a></p>
<ul class="simple">
<li><p><a class="reference internal" href="#background" id="id1">背景 [3072]</a></p></li>
<li><p><a class="reference internal" href="#prerequisites" id="id2">先决条件 [3124]</a></p></li>
<li><p><a class="reference internal" href="#tasks" id="id3">任务 [3282]</a></p>
<ul>
<li><p><a class="reference internal" href="#create-a-package" id="id4">1 创建一个包 [3283]</a></p></li>
<li><p><a class="reference internal" href="#write-the-c-node" id="id5">2 编写 C++ 节点 [3289]</a></p></li>
<li><p><a class="reference internal" href="#build-and-run" id="id6">3. 构建和运行 [3309]</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#summary" id="id7">总结 [3353]</a></p></li>
<li><p><a class="reference internal" href="#related-content" id="id8">相关内容 [3946]</a></p></li>
</ul>
</div>
<div class="section" id="background">
<h2>背景 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3072">[3072]</a><a class="headerlink" href="#background" title="永久链接至标题"></a></h2>
<p>通常节点需要对自己的参数或其他节点的参数变化做出响应。ParameterEventHandler类使得监听参数变化并响应变得容易。本教程将展示如何使用C++版本的ParameterEventHandler类来监视节点自身参数的变化以及其他节点的参数变化。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5596">[5596]</a></p>
</div>
<div class="section" id="prerequisites">
<h2>先决条件 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3124">[3124]</a><a class="headerlink" href="#prerequisites" title="永久链接至标题"></a></h2>
<p>在开始本教程之前，您应该先完成以下教程： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5597">[5597]</a></p>
<ul class="simple">
<li><p><a class="reference internal" href="../Beginner-CLI-Tools/Understanding-ROS2-Parameters/Understanding-ROS2-Parameters.html"><span class="doc">理解参数 [4200]</span></a> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5598">[5598]</a></p></li>
<li><p><a class="reference internal" href="../Beginner-Client-Libraries/Using-Parameters-In-A-Class-CPP.html"><span class="doc">在类中使用参数（C++） [4771]</span></a> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5599">[5599]</a></p></li>
</ul>
<p>另外，您必须使用 ROS 2 的 Galactic 版本。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5600">[5600]</a></p>
</div>
<div class="section" id="tasks">
<h2>任务 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3282">[3282]</a><a class="headerlink" href="#tasks" title="永久链接至标题"></a></h2>
<p>在本教程中，您将创建一个新的包以包含一些示例代码，编写一些 C++ 代码来使用 ParameterEventHandler 类，并测试生成的代码。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5601">[5601]</a></p>
<div class="section" id="create-a-package">
<h3>1 创建一个包 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3283">[3283]</a><a class="headerlink" href="#create-a-package" title="永久链接至标题"></a></h3>
<p>首先，打开一个新的终端并 <a class="reference internal" href="../Beginner-CLI-Tools/Configuring-ROS2-Environment.html"><span class="doc">source your ROS 2 installation</span></a> 以便 <code class="docutils literal notranslate"><span class="pre">ros2</span></code> 命令能够正常工作。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5602">[5602]</a></p>
<p>按照:ref:<a class="reference internal" href="../Beginner-Client-Libraries/Creating-A-Workspace/Creating-A-Workspace.html#new-directory"><span class="std std-ref">这些指示</span></a> 创建名为``ros2_ws``的新工作空间。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3358">[3358]</a></p>
<p>请记住，包应该创建在 <code class="docutils literal notranslate"><span class="pre">src</span></code> 目录中，而不是工作空间的根目录。因此，进入 <code class="docutils literal notranslate"><span class="pre">ros2_ws/src</span></code>，然后在那里创建一个新的包： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5603">[5603]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 pkg create --build-type ament_cmake cpp_parameter_event_handler --dependencies rclcpp</span>
</pre></div>
</div>
<p>您的终端将返回一个消息，验证您的包 <code class="docutils literal notranslate"><span class="pre">cpp_parameter_event_handler</span></code> 及其所有必要的文件和文件夹的创建。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5604">[5604]</a></p>
<p>“--dependencies”参数将自动添加必要的依赖项行到“package.xml”和“CMakeLists.txt”中。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4778">[4778]</a></p>
<div class="section" id="update-package-xml">
<h4>1.1 更新 <code class="docutils literal notranslate"><span class="pre">package.xml</span></code> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3287">[3287]</a><a class="headerlink" href="#update-package-xml" title="永久链接至标题"></a></h4>
<p>因为您在创建软件包时使用了``--dependencies``选项，所以您不需要手动将依赖项添加到``package.xml``或``CMakeLists.txt``中。不过，您仍需确保将描述、维护者电子邮件和姓名以及许可信息添加到``package.xml``中。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5605">[5605]</a></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;description&gt;</span>C++ parameter events client tutorial<span class="nt">&lt;/description&gt;</span>
<span class="nt">&lt;maintainer</span> <span class="na">email=</span><span class="s">&quot;you@email.com&quot;</span><span class="nt">&gt;</span>Your Name<span class="nt">&lt;/maintainer&gt;</span>
<span class="nt">&lt;license&gt;</span>Apache License 2.0<span class="nt">&lt;/license&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="write-the-c-node">
<h3>2 编写 C++ 节点 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3289">[3289]</a><a class="headerlink" href="#write-the-c-node" title="永久链接至标题"></a></h3>
<p>在``ros2_ws/src/cpp_parameter_event_handler/src``目录中创建一个名为``parameter_event_handler.cpp``的新文件，并将以下代码粘贴其中： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5606">[5606]</a></p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rclcpp/rclcpp.hpp&quot;</span><span class="cp"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">SampleNodeWithParameters</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="n">SampleNodeWithParameters</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="s">&quot;node_with_parameters&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s">&quot;an_int_param&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Create a parameter subscriber that can be used to monitor parameter changes</span>
<span class="w">    </span><span class="c1">// (for this node&#39;s parameters as well as other nodes&#39; parameters)</span>
<span class="w">    </span><span class="n">param_subscriber_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">ParameterEventHandler</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Set a callback for this node&#39;s integer parameter, &quot;an_int_param&quot;</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">cb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="k">this</span><span class="p">](</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Parameter</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;cb: Received an update to parameter </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> of type %s: </span><span class="se">\&quot;</span><span class="s">%ld</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">p</span><span class="p">.</span><span class="n">get_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">p</span><span class="p">.</span><span class="n">get_type_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span><span class="w"></span>
<span class="w">          </span><span class="n">p</span><span class="p">.</span><span class="n">as_int</span><span class="p">());</span><span class="w"></span>
<span class="w">      </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">cb_handle_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param_subscriber_</span><span class="o">-&gt;</span><span class="n">add_parameter_callback</span><span class="p">(</span><span class="s">&quot;an_int_param&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cb</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">ParameterEventHandler</span><span class="o">&gt;</span><span class="w"> </span><span class="n">param_subscriber_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">ParameterCallbackHandle</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cb_handle_</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">SampleNodeWithParameters</span><span class="o">&gt;</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="section" id="examine-the-code">
<h4>2.1 检查代码 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3291">[3291]</a><a class="headerlink" href="#examine-the-code" title="永久链接至标题"></a></h4>
<p>第一条语句``#include &lt;memory&gt;``是为了让代码可以利用std::make_shared模板。接下来的``#include &quot;rclcpp/rclcpp.hpp&quot;<a href="#id1"><span class="problematic" id="id2">``</span></a>是为了让代码可以引用rclcpp接口提供的各种功能，包括ParameterEventHandler类。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5607">[5607]</a></p>
<p>在类声明之后，代码定义了一个名为``SampleNodeWithParameters``的类。该类的构造函数声明了一个整型参数``an_int_param``，默认值为0。接下来，代码创建了一个将用于监视参数变化的``ParameterEventHandler``。最后，代码创建了一个lambda函数，并将其设置为在``an_int_param``更新时调用的回调函数。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5608">[5608]</a></p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>非常重要的一点是要保存``add_parameter_callback``返回的句柄；否则，回调函数将无法正确注册。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5609">[5609]</a></p>
</div>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">SampleNodeWithParameters</span><span class="p">()</span><span class="w"></span>
<span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="s">&quot;node_with_parameters&quot;</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s">&quot;an_int_param&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Create a parameter subscriber that can be used to monitor parameter changes</span>
<span class="w">  </span><span class="c1">// (for this node&#39;s parameters as well as other nodes&#39; parameters)</span>
<span class="w">  </span><span class="n">param_subscriber_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">ParameterEventHandler</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="c1">// Set a callback for this node&#39;s integer parameter, &quot;an_int_param&quot;</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">cb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="k">this</span><span class="p">](</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Parameter</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;cb: Received an update to parameter </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> of type %s: </span><span class="se">\&quot;</span><span class="s">%ld</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">p</span><span class="p">.</span><span class="n">get_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">p</span><span class="p">.</span><span class="n">get_type_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">p</span><span class="p">.</span><span class="n">as_int</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="n">cb_handle_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param_subscriber_</span><span class="o">-&gt;</span><span class="n">add_parameter_callback</span><span class="p">(</span><span class="s">&quot;an_int_param&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cb</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>在``SampleNodeWithParameters``之后是一个典型的``main``函数，它初始化ROS，使示例节点能够发送和接收消息，然后在用户在控制台输入^C后关闭。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5610">[5610]</a></p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">SampleNodeWithParameters</span><span class="o">&gt;</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="add-executable">
<h4>2.2 添加可执行文件 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3305">[3305]</a><a class="headerlink" href="#add-executable" title="永久链接至标题"></a></h4>
<p>要构建此代码，首先打开``CMakeLists.txt``文件，并在依赖项``find_package(rclcpp REQUIRED)``下添加以下代码行 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5611">[5611]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">add_executable(parameter_event_handler src/parameter_event_handler.cpp)</span>
<span class="go">ament_target_dependencies(parameter_event_handler rclcpp)</span>

<span class="go">install(TARGETS</span>
<span class="go">  parameter_event_handler</span>
<span class="go">  DESTINATION lib/${PROJECT_NAME}</span>
<span class="go">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="build-and-run">
<h3>3. 构建和运行 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3309">[3309]</a><a class="headerlink" href="#build-and-run" title="永久链接至标题"></a></h3>
<p>在构建之前，最好在工作空间的根目录（<code class="docutils literal notranslate"><span class="pre">ros2_ws</span></code>）中运行``rosdep``来检查是否缺少依赖项： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4791">[4791]</a></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-TGludXg=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-TGludXg=" name="TGludXg=" role="tab" tabindex="0">Linux</button><button aria-controls="panel-0-bWFjT1M=" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-bWFjT1M=" name="bWFjT1M=" role="tab" tabindex="-1">macOS</button><button aria-controls="panel-0-V2luZG93cw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-V2luZG93cw==" name="V2luZG93cw==" role="tab" tabindex="-1">Windows</button></div><div aria-labelledby="tab-0-TGludXg=" class="sphinx-tabs-panel group-tab" id="panel-0-TGludXg=" name="TGludXg=" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">rosdep install -i --from-path src --rosdistro $ROS_DISTRO -y</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-bWFjT1M=" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-bWFjT1M=" name="bWFjT1M=" role="tabpanel" tabindex="0"><p>rosdep 只能在 Linux 上运行，所以您可以跳过下一步。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4792">[4792]</a></p>
</div><div aria-labelledby="tab-0-V2luZG93cw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-V2luZG93cw==" name="V2luZG93cw==" role="tabpanel" tabindex="0"><p>rosdep 只能在 Linux 上运行，所以您可以跳过下一步。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4792">[4792]</a></p>
</div></div>
<p>返回到您的工作空间的根目录 <code class="docutils literal notranslate"><span class="pre">ros2_ws</span></code>，并构建您的新包： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4793">[4793]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">colcon build --packages-select cpp_parameter_event_handler</span>
</pre></div>
</div>
<p>打开一个新的终端，导航到 <code class="docutils literal notranslate"><span class="pre">ros2_ws</span></code>，并加载设置文件： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4794">[4794]</a></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-TGludXg=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-1-TGludXg=" name="TGludXg=" role="tab" tabindex="0">Linux</button><button aria-controls="panel-1-bWFjT1M=" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-1-bWFjT1M=" name="bWFjT1M=" role="tab" tabindex="-1">macOS</button><button aria-controls="panel-1-V2luZG93cw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-1-V2luZG93cw==" name="V2luZG93cw==" role="tab" tabindex="-1">Windows</button></div><div aria-labelledby="tab-1-TGludXg=" class="sphinx-tabs-panel group-tab" id="panel-1-TGludXg=" name="TGludXg=" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">. install/setup.bash</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-bWFjT1M=" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-1-bWFjT1M=" name="bWFjT1M=" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">. install/setup.bash</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-V2luZG93cw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-1-V2luZG93cw==" name="V2luZG93cw==" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">call install/setup.bat</span>
</pre></div>
</div>
</div></div>
<p>现在运行节点： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3312">[3312]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 run cpp_parameter_event_handler parameter_event_handler</span>
</pre></div>
</div>
<p>该节点现已激活并具有一个参数，每当更新该参数时，它将打印一条消息。要进行测试，打开另一个终端并像以前一样设置ROS环境（<code class="docutils literal notranslate"><span class="pre">.</span> <span class="pre">install/setup.bash</span></code>），然后执行以下命令： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5612">[5612]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 param set node_with_parameters an_int_param 43</span>
</pre></div>
</div>
<p>运行节点的终端将显示类似以下内容的消息： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5613">[5613]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">[INFO] [1606950498.422461764] [node_with_parameters]: cb: Received an update to parameter &quot;an_int_param&quot; of type integer: &quot;43&quot;</span>
</pre></div>
</div>
<p>我们之前在节点中设置的回调函数已被调用，并显示了新的更新值。现在，您可以使用终端中的``^C``终止运行的``parameter_event_handler``示例。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5614">[5614]</a></p>
<div class="section" id="monitor-changes-to-another-node-s-parameters">
<h4>3.1 监视另一个节点的参数变化 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5615">[5615]</a><a class="headerlink" href="#monitor-changes-to-another-node-s-parameters" title="永久链接至标题"></a></h4>
<p>您还可以使用``ParameterEventHandler``来监视另一个节点的参数变化。让我们更新``SampleNodeWithParameters``类，以便还监视另一个节点的参数更改。我们将使用``parameter_blackboard``演示应用程序来托管一个双精度参数，并监视其更新。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5616">[5616]</a></p>
<p>首先在构造函数中添加以下代码，放在现有代码之后:  <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5617">[5617]</a></p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Now, add a callback to monitor any changes to the remote node&#39;s parameter. In this</span>
<span class="c1">// case, we supply the remote node name.</span>
<span class="k">auto</span><span class="w"> </span><span class="n">cb2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="k">this</span><span class="p">](</span><span class="k">const</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Parameter</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;cb2: Received an update to parameter </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> of type: %s: </span><span class="se">\&quot;</span><span class="s">%.02lf</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">p</span><span class="p">.</span><span class="n">get_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">p</span><span class="p">.</span><span class="n">get_type_name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">p</span><span class="p">.</span><span class="n">as_double</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">};</span><span class="w"></span>
<span class="k">auto</span><span class="w"> </span><span class="n">remote_node_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;parameter_blackboard&quot;</span><span class="p">);</span><span class="w"></span>
<span class="k">auto</span><span class="w"> </span><span class="n">remote_param_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;a_double_param&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">cb_handle2_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param_subscriber_</span><span class="o">-&gt;</span><span class="n">add_parameter_callback</span><span class="p">(</span><span class="n">remote_param_name</span><span class="p">,</span><span class="w"> </span><span class="n">cb2</span><span class="p">,</span><span class="w"> </span><span class="n">remote_node_name</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>然后添加另一个成员变量，<code class="docutils literal notranslate"><span class="pre">cb_handle2</span></code>，用于额外的回调句柄:  <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5618">[5618]</a></p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">ParameterEventHandler</span><span class="o">&gt;</span><span class="w"> </span><span class="n">param_subscriber_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">ParameterCallbackHandle</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cb_handle_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">ParameterCallbackHandle</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cb_handle2_</span><span class="p">;</span><span class="w">  </span><span class="c1">// Add this</span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>在终端中，返回到工作空间根目录``ros2_ws``，并像以前一样构建更新的软件包:  <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5619">[5619]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">colcon build --packages-select cpp_parameter_event_handler</span>
</pre></div>
</div>
<p>然后加载设置文件:  <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5620">[5620]</a></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-TGludXg=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-2-TGludXg=" name="TGludXg=" role="tab" tabindex="0">Linux</button><button aria-controls="panel-2-bWFjT1M=" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-2-bWFjT1M=" name="bWFjT1M=" role="tab" tabindex="-1">macOS</button><button aria-controls="panel-2-V2luZG93cw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-2-V2luZG93cw==" name="V2luZG93cw==" role="tab" tabindex="-1">Windows</button></div><div aria-labelledby="tab-2-TGludXg=" class="sphinx-tabs-panel group-tab" id="panel-2-TGludXg=" name="TGludXg=" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">. install/setup.bash</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-bWFjT1M=" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-2-bWFjT1M=" name="bWFjT1M=" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">. install/setup.bash</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-V2luZG93cw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-2-V2luZG93cw==" name="V2luZG93cw==" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">call install/setup.bat</span>
</pre></div>
</div>
</div></div>
<p>现在，为了测试远程参数的监视功能，首先运行新构建的 parameter_event_handler 代码:  <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5621">[5621]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 run cpp_parameter_event_handler parameter_event_handler</span>
</pre></div>
</div>
<p>接下来，在另一个已初始化 ROS 的终端中，运行 parameter_blackboard 演示应用程序，如下所示:  <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5622">[5622]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 run demo_nodes_cpp parameter_blackboard</span>
</pre></div>
</div>
<p>最后，在第三个终端（已初始化ROS），让我们在parameter_blackboard节点上设置一个参数： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5623">[5623]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 param set parameter_blackboard a_double_param 3.45</span>
</pre></div>
</div>
<p>执行此命令后，你应该在parameter_event_handler窗口中看到输出，表示在参数更新时调用了回调函数： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5624">[5624]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">[INFO] [1606952588.237531933] [node_with_parameters]: cb2: Received an update to parameter &quot;a_double_param&quot; of type: double: &quot;3.45&quot;</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="summary">
<h2>总结 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3353">[3353]</a><a class="headerlink" href="#summary" title="永久链接至标题"></a></h2>
<p>你创建了一个带有参数的节点，并使用ParameterEventHandler类设置了一个回调函数来监控该参数的变化。你还使用相同的类监控了远程节点的变化。ParameterEventHandler是一种方便的方法，用于监控参数的变化，以便你可以对更新的值做出响应。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5625">[5625]</a></p>
</div>
<div class="section" id="related-content">
<h2>相关内容 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3946">[3946]</a><a class="headerlink" href="#related-content" title="永久链接至标题"></a></h2>
<p>要了解如何将ROS 1参数文件适应ROS 2，请参阅：<a class="reference internal" href="../../How-To-Guides/Parameters-YAML-files-migration-guide.html"><span class="doc">从ROS 1迁移YAML参数文件到ROS 2的教程</span></a>。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5626">[5626]</a></p>
</div>
</div>

  <div id="footer">
    <p>欢迎帮助改进！</p>
  </div>
</body>
</html>