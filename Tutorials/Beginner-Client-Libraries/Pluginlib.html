<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tutorials/Beginner-Client-Libraries/Pluginlib</title>
</head>
<body>
  <div class="section" id="creating-and-using-plugins-c">
<h1>创建和使用插件（C++） <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4655">[4655]</a><a class="headerlink" href="#creating-and-using-plugins-c" title="永久链接至标题"></a></h1>
<p><strong>目标:</strong> 学习使用pluginlib创建和加载简单插件。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4656">[4656]</a></p>
<p><strong>教程级别:</strong> 初学者 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3951">[3951]</a></p>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a>时间：<a href="#id3"><span class="problematic" id="id4">**</span></a>20分钟 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3069">[3069]</a></p>
<div class="contents local topic" id="contents">
<p class="topic-title">内容 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3277">[3277]</a></p>
<ul class="simple">
<li><p><a class="reference internal" href="#background" id="id1">背景 [3072]</a></p></li>
<li><p><a class="reference internal" href="#prerequisites" id="id2">先决条件 [3124]</a></p></li>
<li><p><a class="reference internal" href="#tasks" id="id3">任务 [3282]</a></p>
<ul>
<li><p><a class="reference internal" href="#create-the-base-class-package" id="id4">1 创建基类软件包 [4661]</a></p></li>
<li><p><a class="reference internal" href="#create-the-plugin-package" id="id5">2 创建插件包 [4668]</a></p>
<ul>
<li><p><a class="reference internal" href="#source-code-for-the-plugins" id="id6">2.1 插件的源代码 [4670]</a></p></li>
<li><p><a class="reference internal" href="#plugin-declaration-xml" id="id7">2.2 插件声明 XML [4675]</a></p></li>
<li><p><a class="reference internal" href="#cmake-plugin-declaration" id="id8">2.3 CMake插件声明 [4685]</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#use-the-plugins" id="id9">3 使用插件 [4690]</a></p></li>
<li><p><a class="reference internal" href="#build-and-run" id="id10">4 构建和运行 [4698]</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#summary" id="id11">总结 [3353]</a></p></li>
</ul>
</div>
<div class="section" id="background">
<h2>背景 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3072">[3072]</a><a class="headerlink" href="#background" title="永久链接至标题"></a></h2>
<p>本教程源自 <a class="reference external" href="http://wiki.ros.org/pluginlib">http://wiki.ros.org/pluginlib</a> 和 <a class="reference external" href="http://wiki.ros.org/pluginlib/Tutorials/Writing%20and%20Using%20a%20Simple%20Plugin">编写和使用简单插件教程</a>。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4657">[4657]</a></p>
<p>pluginlib是一个用于在ROS软件包中加载和卸载插件的C++库。插件是动态可加载的类，从运行时库（即共享对象、动态链接库）中加载。使用pluginlib，无需显式地将应用程序与包含类的库进行链接，而是可以在任何时候打开包含导出类的库，而应用程序对库或包含类定义的头文件没有任何先前的了解。插件对于扩展/修改应用程序行为而无需应用程序源代码非常有用。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4658">[4658]</a></p>
</div>
<div class="section" id="prerequisites">
<h2>先决条件 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3124">[3124]</a><a class="headerlink" href="#prerequisites" title="永久链接至标题"></a></h2>
<p>本教程假设你具有基本的C++知识，并且已经安装了``pluginlib``。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4659">[4659]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">sudo apt-get install ros-humble-pluginlib</span>
</pre></div>
</div>
</div>
<div class="section" id="tasks">
<h2>任务 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3282">[3282]</a><a class="headerlink" href="#tasks" title="永久链接至标题"></a></h2>
<p>在本教程中，您将创建两个新的软件包，一个定义基类，另一个提供插件。基类将定义一个通用的多边形类，然后我们的插件将定义特定的形状。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4660">[4660]</a></p>
<div class="section" id="create-the-base-class-package">
<h3>1 创建基类软件包 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4661">[4661]</a><a class="headerlink" href="#create-the-base-class-package" title="永久链接至标题"></a></h3>
<p>在``ros2_ws/src``文件夹中使用以下命令创建一个新的空软件包： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4662">[4662]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 pkg create --build-type ament_cmake polygon_base --dependencies pluginlib --node-name area_node</span>
</pre></div>
</div>
<p>打开您喜欢的编辑器，编辑``ros2_ws/src/polygon_base/include/polygon_base/regular_polygon.hpp``文件，并将以下内容粘贴到其中： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4663">[4663]</a></p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef POLYGON_BASE_REGULAR_POLYGON_HPP</span>
<span class="cp">#define POLYGON_BASE_REGULAR_POLYGON_HPP</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">polygon_base</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">RegularPolygon</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">initialize</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">side_length</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">virtual</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">area</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">RegularPolygon</span><span class="p">(){}</span><span class="w"></span>

<span class="w">    </span><span class="k">protected</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="n">RegularPolygon</span><span class="p">(){}</span><span class="w"></span>
<span class="w">  </span><span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace polygon_base</span>

<span class="cp">#endif  </span><span class="c1">// POLYGON_BASE_REGULAR_POLYGON_HPP</span>
</pre></div>
</div>
<p>上面的代码应该很容易理解...我们正在创建一个名为``RegularPolygon``的抽象类。需要注意的一件事是存在初始化方法。在``pluginlib``中，需要一个没有参数的构造函数，所以如果需要类的任何参数，我们使用初始化方法将它们传递给对象。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4664">[4664]</a></p>
<p>我们需要使这个头文件对其他类可用，所以打开``ros2_ws/src/polygon_base/CMakeLists.txt``进行编辑。在``ament_target_dependencies``命令之后添加以下行： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4665">[4665]</a></p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">install</span><span class="p">(</span>
<span class="w">  </span><span class="s">DIRECTORY</span><span class="w"> </span><span class="s">include/</span>
<span class="w">  </span><span class="s">DESTINATION</span><span class="w"> </span><span class="s">include</span>
<span class="p">)</span>
</pre></div>
</div>
<p>在``ament_package``命令之前添加此命令： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4666">[4666]</a></p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">ament_export_include_directories</span><span class="p">(</span>
<span class="w">  </span><span class="s">include</span>
<span class="p">)</span>
</pre></div>
</div>
<p>我们将在稍后返回这个软件包来编写我们的测试节点。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4667">[4667]</a></p>
</div>
<div class="section" id="create-the-plugin-package">
<h3>2 创建插件包 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4668">[4668]</a><a class="headerlink" href="#create-the-plugin-package" title="永久链接至标题"></a></h3>
<p>现在我们要编写两个非虚拟实现我们的抽象类。在 <code class="docutils literal notranslate"><span class="pre">ros2_ws/src</span></code> 文件夹中创建第二个空包，使用以下命令： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4669">[4669]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 pkg create --build-type ament_cmake polygon_plugins --dependencies polygon_base pluginlib --library-name polygon_plugins</span>
</pre></div>
</div>
<div class="section" id="source-code-for-the-plugins">
<h4>2.1 插件的源代码 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4670">[4670]</a><a class="headerlink" href="#source-code-for-the-plugins" title="永久链接至标题"></a></h4>
<p>打开 <code class="docutils literal notranslate"><span class="pre">ros2_ws/src/polygon_plugins/src/polygon_plugins.cpp</span></code> 进行编辑，并将以下内容粘贴到其中： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4671">[4671]</a></p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;polygon_base/regular_polygon.hpp&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cmath&gt;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">polygon_plugins</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">Square</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">polygon_base</span><span class="o">::</span><span class="n">RegularPolygon</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="kt">void</span><span class="w"> </span><span class="n">initialize</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">side_length</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">side_length_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">side_length</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">area</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">side_length_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">side_length_</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">protected</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">side_length_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">};</span><span class="w"></span>

<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">Triangle</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">polygon_base</span><span class="o">::</span><span class="n">RegularPolygon</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="kt">void</span><span class="w"> </span><span class="n">initialize</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">side_length</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">side_length_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">side_length</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">area</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">side_length_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">getHeight</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">getHeight</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sqrt</span><span class="p">((</span><span class="n">side_length_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">side_length_</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">((</span><span class="n">side_length_</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">side_length_</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">)));</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">protected</span><span class="o">:</span><span class="w"></span>
<span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">side_length_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pluginlib/class_list_macros.hpp&gt;</span><span class="cp"></span>

<span class="n">PLUGINLIB_EXPORT_CLASS</span><span class="p">(</span><span class="n">polygon_plugins</span><span class="o">::</span><span class="n">Square</span><span class="p">,</span><span class="w"> </span><span class="n">polygon_base</span><span class="o">::</span><span class="n">RegularPolygon</span><span class="p">)</span><span class="w"></span>
<span class="n">PLUGINLIB_EXPORT_CLASS</span><span class="p">(</span><span class="n">polygon_plugins</span><span class="o">::</span><span class="n">Triangle</span><span class="p">,</span><span class="w"> </span><span class="n">polygon_base</span><span class="o">::</span><span class="n">RegularPolygon</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Square和Triangle类的实现应该相对简单：保存边长，并使用它来计算面积。与pluginlib特定相关的部分是最后三行，它们调用了一些神奇的宏来将这些类注册为实际的插件。让我们来看看``PLUGINLIB_EXPORT_CLASS``宏的参数： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4672">[4672]</a></p>
<ol class="arabic simple">
<li><p>插件类的完全限定类型，在这种情况下为``polygon_plugins::Square``。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4673">[4673]</a></p></li>
<li><p>基类的完全限定类型，在这种情况下为``polygon_base::RegularPolygon``。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4674">[4674]</a></p></li>
</ol>
</div>
<div class="section" id="plugin-declaration-xml">
<h4>2.2 插件声明 XML <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4675">[4675]</a><a class="headerlink" href="#plugin-declaration-xml" title="永久链接至标题"></a></h4>
<p>上述步骤使得在加载包含插件的库时可以创建插件的实例，但是插件加载器仍然需要找到该库并知道在库中引用的内容。为此，我们还将创建一个XML文件，该文件与包清单中的特殊导出行一起，将关于插件的所有必要信息提供给ROS工具链。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4676">[4676]</a></p>
<p>在``ros2_ws/src/polygon_plugins/plugins.xml``中创建以下代码： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4677">[4677]</a></p>
<div class="highlight-XML notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;library</span> <span class="na">path=</span><span class="s">&quot;polygon_plugins&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;class</span> <span class="na">type=</span><span class="s">&quot;polygon_plugins::Square&quot;</span> <span class="na">base_class_type=</span><span class="s">&quot;polygon_base::RegularPolygon&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;description&gt;</span>This is a square plugin.<span class="nt">&lt;/description&gt;</span>
  <span class="nt">&lt;/class&gt;</span>
  <span class="nt">&lt;class</span> <span class="na">type=</span><span class="s">&quot;polygon_plugins::Triangle&quot;</span> <span class="na">base_class_type=</span><span class="s">&quot;polygon_base::RegularPolygon&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;description&gt;</span>This is a triangle plugin.<span class="nt">&lt;/description&gt;</span>
  <span class="nt">&lt;/class&gt;</span>
<span class="nt">&lt;/library&gt;</span>
</pre></div>
</div>
<p>需要注意的几点： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4678">[4678]</a></p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">library``标签提供了一个相对路径，指向包含我们要导出的插件的库。在ROS</span> <span class="pre">2中，这只是库的名称。在ROS</span> <span class="pre">1中，它包含前缀``lib``或者有时是``lib/lib``（即``lib/libpolygon_plugins</span></code>），但在这里更简单。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4679">[4679]</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">class</span></code> 标签声明了我们想要从库中导出的插件。让我们来看一下它的参数： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4680">[4680]</a></p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">type</span></code>: 插件的完全限定类型。对于我们来说，那是 <code class="docutils literal notranslate"><span class="pre">polygon_plugins::Square</span></code>。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4681">[4681]</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">base_class</span></code>: 插件的完全限定基类类型。对于我们来说，那是 <code class="docutils literal notranslate"><span class="pre">polygon_base::RegularPolygon</span></code>。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4682">[4682]</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">description</span></code>: 插件的描述以及它的功能。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4683">[4683]</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code>: 以前有一个名字属性，但现在不再需要。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4684">[4684]</a></p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="cmake-plugin-declaration">
<h4>2.3 CMake插件声明 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4685">[4685]</a><a class="headerlink" href="#cmake-plugin-declaration" title="永久链接至标题"></a></h4>
<p>最后一步是通过``CMakeLists.txt``导出你的插件。这是与ROS 1不同的地方，ROS 1是通过``package.xml``来导出插件的。在读取``find_package(pluginlib REQUIRED)``这一行后，在你的``ros2_ws/src/polygon_plugins/CMakeLists.txt``中添加以下代码行： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4686">[4686]</a></p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">pluginlib_export_plugin_description_file</span><span class="p">(</span><span class="s">polygon_base</span><span class="w"> </span><span class="s">plugins.xml</span><span class="p">)</span>
</pre></div>
</div>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a>pluginlib_export_plugin_description_file``命令的参数为： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4687">[4687]</a></p>
<ol class="arabic simple">
<li><p>基类的包，即``polygon_base``。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4688">[4688]</a></p></li>
<li><p>插件声明 xml 的相对路径，即``plugins.xml``。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4689">[4689]</a></p></li>
</ol>
</div>
</div>
<div class="section" id="use-the-plugins">
<h3>3 使用插件 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4690">[4690]</a><a class="headerlink" href="#use-the-plugins" title="永久链接至标题"></a></h3>
<p>现在是时候使用插件了。可以在任何包中完成此操作，但是这里我们将在基础包中进行。编辑``ros2_ws/src/polygon_base/src/area_node.cpp``，使其包含以下内容： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4691">[4691]</a></p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pluginlib/class_loader.hpp&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;polygon_base/regular_polygon.hpp&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// To avoid unused parameter warnings</span>
<span class="w">  </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">argc</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">argv</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">pluginlib</span><span class="o">::</span><span class="n">ClassLoader</span><span class="o">&lt;</span><span class="n">polygon_base</span><span class="o">::</span><span class="n">RegularPolygon</span><span class="o">&gt;</span><span class="w"> </span><span class="n">poly_loader</span><span class="p">(</span><span class="s">&quot;polygon_base&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;polygon_base::RegularPolygon&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">try</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">polygon_base</span><span class="o">::</span><span class="n">RegularPolygon</span><span class="o">&gt;</span><span class="w"> </span><span class="n">triangle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">poly_loader</span><span class="p">.</span><span class="n">createSharedInstance</span><span class="p">(</span><span class="s">&quot;polygon_plugins::Triangle&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">triangle</span><span class="o">-&gt;</span><span class="n">initialize</span><span class="p">(</span><span class="mf">10.0</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">polygon_base</span><span class="o">::</span><span class="n">RegularPolygon</span><span class="o">&gt;</span><span class="w"> </span><span class="n">square</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">poly_loader</span><span class="p">.</span><span class="n">createSharedInstance</span><span class="p">(</span><span class="s">&quot;polygon_plugins::Square&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">square</span><span class="o">-&gt;</span><span class="n">initialize</span><span class="p">(</span><span class="mf">10.0</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Triangle area: %.2f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">triangle</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Square area: %.2f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">square</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">catch</span><span class="p">(</span><span class="n">pluginlib</span><span class="o">::</span><span class="n">PluginlibException</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;The plugin failed to load for some reason. Error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">.</span><span class="n">what</span><span class="p">());</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ClassLoader``是理解的关键类，定义在``class_loader.hpp</span></code> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4692">头文件 &lt;https://github.com/ros/pluginlib/blob/ros2/pluginlib/include/pluginlib/class_loader.hpp&gt;`_中： `[4692]</a></p>
<blockquote>
<div><ul class="simple">
<li><p>它以基类``polygon_base::RegularPolygon``进行模板化。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4693">[4693]</a></p></li>
<li><p>第一个参数是基类的包名字符串，例如``polygon_base``。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4694">[4694]</a></p></li>
<li><p>第二个参数是插件的完全限定基类类型的字符串，例如``polygon_base::RegularPolygon``。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4695">[4695]</a></p></li>
</ul>
</div></blockquote>
<p>有许多实例化类的方法。在这个例子中，我们使用了共享指针。我们只需要使用完全限定的插件类类型调用 <code class="docutils literal notranslate"><span class="pre">createSharedInstance</span></code>，在本例中是 <code class="docutils literal notranslate"><span class="pre">polygon_plugins::Square</span></code>。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4696">[4696]</a></p>
<p>重要提示：定义这个节点的 <code class="docutils literal notranslate"><span class="pre">polygon_base</span></code> 包不依赖于 <code class="docutils literal notranslate"><span class="pre">polygon_plugins</span></code> 类。插件将会在不需要声明任何依赖关系的情况下进行动态加载。此外，我们通过硬编码插件名称来实例化类，但你也可以使用参数等动态方式来实现。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4697">[4697]</a></p>
</div>
<div class="section" id="build-and-run">
<h3>4 构建和运行 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4698">[4698]</a><a class="headerlink" href="#build-and-run" title="永久链接至标题"></a></h3>
<p>返回你的工作空间根目录 <code class="docutils literal notranslate"><span class="pre">ros2_ws</span></code>，并构建你的新包： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4699">[4699]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">colcon build --packages-select polygon_base polygon_plugins</span>
</pre></div>
</div>
<p>从 <code class="docutils literal notranslate"><span class="pre">ros2_ws</span></code> 中，请确保源码了设置文件： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4700">[4700]</a></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-TGludXg=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-TGludXg=" name="TGludXg=" role="tab" tabindex="0">Linux</button><button aria-controls="panel-0-bWFjT1M=" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-bWFjT1M=" name="bWFjT1M=" role="tab" tabindex="-1">macOS</button><button aria-controls="panel-0-V2luZG93cw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-V2luZG93cw==" name="V2luZG93cw==" role="tab" tabindex="-1">Windows</button></div><div aria-labelledby="tab-0-TGludXg=" class="sphinx-tabs-panel group-tab" id="panel-0-TGludXg=" name="TGludXg=" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">source install/setup.bash</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-bWFjT1M=" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-bWFjT1M=" name="bWFjT1M=" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">. install/setup.bash</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-V2luZG93cw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-V2luZG93cw==" name="V2luZG93cw==" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">call install/setup.bat</span>
</pre></div>
</div>
</div></div>
<p>现在运行节点： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3312">[3312]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 run polygon_base area_node</span>
</pre></div>
</div>
<p>应该打印出： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4701">[4701]</a></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Triangle area: 43.30</span>
<span class="go">Square area: 100.00</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="summary">
<h2>总结 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=3353">[3353]</a><a class="headerlink" href="#summary" title="永久链接至标题"></a></h2>
<p>恭喜！您刚刚编写并使用了您的第一个插件。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=4702">[4702]</a></p>
</div>
</div>

  <div id="footer">
    <p>欢迎帮助改进！</p>
  </div>
</body>
</html>