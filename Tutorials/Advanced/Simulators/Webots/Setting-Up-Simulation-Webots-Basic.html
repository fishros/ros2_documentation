<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tutorials/Advanced/Simulators/Webots/Setting-Up-Simulation-Webots-Basic</title>
</head>
<body>
  <div class="section" id="setting-up-a-robot-simulation-basic">
<h1>设置机器人仿真（基础）<a class="headerlink" href="#setting-up-a-robot-simulation-basic" title="永久链接至标题"></a></h1>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a>目标：<a href="#id3"><span class="problematic" id="id4">**</span></a>设置机器人仿真并通过ROS 2进行控制。</p>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a>教程级别：<a href="#id3"><span class="problematic" id="id4">**</span></a>高级</p>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a>时间：<a href="#id3"><span class="problematic" id="id4">**</span></a>30分钟</p>
<div class="contents local topic" id="contents">
<p class="topic-title">内容</p>
<ul class="simple">
<li><p><a class="reference internal" href="#background" id="id3">背景</a></p></li>
<li><p><a class="reference internal" href="#prerequisites" id="id4">先决条件</a></p></li>
<li><p><a class="reference internal" href="#tasks" id="id5">任务</a></p>
<ul>
<li><p><a class="reference internal" href="#create-the-package-structure" id="id6">1 创建软件包结构</a></p></li>
<li><p><a class="reference internal" href="#setup-the-simulation-world" id="id7">2 设置仿真世界</a></p></li>
<li><p><a class="reference internal" href="#edit-the-my-robot-driver-plugin" id="id8">3 编辑``my_robot_driver``插件</a></p></li>
<li><p><a class="reference internal" href="#create-the-my-robot-urdf-file" id="id9">4 创建 <code class="docutils literal notranslate"><span class="pre">my_robot.urdf</span></code> 文件</a></p></li>
<li><p><a class="reference internal" href="#create-the-launch-file" id="id10">5 创建启动文件</a></p></li>
<li><p><a class="reference internal" href="#edit-additional-files" id="id11">6 编辑附加文件</a></p></li>
<li><p><a class="reference internal" href="#test-the-code" id="id12">7 测试代码</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#summary" id="id13">总结</a></p></li>
<li><p><a class="reference internal" href="#next-steps" id="id14">下一步</a></p></li>
</ul>
</div>
<div class="section" id="background">
<h2><a class="toc-backref" href="#id3">背景</a><a class="headerlink" href="#background" title="永久链接至标题"></a></h2>
<p>在本教程中，您将使用Webots机器人仿真器来设置和运行一个非常简单的ROS 2仿真场景。</p>
<p><code class="docutils literal notranslate"><span class="pre">webots_ros2</span></code> 包提供了ROS 2和Webots之间的接口。它包含了几个子包，但在本教程中，您只会使用``webots_ros2_driver``子包来实现一个控制模拟机器人的Python或C++插件。其他一些子包包含了不同机器人的演示，比如TurtleBot3。它们在 <a class="reference external" href="https://github.com/cyberbotics/webots_ros2/wiki/Examples">Webots ROS 2 examples</a> 页面有文档记录。</p>
</div>
<div class="section" id="prerequisites">
<h2><a class="toc-backref" href="#id4">先决条件</a><a class="headerlink" href="#prerequisites" title="永久链接至标题"></a></h2>
<p>建议您先了解在初学者教程 <a class="reference internal" href="../../../../Tutorials.html"><span class="doc">教程</span></a> 中介绍的基本ROS原理。特别是 <a class="reference internal" href="../../../Beginner-CLI-Tools/Introducing-Turtlesim/Introducing-Turtlesim.html"><span class="doc">使用``turtlesim``、ros2``和``rqt</span></a>，<a class="reference internal" href="../../../Beginner-CLI-Tools/Understanding-ROS2-Topics/Understanding-ROS2-Topics.html"><span class="doc">理解话题</span></a>，<a class="reference internal" href="../../../Beginner-Client-Libraries/Creating-A-Workspace/Creating-A-Workspace.html"><span class="doc">创建一个工作空间</span></a>，<a class="reference internal" href="../../../Beginner-Client-Libraries/Creating-Your-First-ROS2-Package.html"><span class="doc">创建软件包</span></a> 和 <a class="reference internal" href="../../../Intermediate/Launch/Creating-Launch-Files.html"><span class="doc">创建一个启动文件</span></a> 是有用的先决条件。</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-TGludXg=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-TGludXg=" name="TGludXg=" role="tab" tabindex="0">Linux</button><button aria-controls="panel-0-V2luZG93cw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-V2luZG93cw==" name="V2luZG93cw==" role="tab" tabindex="-1">Windows</button><button aria-controls="panel-0-bWFjT1M=" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-bWFjT1M=" name="bWFjT1M=" role="tab" tabindex="-1">macOS</button></div><div aria-labelledby="tab-0-TGludXg=" class="sphinx-tabs-panel group-tab" id="panel-0-TGludXg=" name="TGludXg=" role="tabpanel" tabindex="0"><p>本教程中的Linux和ROS命令可以在标准的Linux终端中运行。下一页 <a class="reference internal" href="Installation-Ubuntu.html"><span class="doc">安装（Ubuntu）</span></a> 解释了如何在Linux上安装 <code class="docutils literal notranslate"><span class="pre">webots_ros2</span></code> 包。</p>
</div><div aria-labelledby="tab-0-V2luZG93cw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-V2luZG93cw==" name="V2luZG93cw==" role="tabpanel" tabindex="0"><p>本教程中的Linux和ROS命令必须在WSL（Windows Subsystem for Linux）环境中运行。下一页 <a class="reference internal" href="Installation-Windows.html"><span class="doc">安装（Windows）</span></a> 解释了如何在Windows上安装 <code class="docutils literal notranslate"><span class="pre">webots_ros2</span></code> 包。</p>
</div><div aria-labelledby="tab-0-bWFjT1M=" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-bWFjT1M=" name="bWFjT1M=" role="tabpanel" tabindex="0"><p>本教程中的Linux和ROS命令必须在预配置的Linux虚拟机（VM）中运行。下面的页面 <a class="reference internal" href="Installation-MacOS.html"><span class="doc">安装（macOS）</span></a> 解释了如何在macOS上安装 <code class="docutils literal notranslate"><span class="pre">webots_ros2</span></code> 包。</p>
</div></div>
</div>
<div class="section" id="tasks">
<h2><a class="toc-backref" href="#id5">任务</a><a class="headerlink" href="#tasks" title="永久链接至标题"></a></h2>
<div class="section" id="create-the-package-structure">
<h3><a class="toc-backref" href="#id6">1 创建软件包结构</a><a class="headerlink" href="#create-the-package-structure" title="永久链接至标题"></a></h3>
<p>我们将在一个自定义的ROS 2软件包中组织代码。从ROS 2工作空间的 <code class="docutils literal notranslate"><span class="pre">src</span></code> 文件夹中创建一个名为 <code class="docutils literal notranslate"><span class="pre">my_package</span></code> 的新软件包。将终端的当前目录更改为 <code class="docutils literal notranslate"><span class="pre">ros2_ws/src</span></code> 并运行以下命令：</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-1-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-1-Qysr" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-1-Qysr" name="Qysr" role="tab" tabindex="-1">C++</button></div><div aria-labelledby="tab-1-UHl0aG9u" class="sphinx-tabs-panel group-tab" id="panel-1-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 pkg create --build-type ament_python --license Apache-2.0 --node-name my_robot_driver my_package --dependencies rclpy geometry_msgs webots_ros2_driver</span>
</pre></div>
</div>
<p>选项 <code class="docutils literal notranslate"><span class="pre">--node-name</span> <span class="pre">my_robot_driver</span></code> 将在 <code class="docutils literal notranslate"><span class="pre">my_package</span></code> 子文件夹中创建一个名为 <code class="docutils literal notranslate"><span class="pre">my_robot_driver.py</span></code> 的模板Python插件，稍后您将对其进行修改。选项 <code class="docutils literal notranslate"><span class="pre">--dependencies</span> <span class="pre">rclpy</span> <span class="pre">geometry_msgs</span> <span class="pre">webots_ros2_driver</span></code> 在 <code class="docutils literal notranslate"><span class="pre">package.xml</span></code> 文件中指定了 <code class="docutils literal notranslate"><span class="pre">my_robot_driver.py</span></code> 插件所需的软件包。</p>
<p>让我们在 <code class="docutils literal notranslate"><span class="pre">my_package</span></code> 文件夹内添加一个 <code class="docutils literal notranslate"><span class="pre">launch</span></code> 和一个 <code class="docutils literal notranslate"><span class="pre">worlds</span></code> 文件夹。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cd my_package</span>
<span class="go">mkdir launch</span>
<span class="go">mkdir worlds</span>
</pre></div>
</div>
<p>最终你应该得到以下的文件结构：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">src/</span>
<span class="go">└── my_package/</span>
<span class="go">    ├── launch/</span>
<span class="go">    ├── my_package/</span>
<span class="go">    │   ├── __init__.py</span>
<span class="go">    │   └── my_robot_driver.py</span>
<span class="go">    ├── resource/</span>
<span class="go">    │   └── my_package</span>
<span class="go">    ├── test/</span>
<span class="go">    │   ├── test_copyright.py</span>
<span class="go">    │   ├── test_flake8.py</span>
<span class="go">    │   └── test_pep257.py</span>
<span class="go">    ├── worlds/</span>
<span class="go">    ├── package.xml</span>
<span class="go">    ├── setup.cfg</span>
<span class="go">    └── setup.py</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-Qysr" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-1-Qysr" name="Qysr" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 pkg create --build-type ament_cmake --license Apache-2.0 --node-name MyRobotDriver my_package --dependencies rclcpp geometry_msgs webots_ros2_driver pluginlib</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">--node-name</span> <span class="pre">MyRobotDriver</span></code> 选项将在 <code class="docutils literal notranslate"><span class="pre">my_package/src</span></code> 子文件夹中创建一个 <code class="docutils literal notranslate"><span class="pre">MyRobotDriver.cpp</span></code> 模板 C++ 插件，稍后你将对其进行修改。<code class="docutils literal notranslate"><span class="pre">--dependencies</span> <span class="pre">rclcpp</span> <span class="pre">geometry_msgs</span> <span class="pre">webots_ros2_driver</span> <span class="pre">pluginlib</span></code> 选项在 <code class="docutils literal notranslate"><span class="pre">package.xml</span></code> 文件中指定了 <code class="docutils literal notranslate"><span class="pre">MyRobotDriver</span></code> 插件所需的软件包。</p>
<p>让我们在 <code class="docutils literal notranslate"><span class="pre">my_package</span></code> 文件夹内添加一个 <code class="docutils literal notranslate"><span class="pre">launch</span></code>、一个 <code class="docutils literal notranslate"><span class="pre">worlds</span></code> 和一个 <code class="docutils literal notranslate"><span class="pre">resource</span></code> 文件夹。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cd my_package</span>
<span class="go">mkdir launch</span>
<span class="go">mkdir worlds</span>
<span class="go">mkdir resource</span>
</pre></div>
</div>
<p>需要创建两个额外的文件：<a href="#id1"><span class="problematic" id="id2">``</span></a>MyRobotDriver``的头文件和``my_robot_driver.xml``的pluginlib描述文件。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">touch my_robot_driver.xml</span>
<span class="go">touch include/my_package/MyRobotDriver.hpp</span>
</pre></div>
</div>
<p>最终你应该得到以下的文件结构：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">src/</span>
<span class="go">└── my_package/</span>
<span class="go">    ├── include/</span>
<span class="go">    │   └── my_package/</span>
<span class="go">    │       └── MyRobotDriver.hpp</span>
<span class="go">    ├── launch/</span>
<span class="go">    ├── resource/</span>
<span class="go">    ├── src/</span>
<span class="go">    │   └── MyRobotDriver.cpp</span>
<span class="go">    ├── worlds/</span>
<span class="go">    ├── CMakeList.txt</span>
<span class="go">    ├── my_robot_driver.xml</span>
<span class="go">    └── package.xml</span>
</pre></div>
</div>
</div></div>
</div>
<div class="section" id="setup-the-simulation-world">
<h3><a class="toc-backref" href="#id7">2 设置仿真世界</a><a class="headerlink" href="#setup-the-simulation-world" title="永久链接至标题"></a></h3>
<p>您需要一个包含机器人的世界文件来启动仿真。:download:<a href="#id1"><span class="problematic" id="id2">`</span></a>下载这个世界文件 &lt;Code/my_world.wbt&gt;`并将其移动到``my_package/worlds/<a href="#id3"><span class="problematic" id="id4">``</span></a>文件夹中。</p>
<p>实际上，这是一个相当简单的文本文件，您可以在文本编辑器中查看。这个``my_world.wbt``世界文件中已经包含了一个简单的机器人。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>如果您想学习如何在Webots中创建自己的机器人模型，您可以查看这个`教程 &lt;<a class="reference external" href="https://cyberbotics.com/doc/guide/tutorial-6-4-wheels-robot">https://cyberbotics.com/doc/guide/tutorial-6-4-wheels-robot</a>&gt;`_。</p>
</div>
</div>
<div class="section" id="edit-the-my-robot-driver-plugin">
<h3><a class="toc-backref" href="#id8">3 编辑``my_robot_driver``插件</a><a class="headerlink" href="#edit-the-my-robot-driver-plugin" title="永久链接至标题"></a></h3>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a>webots_ros2_driver``子包会自动为大多数传感器创建ROS 2接口。关于现有设备接口的更多细节以及如何配置它们，请参阅教程的第二部分： <a class="reference internal" href="Setting-Up-Simulation-Webots-Advanced.html"><span class="doc">设置机器人模拟（高级）</span></a>。在这个任务中，您将通过创建自己的自定义插件来扩展这个接口。这个自定义插件是一个等效于机器人控制器的ROS节点。您可以使用它来访问`Webots机器人API &lt;<a class="reference external" href="https://cyberbotics.com/doc/reference/robot?tab-language=python">https://cyberbotics.com/doc/reference/robot?tab-language=python</a>&gt;`_，并创建自己的话题和服务来控制您的机器人。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>本教程的目的是展示一个最小依赖的基本示例。但是，您可以通过使用另一个名为``webots_ros2_control``的``webots_ros2``子包来避免使用此插件，这将引入新的依赖项。该子包创建了与``ros2_control``包的接口，以便更容易控制差分轮式机器人。</p>
</div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-2-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-2-Qysr" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-2-Qysr" name="Qysr" role="tab" tabindex="-1">C++</button></div><div aria-labelledby="tab-2-UHl0aG9u" class="sphinx-tabs-panel group-tab" id="panel-2-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><p>在您喜欢的编辑器中打开``my_package/my_package/my_robot_driver.py``并将其内容替换为以下内容：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">rclpy</span>
<span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Twist</span>

<span class="n">HALF_DISTANCE_BETWEEN_WHEELS</span> <span class="o">=</span> <span class="mf">0.045</span>
<span class="n">WHEEL_RADIUS</span> <span class="o">=</span> <span class="mf">0.025</span>

<span class="k">class</span> <span class="nc">MyRobotDriver</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">webots_node</span><span class="p">,</span> <span class="n">properties</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__robot</span> <span class="o">=</span> <span class="n">webots_node</span><span class="o">.</span><span class="n">robot</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__left_motor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__robot</span><span class="o">.</span><span class="n">getDevice</span><span class="p">(</span><span class="s1">&#39;left wheel motor&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__right_motor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__robot</span><span class="o">.</span><span class="n">getDevice</span><span class="p">(</span><span class="s1">&#39;right wheel motor&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__left_motor</span><span class="o">.</span><span class="n">setPosition</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__left_motor</span><span class="o">.</span><span class="n">setVelocity</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__right_motor</span><span class="o">.</span><span class="n">setPosition</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__right_motor</span><span class="o">.</span><span class="n">setVelocity</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__target_twist</span> <span class="o">=</span> <span class="n">Twist</span><span class="p">()</span>

        <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__node</span> <span class="o">=</span> <span class="n">rclpy</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;my_robot_driver&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__node</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span><span class="n">Twist</span><span class="p">,</span> <span class="s1">&#39;cmd_vel&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmd_vel_callback</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__cmd_vel_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">twist</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__target_twist</span> <span class="o">=</span> <span class="n">twist</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rclpy</span><span class="o">.</span><span class="n">spin_once</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__node</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">forward_speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__target_twist</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span>
        <span class="n">angular_speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__target_twist</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span>

        <span class="n">command_motor_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">forward_speed</span> <span class="o">-</span> <span class="n">angular_speed</span> <span class="o">*</span> <span class="n">HALF_DISTANCE_BETWEEN_WHEELS</span><span class="p">)</span> <span class="o">/</span> <span class="n">WHEEL_RADIUS</span>
        <span class="n">command_motor_right</span> <span class="o">=</span> <span class="p">(</span><span class="n">forward_speed</span> <span class="o">+</span> <span class="n">angular_speed</span> <span class="o">*</span> <span class="n">HALF_DISTANCE_BETWEEN_WHEELS</span><span class="p">)</span> <span class="o">/</span> <span class="n">WHEEL_RADIUS</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__left_motor</span><span class="o">.</span><span class="n">setVelocity</span><span class="p">(</span><span class="n">command_motor_left</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__right_motor</span><span class="o">.</span><span class="n">setVelocity</span><span class="p">(</span><span class="n">command_motor_right</span><span class="p">)</span>
</pre></div>
</div>
<p>正如您所看到的，<a href="#id1"><span class="problematic" id="id2">``</span></a>MyRobotDriver``类实现了三个方法。</p>
<p>第一个方法名为``init(self, ...)`'，实际上是Python中``__init__(self, ...)`构造函数的ROS节点对应方法。<a href="#id1"><span class="problematic" id="id2">``</span></a>init``方法始终接受两个参数：</p>
<ul class="simple">
<li><p><a href="#id1"><span class="problematic" id="id2">``</span></a>webots_node``参数包含对Webots实例的引用。</p></li>
<li><p><a href="#id1"><span class="problematic" id="id2">``</span></a>properties``参数是从URDF文件(<span class="xref std std-ref">4 创建my_robot.urdf文件</span>)中提取的XML标签创建的字典，它允许您将参数传递给控制器。</p></li>
</ul>
<p>来自仿真的机器人实例``self.__robot``可用于访问`Webots机器人API&lt;<a class="reference external" href="https://cyberbotics.com/doc/reference/robot?tab-language=python">https://cyberbotics.com/doc/reference/robot?tab-language=python</a>&gt;`_。然后，它获取两个电机实例，并使用目标位置和目标速度进行初始化。最后，创建一个ROS节点，并为名为``/cmd_vel``的ROS主题注册一个回调方法，该回调方法将处理``Twist``消息。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">webots_node</span><span class="p">,</span> <span class="n">properties</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__robot</span> <span class="o">=</span> <span class="n">webots_node</span><span class="o">.</span><span class="n">robot</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">__left_motor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__robot</span><span class="o">.</span><span class="n">getDevice</span><span class="p">(</span><span class="s1">&#39;left wheel motor&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__right_motor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__robot</span><span class="o">.</span><span class="n">getDevice</span><span class="p">(</span><span class="s1">&#39;right wheel motor&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">__left_motor</span><span class="o">.</span><span class="n">setPosition</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__left_motor</span><span class="o">.</span><span class="n">setVelocity</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">__right_motor</span><span class="o">.</span><span class="n">setPosition</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__right_motor</span><span class="o">.</span><span class="n">setVelocity</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">__target_twist</span> <span class="o">=</span> <span class="n">Twist</span><span class="p">()</span>

    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__node</span> <span class="o">=</span> <span class="n">rclpy</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;my_robot_driver&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__node</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span><span class="n">Twist</span><span class="p">,</span> <span class="s1">&#39;cmd_vel&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmd_vel_callback</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>然后，实现了``__cmd_vel_callback(self, twist)``回调私有方法，该方法将在``/cmd_vel``主题接收到每个``Twist``消息时被调用，并将其保存在``self.__target_twist``成员变量中。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">__cmd_vel_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">twist</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__target_twist</span> <span class="o">=</span> <span class="n">twist</span>
</pre></div>
</div>
<p>最后，在仿真的每个时间步骤中调用``step(self)``方法。调用``rclpy.spin_once()``是为了保持ROS节点的平稳运行。在每个时间步骤中，该方法将从``self.__target_twist``中获取所需的``forward_speed``和``angular_speed``。由于电机受到角速度的控制，该方法将把``forward_speed``和``angular_speed``转换为每个轮子的单独命令。此转换取决于机器人的结构，更具体地说是轮子的半径和它们之间的距离。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">spin_once</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__node</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">forward_speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__target_twist</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span>
    <span class="n">angular_speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__target_twist</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span>

    <span class="n">command_motor_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">forward_speed</span> <span class="o">-</span> <span class="n">angular_speed</span> <span class="o">*</span> <span class="n">HALF_DISTANCE_BETWEEN_WHEELS</span><span class="p">)</span> <span class="o">/</span> <span class="n">WHEEL_RADIUS</span>
    <span class="n">command_motor_right</span> <span class="o">=</span> <span class="p">(</span><span class="n">forward_speed</span> <span class="o">+</span> <span class="n">angular_speed</span> <span class="o">*</span> <span class="n">HALF_DISTANCE_BETWEEN_WHEELS</span><span class="p">)</span> <span class="o">/</span> <span class="n">WHEEL_RADIUS</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">__left_motor</span><span class="o">.</span><span class="n">setVelocity</span><span class="p">(</span><span class="n">command_motor_left</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__right_motor</span><span class="o">.</span><span class="n">setVelocity</span><span class="p">(</span><span class="n">command_motor_right</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-Qysr" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-2-Qysr" name="Qysr" role="tabpanel" tabindex="0"><p>在您喜欢的编辑器中打开 <code class="docutils literal notranslate"><span class="pre">my_package/src/MyRobotDriver.hpp</span></code> 并将其内容替换为以下内容：</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef WEBOTS_ROS2_PLUGIN_EXAMPLE_HPP</span>
<span class="cp">#define WEBOTS_ROS2_PLUGIN_EXAMPLE_HPP</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rclcpp/macros.hpp&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;webots_ros2_driver/PluginInterface.hpp&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;webots_ros2_driver/WebotsNode.hpp&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;geometry_msgs/msg/twist.hpp&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rclcpp/rclcpp.hpp&quot;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">my_robot_driver</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">MyRobotDriver</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">webots_ros2_driver</span><span class="o">::</span><span class="n">PluginInterface</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">step</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="n">webots_ros2_driver</span><span class="o">::</span><span class="n">WebotsNode</span><span class="w"> </span><span class="o">*</span><span class="n">node</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">parameters</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span><span class="w"></span>

<span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">cmdVelCallback</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Twist</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Subscription</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Twist</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"></span>
<span class="w">      </span><span class="n">cmd_vel_subscription_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Twist</span><span class="w"> </span><span class="n">cmd_vel_msg</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">WbDeviceTag</span><span class="w"> </span><span class="n">right_motor</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">WbDeviceTag</span><span class="w"> </span><span class="n">left_motor</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="c1">// namespace my_robot_driver</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>定义了类 <code class="docutils literal notranslate"><span class="pre">MyRobotDriver</span></code>，它继承自 <code class="docutils literal notranslate"><span class="pre">webots_ros2_driver::PluginInterface</span></code> 类。插件必须重写 <code class="docutils literal notranslate"><span class="pre">step(...)</span></code> 和 <code class="docutils literal notranslate"><span class="pre">init(...)</span></code> 函数。更多详细信息请参阅 <code class="docutils literal notranslate"><span class="pre">MyRobotDriver.cpp</span></code> 文件。在插件内部，声明了几个辅助方法、回调函数和成员变量，它们将在插件内部使用，并作为私有成员。</p>
<p>然后，在您喜欢的编辑器中打开 <code class="docutils literal notranslate"><span class="pre">my_package/src/MyRobotDriver.cpp</span></code> 并将其内容替换为以下内容：</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;my_package/MyRobotDriver.hpp&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rclcpp/rclcpp.hpp&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;functional&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;webots/motor.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;webots/robot.h&gt;</span><span class="cp"></span>

<span class="cp">#define HALF_DISTANCE_BETWEEN_WHEELS 0.045</span>
<span class="cp">#define WHEEL_RADIUS 0.025</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">my_robot_driver</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">MyRobotDriver::init</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">webots_ros2_driver</span><span class="o">::</span><span class="n">WebotsNode</span><span class="w"> </span><span class="o">*</span><span class="n">node</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">parameters</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="n">right_motor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wb_robot_get_device</span><span class="p">(</span><span class="s">&quot;right wheel motor&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">left_motor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wb_robot_get_device</span><span class="p">(</span><span class="s">&quot;left wheel motor&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">wb_motor_set_position</span><span class="p">(</span><span class="n">left_motor</span><span class="p">,</span><span class="w"> </span><span class="n">INFINITY</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">wb_motor_set_velocity</span><span class="p">(</span><span class="n">left_motor</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">wb_motor_set_position</span><span class="p">(</span><span class="n">right_motor</span><span class="p">,</span><span class="w"> </span><span class="n">INFINITY</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">wb_motor_set_velocity</span><span class="p">(</span><span class="n">right_motor</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">cmd_vel_subscription_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="o">-&gt;</span><span class="n">create_subscription</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Twist</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;/cmd_vel&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">SensorDataQoS</span><span class="p">().</span><span class="n">reliable</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MyRobotDriver</span><span class="o">::</span><span class="n">cmdVelCallback</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">MyRobotDriver::cmdVelCallback</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Twist</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">cmd_vel_msg</span><span class="p">.</span><span class="n">linear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">linear</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">cmd_vel_msg</span><span class="p">.</span><span class="n">angular</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">angular</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">MyRobotDriver::step</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">forward_speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cmd_vel_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">angular_speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cmd_vel_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">command_motor_left</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">forward_speed</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">angular_speed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">HALF_DISTANCE_BETWEEN_WHEELS</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">      </span><span class="n">WHEEL_RADIUS</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">command_motor_right</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">forward_speed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">angular_speed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">HALF_DISTANCE_BETWEEN_WHEELS</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">      </span><span class="n">WHEEL_RADIUS</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">wb_motor_set_velocity</span><span class="p">(</span><span class="n">left_motor</span><span class="p">,</span><span class="w"> </span><span class="n">command_motor_left</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">wb_motor_set_velocity</span><span class="p">(</span><span class="n">right_motor</span><span class="p">,</span><span class="w"> </span><span class="n">command_motor_right</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="c1">// namespace my_robot_driver</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;pluginlib/class_list_macros.hpp&quot;</span><span class="cp"></span>
<span class="n">PLUGINLIB_EXPORT_CLASS</span><span class="p">(</span><span class="n">my_robot_driver</span><span class="o">::</span><span class="n">MyRobotDriver</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">webots_ros2_driver</span><span class="o">::</span><span class="n">PluginInterface</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>一旦 <code class="docutils literal notranslate"><span class="pre">webots_ros2_driver</span></code> 包加载插件，就会执行 <code class="docutils literal notranslate"><span class="pre">MyRobotDriver::init</span></code> 方法。它接受两个参数：</p>
<ul class="simple">
<li><p>一个指向``webots_ros2_driver``定义的``WebotsNode``的指针，它允许访问ROS 2节点函数。</p></li>
<li><p><a href="#id1"><span class="problematic" id="id2">``</span></a>parameters``参数是一个无序的字符串映射，由URDF文件（<span class="xref std std-ref">4 创建my_robot.urdf文件</span>）中给定的XML标签创建，并允许向控制器传递参数。在此示例中不使用它。</p></li>
</ul>
<p>它通过设置机器人电机、设置它们的位置和速度，并订阅``/cmd_vel``主题来初始化插件。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">MyRobotDriver::init</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">webots_ros2_driver</span><span class="o">::</span><span class="n">WebotsNode</span><span class="w"> </span><span class="o">*</span><span class="n">node</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">parameters</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">  </span><span class="n">right_motor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wb_robot_get_device</span><span class="p">(</span><span class="s">&quot;right wheel motor&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">left_motor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wb_robot_get_device</span><span class="p">(</span><span class="s">&quot;left wheel motor&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">wb_motor_set_position</span><span class="p">(</span><span class="n">left_motor</span><span class="p">,</span><span class="w"> </span><span class="n">INFINITY</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">wb_motor_set_velocity</span><span class="p">(</span><span class="n">left_motor</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">wb_motor_set_position</span><span class="p">(</span><span class="n">right_motor</span><span class="p">,</span><span class="w"> </span><span class="n">INFINITY</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">wb_motor_set_velocity</span><span class="p">(</span><span class="n">right_motor</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="n">cmd_vel_subscription_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="o">-&gt;</span><span class="n">create_subscription</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Twist</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="s">&quot;/cmd_vel&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">SensorDataQoS</span><span class="p">().</span><span class="n">reliable</span><span class="p">(),</span><span class="w"></span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MyRobotDriver</span><span class="o">::</span><span class="n">cmdVelCallback</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="o">::</span><span class="n">_1</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>然后是``cmdVelCallback()``回调函数的实现，它将在``/cmd_vel``主题接收到每个Twist消息时被调用，并将其保存在``cmd_vel_msg``成员变量中。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">MyRobotDriver::cmdVelCallback</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Twist</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">cmd_vel_msg</span><span class="p">.</span><span class="n">linear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">linear</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">cmd_vel_msg</span><span class="p">.</span><span class="n">angular</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">angular</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">step()</span></code> 方法在模拟的每个时间步调用。在每个时间步中，该方法将从 <code class="docutils literal notranslate"><span class="pre">cmd_vel_msg</span></code> 中获取所需的 <code class="docutils literal notranslate"><span class="pre">forward_speed</span></code> 和 <code class="docutils literal notranslate"><span class="pre">angular_speed</span></code>。由于电机是由角速度控制的，因此该方法将把 <code class="docutils literal notranslate"><span class="pre">forward_speed</span></code> 和 <code class="docutils literal notranslate"><span class="pre">angular_speed</span></code> 转换为每个轮子的单独命令。这种转换取决于机器人的结构，更具体地说是轮子的半径和它们之间的距离。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">MyRobotDriver::step</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">forward_speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cmd_vel_msg</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">angular_speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cmd_vel_msg</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">command_motor_left</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">forward_speed</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">angular_speed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">HALF_DISTANCE_BETWEEN_WHEELS</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">      </span><span class="n">WHEEL_RADIUS</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">command_motor_right</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">forward_speed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">angular_speed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">HALF_DISTANCE_BETWEEN_WHEELS</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"></span>
<span class="w">      </span><span class="n">WHEEL_RADIUS</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">wb_motor_set_velocity</span><span class="p">(</span><span class="n">left_motor</span><span class="p">,</span><span class="w"> </span><span class="n">command_motor_left</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">wb_motor_set_velocity</span><span class="p">(</span><span class="n">right_motor</span><span class="p">,</span><span class="w"> </span><span class="n">command_motor_right</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>文件的最后几行定义了``my_robot_driver`` 命名空间的结束，并使用 <code class="docutils literal notranslate"><span class="pre">PLUGINLIB_EXPORT_CLASS</span></code> 宏将 <code class="docutils literal notranslate"><span class="pre">MyRobotDriver</span></code> 类导出为插件。这允许在运行时由Webots ROS2驱动程序加载该插件。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;pluginlib/class_list_macros.hpp&quot;</span><span class="cp"></span>
<span class="n">PLUGINLIB_EXPORT_CLASS</span><span class="p">(</span><span class="n">my_robot_driver</span><span class="o">::</span><span class="n">MyRobotDriver</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="n">webots_ros2_driver</span><span class="o">::</span><span class="n">PluginInterface</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>尽管插件是用C++实现的，但必须使用C API与Webots控制器库进行交互。</p>
</div>
</div></div>
</div>
<div class="section" id="create-the-my-robot-urdf-file">
<span id="id2"></span><h3><a class="toc-backref" href="#id9">4 创建 <code class="docutils literal notranslate"><span class="pre">my_robot.urdf</span></code> 文件</a><a class="headerlink" href="#create-the-my-robot-urdf-file" title="永久链接至标题"></a></h3>
<p>您现在需要创建一个URDF文件来声明``MyRobotDriver``插件。这将允许``webots_ros2_driver`` ROS节点启动插件并将其连接到目标机器人。</p>
<p>在``my_package/resource``文件夹中创建一个名为``my_robot.urdf``的文本文件，其内容如下：</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-3-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-3-Qysr" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-3-Qysr" name="Qysr" role="tab" tabindex="-1">C++</button></div><div aria-labelledby="tab-3-UHl0aG9u" class="sphinx-tabs-panel group-tab" id="panel-3-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; ?&gt;</span>
<span class="nt">&lt;robot</span> <span class="na">name=</span><span class="s">&quot;My robot&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;webots&gt;</span>
        <span class="nt">&lt;plugin</span> <span class="na">type=</span><span class="s">&quot;my_package.my_robot_driver.MyRobotDriver&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/webots&gt;</span>
<span class="nt">&lt;/robot&gt;</span>
</pre></div>
</div>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a>type``属性指定了根据文件的层次结构给出的类路径。<a href="#id3"><span class="problematic" id="id4">``</span></a>webots_ros2_driver``负责根据指定的软件包和模块加载类。</p>
</div><div aria-labelledby="tab-3-Qysr" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-3-Qysr" name="Qysr" role="tabpanel" tabindex="0"><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; ?&gt;</span>
<span class="nt">&lt;robot</span> <span class="na">name=</span><span class="s">&quot;My robot&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;webots&gt;</span>
        <span class="nt">&lt;plugin</span> <span class="na">type=</span><span class="s">&quot;my_robot_driver::MyRobotDriver&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/webots&gt;</span>
<span class="nt">&lt;/robot&gt;</span>
</pre></div>
</div>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a>type``属性指定要加载的命名空间和类名。<a href="#id3"><span class="problematic" id="id4">``</span></a>pluginlib``负责根据指定的信息加载类。</p>
</div></div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>这个简单的URDF文件不包含关于机器人的任何链接或关节信息，因为在本教程中不需要。然而，URDF文件通常包含更多的信息，如在 <a class="reference internal" href="../../../Intermediate/URDF/URDF-Main.html"><span class="doc">URDF</span></a> 教程中所解释的。</p>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>这里的插件不接受任何输入参数，但可以通过包含参数名的标签来实现。</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-4-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-4-Qysr" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-4-Qysr" name="Qysr" role="tab" tabindex="-1">C++</button></div><div aria-labelledby="tab-4-UHl0aG9u" class="sphinx-tabs-panel group-tab" id="panel-4-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;plugin</span> <span class="na">type=</span><span class="s">&quot;my_package.my_robot_driver.MyRobotDriver&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parameterName&gt;</span>someValue<span class="nt">&lt;/parameterName&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-4-Qysr" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-4-Qysr" name="Qysr" role="tabpanel" tabindex="0"><div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;plugin</span> <span class="na">type=</span><span class="s">&quot;my_robot_driver::MyRobotDriver&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parameterName&gt;</span>someValue<span class="nt">&lt;/parameterName&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</pre></div>
</div>
</div></div>
<p>这主要用于向现有的Webots设备插件传递参数（参见 <a class="reference internal" href="Setting-Up-Simulation-Webots-Advanced.html"><span class="doc">设置机器人模拟（高级）</span></a>）。</p>
</div>
</div>
<div class="section" id="create-the-launch-file">
<h3><a class="toc-backref" href="#id10">5 创建启动文件</a><a class="headerlink" href="#create-the-launch-file" title="永久链接至标题"></a></h3>
<p>让我们创建启动文件，以便可以通过一个命令轻松启动仿真和ROS控制器。在``my_package/launch``文件夹中创建一个名为``robot_launch.py``的新文本文件，并使用以下代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">launch</span>
<span class="kn">from</span> <span class="nn">launch_ros.actions</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="nn">launch</span> <span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span> <span class="nn">ament_index_python.packages</span> <span class="kn">import</span> <span class="n">get_package_share_directory</span>
<span class="kn">from</span> <span class="nn">webots_ros2_driver.webots_launcher</span> <span class="kn">import</span> <span class="n">WebotsLauncher</span>
<span class="kn">from</span> <span class="nn">webots_ros2_driver.utils</span> <span class="kn">import</span> <span class="n">controller_url_prefix</span>


<span class="k">def</span> <span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="n">package_dir</span> <span class="o">=</span> <span class="n">get_package_share_directory</span><span class="p">(</span><span class="s1">&#39;my_package&#39;</span><span class="p">)</span>
    <span class="n">robot_description</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">package_dir</span><span class="p">,</span> <span class="s1">&#39;resource&#39;</span><span class="p">,</span> <span class="s1">&#39;my_robot.urdf&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>

    <span class="n">webots</span> <span class="o">=</span> <span class="n">WebotsLauncher</span><span class="p">(</span>
        <span class="n">world</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">package_dir</span><span class="p">,</span> <span class="s1">&#39;worlds&#39;</span><span class="p">,</span> <span class="s1">&#39;my_world.wbt&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">my_robot_driver</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
        <span class="n">package</span><span class="o">=</span><span class="s1">&#39;webots_ros2_driver&#39;</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;driver&#39;</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="s1">&#39;screen&#39;</span><span class="p">,</span>
        <span class="n">additional_env</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;WEBOTS_CONTROLLER_URL&#39;</span><span class="p">:</span> <span class="n">controller_url_prefix</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;my_robot&#39;</span><span class="p">},</span>
        <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;robot_description&#39;</span><span class="p">:</span> <span class="n">robot_description</span><span class="p">},</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">LaunchDescription</span><span class="p">([</span>
        <span class="n">webots</span><span class="p">,</span>
        <span class="n">my_robot_driver</span><span class="p">,</span>
        <span class="n">launch</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">RegisterEventHandler</span><span class="p">(</span>
            <span class="n">event_handler</span><span class="o">=</span><span class="n">launch</span><span class="o">.</span><span class="n">event_handlers</span><span class="o">.</span><span class="n">OnProcessExit</span><span class="p">(</span>
                <span class="n">target_action</span><span class="o">=</span><span class="n">webots</span><span class="p">,</span>
                <span class="n">on_exit</span><span class="o">=</span><span class="p">[</span><span class="n">launch</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">EmitEvent</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">launch</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">Shutdown</span><span class="p">())],</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">])</span>
</pre></div>
</div>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a>WebotsLauncher``对象是一个自定义动作，可以启动Webots仿真实例。您需要在构造函数中指定模拟器将打开的世界文件。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">webots</span> <span class="o">=</span> <span class="n">WebotsLauncher</span><span class="p">(</span>
    <span class="n">world</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">package_dir</span><span class="p">,</span> <span class="s1">&#39;worlds&#39;</span><span class="p">,</span> <span class="s1">&#39;my_world.wbt&#39;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>然后，创建与模拟机器人交互的ROS节点。此节点名为``driver``，位于``webots_ros2_driver``包中。</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-5-TGludXg=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-5-TGludXg=" name="TGludXg=" role="tab" tabindex="0">Linux</button><button aria-controls="panel-5-V2luZG93cw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-5-V2luZG93cw==" name="V2luZG93cw==" role="tab" tabindex="-1">Windows</button><button aria-controls="panel-5-bWFjT1M=" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-5-bWFjT1M=" name="bWFjT1M=" role="tab" tabindex="-1">macOS</button></div><div aria-labelledby="tab-5-TGludXg=" class="sphinx-tabs-panel group-tab" id="panel-5-TGludXg=" name="TGludXg=" role="tabpanel" tabindex="0"><p>该节点将能够使用基于IPC和共享内存的自定义协议与模拟机器人通信。</p>
</div><div aria-labelledby="tab-5-V2luZG93cw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-5-V2luZG93cw==" name="V2luZG93cw==" role="tabpanel" tabindex="0"><p>在WSL中的节点将能够通过TCP连接与在本机Windows上的Webots模拟机器人进行通信。</p>
</div><div aria-labelledby="tab-5-bWFjT1M=" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-5-bWFjT1M=" name="bWFjT1M=" role="tabpanel" tabindex="0"><p>在Docker容器中的节点将能够通过TCP连接与在本机macOS上的Webots模拟机器人进行通信。</p>
</div></div>
<p>在您的情况下，您需要运行一个此节点的实例，因为您在仿真中只有一个机器人。但是，如果您在仿真中有多个机器人，您需要为每个机器人运行一个此节点的实例。<a href="#id1"><span class="problematic" id="id2">``</span></a>WEBOTS_CONTROLLER_URL``用于定义驱动程序应连接到的机器人的名称。<a href="#id3"><span class="problematic" id="id4">``</span></a>controller_url_prefix()``方法是必需的，因为它允许``webots_ros2_driver``根据您的平台添加正确的协议前缀。<a href="#id5"><span class="problematic" id="id6">``</span></a>robot_description``参数保存了指向``MyRobotDriver``插件的URDF文件的内容。您可以将``driver``节点视为将控制器插件与目标机器人连接的接口。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_robot_driver</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="s1">&#39;webots_ros2_driver&#39;</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;driver&#39;</span><span class="p">,</span>
    <span class="n">output</span><span class="o">=</span><span class="s1">&#39;screen&#39;</span><span class="p">,</span>
    <span class="n">additional_env</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;WEBOTS_CONTROLLER_URL&#39;</span><span class="p">:</span> <span class="n">controller_url_prefix</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;my_robot&#39;</span><span class="p">},</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;robot_description&#39;</span><span class="p">:</span> <span class="n">robot_description</span><span class="p">},</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>之后，这两个节点被设置为在``LaunchDescription``构造函数中启动：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">LaunchDescription</span><span class="p">([</span>
    <span class="n">webots</span><span class="p">,</span>
    <span class="n">my_robot_driver</span><span class="p">,</span>
</pre></div>
</div>
<p>最后，为了在Webots终止时关闭所有节点（例如，当从图形用户界面关闭时），添加了一个可选部分。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">launch</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">RegisterEventHandler</span><span class="p">(</span>
    <span class="n">event_handler</span><span class="o">=</span><span class="n">launch</span><span class="o">.</span><span class="n">event_handlers</span><span class="o">.</span><span class="n">OnProcessExit</span><span class="p">(</span>
        <span class="n">target_action</span><span class="o">=</span><span class="n">webots</span><span class="p">,</span>
        <span class="n">on_exit</span><span class="o">=</span><span class="p">[</span><span class="n">launch</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">EmitEvent</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">launch</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">Shutdown</span><span class="p">())],</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>关于``webots_ros2_driver``和``WebotsLauncher``参数的更多详细信息可以在`节点参考页面 &lt;<a class="reference external" href="https://github.com/cyberbotics/webots_ros2/wiki/References-Nodes">https://github.com/cyberbotics/webots_ros2/wiki/References-Nodes</a>&gt;`_找到。</p>
</div>
</div>
<div class="section" id="edit-additional-files">
<h3><a class="toc-backref" href="#id11">6 编辑附加文件</a><a class="headerlink" href="#edit-additional-files" title="永久链接至标题"></a></h3>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-6-UHl0aG9u" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-6-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="0">Python</button><button aria-controls="panel-6-Qysr" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-6-Qysr" name="Qysr" role="tab" tabindex="-1">C++</button></div><div aria-labelledby="tab-6-UHl0aG9u" class="sphinx-tabs-panel group-tab" id="panel-6-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><p>在您启动启动文件之前，您必须修改``setup.py``文件以包括您添加的额外文件。打开``my_package/setup.py``并用以下内容替换其内容：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span>

<span class="n">package_name</span> <span class="o">=</span> <span class="s1">&#39;my_package&#39;</span>
<span class="n">data_files</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">data_files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;share/ament_index/resource_index/packages&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;resource/&#39;</span> <span class="o">+</span> <span class="n">package_name</span><span class="p">]))</span>
<span class="n">data_files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;share/&#39;</span> <span class="o">+</span> <span class="n">package_name</span> <span class="o">+</span> <span class="s1">&#39;/launch&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;launch/robot_launch.py&#39;</span><span class="p">]))</span>
<span class="n">data_files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;share/&#39;</span> <span class="o">+</span> <span class="n">package_name</span> <span class="o">+</span> <span class="s1">&#39;/worlds&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;worlds/my_world.wbt&#39;</span><span class="p">]))</span>
<span class="n">data_files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;share/&#39;</span> <span class="o">+</span> <span class="n">package_name</span> <span class="o">+</span> <span class="s1">&#39;/resource&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;resource/my_robot.urdf&#39;</span><span class="p">]))</span>
<span class="n">data_files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;share/&#39;</span> <span class="o">+</span> <span class="n">package_name</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;package.xml&#39;</span><span class="p">]))</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="n">package_name</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="s1">&#39;0.0.0&#39;</span><span class="p">,</span>
    <span class="n">packages</span><span class="o">=</span><span class="p">[</span><span class="n">package_name</span><span class="p">],</span>
    <span class="n">data_files</span><span class="o">=</span><span class="n">data_files</span><span class="p">,</span>
    <span class="n">install_requires</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;setuptools&#39;</span><span class="p">],</span>
    <span class="n">zip_safe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">maintainer</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span>
    <span class="n">maintainer_email</span><span class="o">=</span><span class="s1">&#39;user.name@mail.com&#39;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;TODO: Package description&#39;</span><span class="p">,</span>
    <span class="n">license</span><span class="o">=</span><span class="s1">&#39;TODO: License declaration&#39;</span><span class="p">,</span>
    <span class="n">tests_require</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pytest&#39;</span><span class="p">],</span>
    <span class="n">entry_points</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;console_scripts&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;my_robot_driver = my_package.my_robot_driver:main&#39;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
<p>这个设置了包并在``data_files``变量中添加了新增的文件：<code class="docutils literal notranslate"><span class="pre">my_world.wbt</span></code>、<code class="docutils literal notranslate"><span class="pre">my_robot.urdf``和``robot_launch.py</span></code>。</p>
</div><div aria-labelledby="tab-6-Qysr" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-6-Qysr" name="Qysr" role="tabpanel" tabindex="0"><p>在启动文件之前，您必须修改``CMakeLists.txt``和``my_robot_driver.xml``文件：</p>
<ul class="simple">
<li><p><a href="#id1"><span class="problematic" id="id2">``</span></a>CMakeLists.txt``定义了您插件的编译规则。</p></li>
<li><p><a href="#id1"><span class="problematic" id="id2">``</span></a>my_robot_driver.xml``对于pluginlib找到您的Webots ROS 2插件是必需的。</p></li>
</ul>
<p>打开``my_package/my_robot_driver.xml``并将其内容替换为：</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;library</span> <span class="na">path=</span><span class="s">&quot;my_package&quot;</span><span class="nt">&gt;</span>
  <span class="cm">&lt;!-- The `type` attribute is a reference to the plugin class. --&gt;</span>
  <span class="cm">&lt;!-- The `base_class_type` attribute is always `webots_ros2_driver::PluginInterface`. --&gt;</span>
  <span class="nt">&lt;class</span> <span class="na">type=</span><span class="s">&quot;my_robot_driver::MyRobotDriver&quot;</span> <span class="na">base_class_type=</span><span class="s">&quot;webots_ros2_driver::PluginInterface&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;description&gt;</span>
      This is a Webots ROS 2 plugin example
    <span class="nt">&lt;/description&gt;</span>
  <span class="nt">&lt;/class&gt;</span>
<span class="nt">&lt;/library&gt;</span>
</pre></div>
</div>
<p>打开``my_package/CMakeLists.txt``并将其内容替换为：</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span><span class="w"> </span><span class="s">3.5</span><span class="p">)</span>
<span class="nb">project</span><span class="p">(</span><span class="s">my_package</span><span class="p">)</span>

<span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="s">CMAKE_CXX_STANDARD</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_STANDARD</span><span class="w"> </span><span class="s">14</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># Besides the package specific dependencies we also need the `pluginlib` and `webots_ros2_driver`</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">ament_cmake</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">rclcpp</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">std_msgs</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">geometry_msgs</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">pluginlib</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">webots_ros2_driver</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>

<span class="c"># Export the plugin configuration file</span>
<span class="nb">pluginlib_export_plugin_description_file</span><span class="p">(</span><span class="s">webots_ros2_driver</span><span class="w"> </span><span class="s">my_robot_driver.xml</span><span class="p">)</span>

<span class="c"># MyRobotDriver library</span>
<span class="nb">add_library</span><span class="p">(</span>
<span class="w">  </span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span>
<span class="w">  </span><span class="s">SHARED</span>
<span class="w">  </span><span class="s">src/MyRobotDriver.cpp</span>
<span class="p">)</span>
<span class="nb">target_include_directories</span><span class="p">(</span>
<span class="w">  </span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span>
<span class="w">  </span><span class="s">PRIVATE</span>
<span class="w">  </span><span class="s">include</span>
<span class="p">)</span>
<span class="nb">ament_target_dependencies</span><span class="p">(</span>
<span class="w">  </span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span>
<span class="w">  </span><span class="s">pluginlib</span>
<span class="w">  </span><span class="s">rclcpp</span>
<span class="w">  </span><span class="s">webots_ros2_driver</span>
<span class="p">)</span>
<span class="nb">install</span><span class="p">(</span><span class="s">TARGETS</span>
<span class="w">  </span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span>
<span class="w">  </span><span class="s">ARCHIVE</span><span class="w"> </span><span class="s">DESTINATION</span><span class="w"> </span><span class="s">lib</span>
<span class="w">  </span><span class="s">LIBRARY</span><span class="w"> </span><span class="s">DESTINATION</span><span class="w"> </span><span class="s">lib</span>
<span class="w">  </span><span class="s">RUNTIME</span><span class="w"> </span><span class="s">DESTINATION</span><span class="w"> </span><span class="s">bin</span>
<span class="p">)</span>
<span class="c"># Install additional directories.</span>
<span class="nb">install</span><span class="p">(</span><span class="s">DIRECTORY</span>
<span class="w">  </span><span class="s">launch</span>
<span class="w">  </span><span class="s">resource</span>
<span class="w">  </span><span class="s">worlds</span>
<span class="w">  </span><span class="s">DESTINATION</span><span class="w"> </span><span class="s">share/</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span><span class="s">/</span>
<span class="p">)</span>
<span class="nb">ament_export_include_directories</span><span class="p">(</span>
<span class="w">  </span><span class="s">include</span>
<span class="p">)</span>
<span class="nb">ament_export_libraries</span><span class="p">(</span>
<span class="w">  </span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span>
<span class="p">)</span>
<span class="nb">ament_package</span><span class="p">()</span>
</pre></div>
</div>
<p>CMakeLists.txt使用``pluginlib_export_plugin_description_file()``导出插件配置文件，定义了C++插件``src/MyRobotDriver.cpp``的共享库，并使用``ament_target_dependencies()``设置包含和库依赖项。</p>
<p>然后，该文件将库、目录``launch``、<a href="#id1"><span class="problematic" id="id2">``</span></a>resource``和``worlds``安装到``share/my_package``目录中。最后，它使用``ament_export_include_directories()``和``ament_export_libraries()``分别导出包含目录和库，并使用``ament_package()``声明包。</p>
</div></div>
</div>
<div class="section" id="test-the-code">
<h3><a class="toc-backref" href="#id12">7 测试代码</a><a class="headerlink" href="#test-the-code" title="永久链接至标题"></a></h3>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-7-TGludXg=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-7-TGludXg=" name="TGludXg=" role="tab" tabindex="0">Linux</button><button aria-controls="panel-7-V2luZG93cw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-7-V2luZG93cw==" name="V2luZG93cw==" role="tab" tabindex="-1">Windows</button><button aria-controls="panel-7-bWFjT1M=" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-7-bWFjT1M=" name="bWFjT1M=" role="tab" tabindex="-1">macOS</button></div><div aria-labelledby="tab-7-TGludXg=" class="sphinx-tabs-panel group-tab" id="panel-7-TGludXg=" name="TGludXg=" role="tabpanel" tabindex="0"><p>在ROS 2工作空间的终端中运行：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">colcon build</span>
<span class="go">source install/local_setup.bash</span>
<span class="go">ros2 launch my_package robot_launch.py</span>
</pre></div>
</div>
<p>这将启动模拟。如果尚未安装Webots，则在第一次运行时将自动安装。</p>
</div><div aria-labelledby="tab-7-V2luZG93cw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-7-V2luZG93cw==" name="V2luZG93cw==" role="tabpanel" tabindex="0"><p>在WSL ROS 2工作空间的终端中运行：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">colcon build</span>
<span class="go">export WEBOTS_HOME=/mnt/c/Program\ Files/Webots</span>
<span class="go">source install/local_setup.bash</span>
<span class="go">ros2 launch my_package robot_launch.py</span>
</pre></div>
</div>
<p>确保在WSL中使用``/mnt``前缀来访问Windows文件系统中Webots安装文件夹的路径。</p>
<p>这将启动模拟。如果尚未安装Webots，则在第一次运行时将自动安装。</p>
</div><div aria-labelledby="tab-7-bWFjT1M=" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-7-bWFjT1M=" name="bWFjT1M=" role="tabpanel" tabindex="0"><p>在 macOS 上，必须在主机上启动本地服务器才能从虚拟机中启动Webots。可以从`webots-server存储库 &lt;<a class="reference external" href="https://github.com/cyberbotics/webots-server/blob/main/local_simulation_server.py">https://github.com/cyberbotics/webots-server/blob/main/local_simulation_server.py</a>&gt;`_ 下载本地服务器。</p>
<p>在主机机器的终端（而不是虚拟机）中，指定Webots安装文件夹（例如 <code class="docutils literal notranslate"><span class="pre">/Applications/Webots.app</span></code>）并使用以下命令启动服务器：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export WEBOTS_HOME=/Applications/Webots.app</span>
<span class="go">python3 local_simulation_server.py</span>
</pre></div>
</div>
<p>在您的ROS 2工作空间中的Linux虚拟机终端中，使用以下命令构建并启动您的自定义软件包：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">colcon build</span>
<span class="go">source install/local_setup.bash</span>
<span class="go">ros2 launch my_package robot_launch.py</span>
</pre></div>
</div>
</div></div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>如果您想手动安装Webots，您可以从`此处 &lt;<a class="reference external" href="https://github.com/cyberbotics/webots/releases/latest">https://github.com/cyberbotics/webots/releases/latest</a>&gt;`_ 下载。</p>
</div>
<p>然后，打开第二个终端并发送以下命令：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 topic pub /cmd_vel geometry_msgs/Twist  &quot;linear: { x: 0.1 }&quot;</span>
</pre></div>
</div>
<p>机器人现在正在向前移动。</p>
<img alt="../../../../_images/Robot_moving_forward.png" src="../../../../_images/Robot_moving_forward.png" />
<p>此时，机器人能够盲目地按照您的电机指令行动。但是，当您命令它向前移动时，它最终会撞到墙上。</p>
<img alt="../../../../_images/Robot_colliding_wall.png" src="../../../../_images/Robot_colliding_wall.png" />
<p>关闭Webots窗口，这也会关闭从启动器启动的ROS节点。同时，在第二个终端中使用``Ctrl+C``关闭话题命令。</p>
</div>
</div>
<div class="section" id="summary">
<h2><a class="toc-backref" href="#id13">总结</a><a class="headerlink" href="#summary" title="永久链接至标题"></a></h2>
<p>在本教程中，您使用Webots设置了一个逼真的机器人仿真，并实现了一个自定义插件来控制机器人的电机。</p>
</div>
<div class="section" id="next-steps">
<h2><a class="toc-backref" href="#id14">下一步</a><a class="headerlink" href="#next-steps" title="永久链接至标题"></a></h2>
<p>为了改善仿真效果，可以使用机器人的传感器来检测障碍物并避开它们。教程的第二部分展示了如何实现这样的行为：</p>
<ul class="simple">
<li><p><a class="reference internal" href="Setting-Up-Simulation-Webots-Advanced.html"><span class="doc">设置机器人模拟（高级）</span></a>。</p></li>
</ul>
</div>
</div>

  <div id="footer">
    <p>欢迎帮助改进！</p>
  </div>
</body>
</html>