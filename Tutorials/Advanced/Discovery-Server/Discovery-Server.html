<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tutorials/Advanced/Discovery-Server/Discovery-Server</title>
</head>
<body>
  <div class="section" id="using-fast-dds-discovery-server-as-discovery-protocol-community-contributed">
<h1>使用Fast DDS Discovery Server作为发现协议[社区贡献]<a class="headerlink" href="#using-fast-dds-discovery-server-as-discovery-protocol-community-contributed" title="永久链接至标题"></a></h1>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a>目标：<a href="#id3"><span class="problematic" id="id4">**</span></a>本教程将展示如何使用**Fast DDS Discovery Server**发现协议来启动ROS 2节点。</p>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a>教程级别：<a href="#id3"><span class="problematic" id="id4">**</span></a>高级</p>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a>时间：<a href="#id3"><span class="problematic" id="id4">**</span></a>20分钟</p>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title">目录</p>
<ul class="simple">
<li><p><a class="reference internal" href="#background" id="id3">背景</a></p></li>
<li><p><a class="reference internal" href="#fast-dds-discovery-server-v2" id="id4">Fast DDS Discovery Server v2</a></p></li>
<li><p><a class="reference internal" href="#prerequisites" id="id5">先决条件</a></p></li>
<li><p><a class="reference internal" href="#run-this-tutorial" id="id6">运行本教程</a></p>
<ul>
<li><p><a class="reference internal" href="#setup-discovery-server" id="id7">设置发现服务器</a></p></li>
<li><p><a class="reference internal" href="#launch-listener-node" id="id8">启动监听节点</a></p></li>
<li><p><a class="reference internal" href="#launch-talker-node" id="id9">启动对话节点</a></p></li>
<li><p><a class="reference internal" href="#demonstrate-discovery-server-execution" id="id10">演示发现服务器的执行</a></p></li>
<li><p><a class="reference internal" href="#visualization-tool-rqt-graph" id="id11">可视化工具 <code class="docutils literal notranslate"><span class="pre">rqt_graph</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#advance-use-cases" id="id12">高级用例</a></p>
<ul>
<li><p><a class="reference internal" href="#server-redundancy" id="id13">服务器冗余</a></p></li>
<li><p><a class="reference internal" href="#backup-server" id="id14">备份服务器</a></p></li>
<li><p><a class="reference internal" href="#discovery-partitions" id="id15">发现分区</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#ros-2-introspection" id="id16">ROS 2内省</a></p>
<ul>
<li><p><a class="reference internal" href="#daemon-s-related-tools" id="id17">守护程序相关工具</a></p></li>
<li><p><a class="reference internal" href="#no-daemon-tools" id="id18">没有守护进程工具</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#compare-fast-dds-discovery-server-with-simple-discovery-protocol" id="id19">将Fast DDS Discovery Server与Simple Discovery Protocol进行比较</a></p></li>
</ul>
</div>
<div class="section" id="background">
<h2><a class="toc-backref" href="#id3">背景</a><a class="headerlink" href="#background" title="永久链接至标题"></a></h2>
<p>从ROS 2 Eloquent Elusor开始，<a href="#id1"><span class="problematic" id="id2">**</span></a>Fast DDS Discovery Server**协议是一种提供集中式动态发现机制的功能，与DDS默认使用的分布式机制相对。本教程将说明如何使用Fast DDS Discovery Server功能作为发现通信运行一些ROS 2示例。</p>
<p>为了获取有关可用发现配置的更多信息，请查看`以下文档&lt;<a class="reference external" href="https://fast-dds.docs.eprosima.com/en/v2.1.0/fastdds/discovery/discovery.html">https://fast-dds.docs.eprosima.com/en/v2.1.0/fastdds/discovery/discovery.html</a>&gt;`_或阅读`Fast DDS Discovery Server特定文档&lt;<a class="reference external" href="https://fast-dds.docs.eprosima.com/en/v2.1.0/fastdds/discovery/discovery_server.html#discovery-server">https://fast-dds.docs.eprosima.com/en/v2.1.0/fastdds/discovery/discovery_server.html#discovery-server</a>&gt;`__。</p>
<p><a href="#id1"><span class="problematic" id="id2">`</span></a>简单发现协议&lt;<a class="reference external" href="https://fast-dds.docs.eprosima.com/en/v2.1.0/fastdds/discovery/simple.html">https://fast-dds.docs.eprosima.com/en/v2.1.0/fastdds/discovery/simple.html</a>&gt;`__是DDS标准中定义的标准协议。然而，在某些场景中，它具有已知的缺点。</p>
<ul class="simple">
<li><p>随着新增节点数量的增加，它**不能有效地扩展**，因为交换的数据包数量显著增加。</p></li>
<li><p>在某些情况下，例如 WiFi，它需要具备可靠的**组播**功能。</p></li>
</ul>
<p>Fast DDS Discovery Server 提供了一种客户端-服务器架构，允许节点使用中间服务器互相连接。每个节点都作为一个*发现客户端*，与一个或多个*发现服务器*共享信息，并从中接收发现信息。这减少了与发现相关的网络流量，并且不需要组播功能。</p>
<img alt="../../../_images/ds_explanation.svg" class="align-center" src="../../../_images/ds_explanation.svg" /><p>这些发现服务器可以是独立的、复制的，或者彼此连接，以在网络上创建冗余并避免单点故障。</p>
</div>
<div class="section" id="fast-dds-discovery-server-v2">
<h2><a class="toc-backref" href="#id4">Fast DDS Discovery Server v2</a><a class="headerlink" href="#fast-dds-discovery-server-v2" title="永久链接至标题"></a></h2>
<p>最新的ROS 2 Foxy Fitzroy发布（2020年12月）包括了一个新版本，Fast DDS Discovery Server的第2版。这个版本包括一个新的过滤器功能，进一步减少了发送的发现消息数量。这个版本根据不同节点的主题来决定两个节点是否希望进行通信，或者它们是否可以不匹配（即不互相发现）。下图显示了发现消息数量的减少情况：</p>
<img alt="../../../_images/ds1vs2.svg" class="align-center" src="../../../_images/ds1vs2.svg" /><p>这种架构大大减少了服务器和客户端之间发送的消息数量。下图显示了在“RMF Clinic演示”（&lt;<a class="reference external" href="https://github.com/open-rmf/rmf_demos#Clinic-World">https://github.com/open-rmf/rmf_demos#Clinic-World</a>&gt;）的发现阶段中网络流量的减少：</p>
<img alt="../../../_images/discovery_server_v2_performance.svg" class="align-center" src="../../../_images/discovery_server_v2_performance.svg" /><p>为了使用这个功能，可以使用“XML配置参与者”（&lt;<a class="reference external" href="https://fast-dds.docs.eprosima.com/en/v2.1.0/fastdds/discovery/discovery_server.html#discovery-server">https://fast-dds.docs.eprosima.com/en/v2.1.0/fastdds/discovery/discovery_server.html#discovery-server</a>&gt;）来配置发现服务器。还可以使用“fastdds”工具（&lt;<a class="reference external" href="https://fast-dds.docs.eprosima.com/en/v2.1.0/fastddscli/cli/cli.html#discovery">https://fast-dds.docs.eprosima.com/en/v2.1.0/fastddscli/cli/cli.html#discovery</a>&gt;）和一个环境变量（&lt;<a class="reference external" href="https://fast-dds.docs.eprosima.com/en/v2.1.0/fastdds/env_vars/env_vars.html">https://fast-dds.docs.eprosima.com/en/v2.1.0/fastdds/env_vars/env_vars.html</a>&gt;）来配置发现服务器，在本教程中采用了这种方法。有关配置发现服务器的更详细说明，请访问“Fast DDS Discovery Server文档”（&lt;<a class="reference external" href="https://fast-dds.docs.eprosima.com/en/v2.1.0/fastdds/discovery/discovery_server.html#discovery-server">https://fast-dds.docs.eprosima.com/en/v2.1.0/fastdds/discovery/discovery_server.html#discovery-server</a>&gt;）。</p>
</div>
<div class="section" id="prerequisites">
<h2><a class="toc-backref" href="#id5">先决条件</a><a class="headerlink" href="#prerequisites" title="永久链接至标题"></a></h2>
<p>本教程假设您已经安装</p>
</div>
<div class="section" id="run-this-tutorial">
<h2><a class="toc-backref" href="#id6">运行本教程</a><a class="headerlink" href="#run-this-tutorial" title="永久链接至标题"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">talker-listener</span></code> ROS 2演示创建了一个``talker``节点，它每秒发布一条&quot;hello world&quot;消息，以及一个``listener``节点，它监听这些消息。</p>
<p>通过:doc:<a class="reference internal" href="../../Beginner-CLI-Tools/Configuring-ROS2-Environment.html"><span class="doc">配置ROS 2环境</span></a>，您将获得访问CLI工具``fastdds``的权限。该工具提供了访问`discovery工具 &lt;<a class="reference external" href="https://fast-dds.docs.eprosima.com/en/v2.1.0/fastddscli/cli/cli.html#discovery">https://fast-dds.docs.eprosima.com/en/v2.1.0/fastddscli/cli/cli.html#discovery</a>&gt;`__的功能，该工具可用于启动一个发现服务器。该服务器将管理连接到它的节点的发现过程。</p>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>在每个新打开的终端中，不要忘记:doc:<a class="reference internal" href="../../Beginner-CLI-Tools/Configuring-ROS2-Environment.html"><span class="doc">配置ROS 2环境</span></a>。</p>
</div>
<div class="section" id="setup-discovery-server">
<h3><a class="toc-backref" href="#id7">设置发现服务器</a><a class="headerlink" href="#setup-discovery-server" title="永久链接至标题"></a></h3>
<p>首先启动一个ID为0、端口为11811（默认端口）且监听所有可用接口的发现服务器。</p>
<p>打开一个新的终端并运行：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">fastdds discovery --server-id 0</span>
</pre></div>
</div>
</div>
<div class="section" id="launch-listener-node">
<h3><a class="toc-backref" href="#id8">启动监听节点</a><a class="headerlink" href="#launch-listener-node" title="永久链接至标题"></a></h3>
<p>执行监听器演示，以监听``/chatter``主题。</p>
<p>在一个新的终端中，将环境变量``ROS_DISCOVERY_SERVER``设置为发现服务器的位置。（不要忘记在每个新的终端中使用source命令加载ROS 2）</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export ROS_DISCOVERY_SERVER=127.0.0.1:11811</span>
</pre></div>
</div>
<p>启动监听器节点。使用参数``--remap __node:=listener_discovery_server``来更改节点在本教程中的名称。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 run demo_nodes_cpp listener --ros-args --remap __node:=listener_discovery_server</span>
</pre></div>
</div>
<p>这将创建一个ROS 2节点，该节点将自动为发现服务器创建一个客户端，并连接到之前创建的服务器进行发现，而不是使用组播。</p>
</div>
<div class="section" id="launch-talker-node">
<h3><a class="toc-backref" href="#id9">启动对话节点</a><a class="headerlink" href="#launch-talker-node" title="永久链接至标题"></a></h3>
<p>打开一个新的终端，并像之前一样设置``ROS_DISCOVERY_SERVER``环境变量，以便节点启动一个发现客户端。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export ROS_DISCOVERY_SERVER=127.0.0.1:11811</span>
<span class="go">ros2 run demo_nodes_cpp talker --ros-args --remap __node:=talker_discovery_server</span>
</pre></div>
</div>
<p>现在您应该看到对话节点发布&quot;hello world&quot;消息，以及监听器接收这些消息。</p>
</div>
<div class="section" id="demonstrate-discovery-server-execution">
<h3><a class="toc-backref" href="#id10">演示发现服务器的执行</a><a class="headerlink" href="#demonstrate-discovery-server-execution" title="永久链接至标题"></a></h3>
<p>到目前为止，没有证据表明这个示例和标准的说话者-监听者示例运行方式不同。为了明确证明这一点，在另一个未连接到发现服务器的节点上运行。在新的终端中运行一个新的监听者（默认监听``/chatter``话题），并检查它是否没有连接到已经在运行的说话者。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 run demo_nodes_cpp listener --ros-args --remap __node:=simple_listener</span>
</pre></div>
</div>
<p>新的监听者节点不应该接收到“hello world”消息。</p>
<p>为了最终验证一切是否正常运行，可以使用简单的发现协议（默认的DDS分布式发现机制）创建一个新的说话者进行发现。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ros2 run demo_nodes_cpp talker --ros-args --remap __node:=simple_talker</span>
</pre></div>
</div>
<p>现在，你应该看到``simple_listener``节点从``simple_talker``接收到“hello world”消息，但不会接收到来自``talker_discovery_server``的其他消息。</p>
</div>
<div class="section" id="visualization-tool-rqt-graph">
<h3><a class="toc-backref" href="#id11">可视化工具 <code class="docutils literal notranslate"><span class="pre">rqt_graph</span></code></a><a class="headerlink" href="#visualization-tool-rqt-graph" title="永久链接至标题"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">rqt_graph</span></code> 工具可用于验证此示例的节点和结构。请记住，为了使用 <code class="docutils literal notranslate"><span class="pre">rqt_graph</span></code> 与发现服务器协议（即查看 <code class="docutils literal notranslate"><span class="pre">listener_discovery_server</span></code> 和 <code class="docutils literal notranslate"><span class="pre">talker_discovery_server</span></code> 节点），在启动之前必须设置 <code class="docutils literal notranslate"><span class="pre">ROS_DISCOVERY_SERVER</span></code> 环境变量。</p>
</div>
</div>
<div class="section" id="advance-use-cases">
<h2><a class="toc-backref" href="#id12">高级用例</a><a class="headerlink" href="#advance-use-cases" title="永久链接至标题"></a></h2>
<p>以下部分展示了发现服务器的不同功能，使您能够在网络上构建一个强大的发现服务器。</p>
<div class="section" id="server-redundancy">
<h3><a class="toc-backref" href="#id13">服务器冗余</a><a class="headerlink" href="#server-redundancy" title="永久链接至标题"></a></h3>
<p>通过使用 <code class="docutils literal notranslate"><span class="pre">fastdds</span></code> 工具，可以创建多个发现服务器。发现客户端（ROS节点）可以连接到任意数量的服务器。这样可以构建一个冗余网络，即使某些服务器或节点意外关闭也能正常工作。下图显示了一个提供服务器冗余的简单架构。</p>
<img alt="../../../_images/ds_redundancy_example.svg" class="align-center" src="../../../_images/ds_redundancy_example.svg" /><p>在几个终端中运行以下代码与冗余服务器建立通信。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">fastdds discovery --server-id 0 --ip-address 127.0.0.1 --port 11811</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">fastdds discovery --server-id 1 --ip-address 127.0.0.1 --port 11888</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">--server-id</span> <span class="pre">N</span></code> 表示 ID 为 N 的服务器。在使用 <code class="docutils literal notranslate"><span class="pre">ROS_DISCOVERY_SERVER</span></code> 引用服务器时，服务器 <code class="docutils literal notranslate"><span class="pre">0</span></code> 必须排在第一位，服务器 <code class="docutils literal notranslate"><span class="pre">1</span></code> 排在第二位。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export ROS_DISCOVERY_SERVER=&quot;127.0.0.1:11811;127.0.0.1:11888&quot;</span>
<span class="go">ros2 run demo_nodes_cpp talker --ros-args --remap __node:=talker</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export ROS_DISCOVERY_SERVER=&quot;127.0.0.1:11811;127.0.0.1:11888&quot;</span>
<span class="go">ros2 run demo_nodes_cpp listener --ros-args --remap __node:=listener</span>
</pre></div>
</div>
<p>现在，如果其中一个服务器出现故障，仍然会有可用的发现功能，节点仍然可以相互发现。</p>
</div>
<div class="section" id="backup-server">
<h3><a class="toc-backref" href="#id14">备份服务器</a><a class="headerlink" href="#backup-server" title="永久链接至标题"></a></h3>
<p>Fast DDS发现服务器允许创建具备备份功能的服务器。这使得服务器能够在关闭情况下恢复到上次保存的状态。</p>
<img alt="../../../_images/ds_backup_example.svg" class="align-center" src="../../../_images/ds_backup_example.svg" /><p>在不同的终端中运行以下代码，与备份服务器建立通信。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">fastdds discovery --server-id 0 --ip-address 127.0.0.1 --port 11811 --backup</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export ROS_DISCOVERY_SERVER=&quot;127.0.0.1:11811&quot;</span>
<span class="go">ros2 run demo_nodes_cpp talker --ros-args --remap __node:=talker</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export ROS_DISCOVERY_SERVER=&quot;127.0.0.1:11811&quot;</span>
<span class="go">ros2 run demo_nodes_cpp listener --ros-args --remap __node:=listener</span>
</pre></div>
</div>
<p>在发现服务器的工作目录中（即启动该服务器的目录），创建了几个备份文件。这两个 <code class="docutils literal notranslate"><span class="pre">SQLite</span></code> 文件和两个 <code class="docutils literal notranslate"><span class="pre">json</span></code> 文件包含了启动新服务器和在发生故障时恢复失败服务器状态所需的信息，避免了需要再次进行发现过程，并且不会丢失信息。</p>
</div>
<div class="section" id="discovery-partitions">
<h3><a class="toc-backref" href="#id15">发现分区</a><a class="headerlink" href="#discovery-partitions" title="永久链接至标题"></a></h3>
<p>与发现服务器的通信可以分割，以在发现信息中创建虚拟分区。这意味着仅当两个端点之间存在共享的发现服务器或一组发现服务器时，它们才会彼此了解。我们将执行一个包含两个独立服务器的示例。下图显示了架构。</p>
<img alt="../../../_images/ds_partition_example.svg" class="align-center" src="../../../_images/ds_partition_example.svg" /><p>按照这个架构，<code class="docutils literal notranslate"><span class="pre">Listener</span> <span class="pre">1``将连接到``Talker</span> <span class="pre">1``和``Talker</span> <span class="pre">2</span></code>，因为它们共享``Server 1``。<code class="docutils literal notranslate"><span class="pre">Listener</span> <span class="pre">2``将连接到``Talker</span> <span class="pre">1</span></code>，因为它们共享``Server 2``。但是``Listener 2``将无法接收来自``Talker 2``的消息，因为它们不共享任何发现服务器，包括通过冗余发现服务器之间的连接间接共享的情况。</p>
<p>在本地主机上运行第一个服务器，使用默认端口号11811。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">fastdds discovery --server-id 0 --ip-address 127.0.0.1 --port 11811</span>
</pre></div>
</div>
<p>在另一个终端上运行第二个服务器，使用本地主机和另一个端口号，例如11888。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">fastdds discovery --server-id 1 --ip-address 127.0.0.1 --port 11888</span>
</pre></div>
</div>
<p>现在，在不同的终端上运行每个节点。使用``ROS_DISCOVERY_SERVER``环境变量来决定它们连接到哪个服务器。请注意，<a href="#id1"><span class="problematic" id="id2">`ids必须匹配&lt;https://fast-dds.docs.eprosima.com/en/v2.1.0/fastdds/env_vars/env_vars.html&gt;`__</span></a>。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export ROS_DISCOVERY_SERVER=&quot;127.0.0.1:11811;127.0.0.1:11888&quot;</span>
<span class="go">ros2 run demo_nodes_cpp talker --ros-args --remap __node:=talker_1</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export ROS_DISCOVERY_SERVER=&quot;127.0.0.1:11811;127.0.0.1:11888&quot;</span>
<span class="go">ros2 run demo_nodes_cpp listener --ros-args --remap __node:=listener_1</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export ROS_DISCOVERY_SERVER=&quot;127.0.0.1:11811&quot;</span>
<span class="go">ros2 run demo_nodes_cpp talker --ros-args --remap __node:=talker_2</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export ROS_DISCOVERY_SERVER=&quot;;127.0.0.1:11888&quot;</span>
<span class="go">ros2 run demo_nodes_cpp listener --ros-args --remap __node:=listener_2</span>
</pre></div>
</div>
<p>我们应该看到``Listener 1``从两个talker节点接收消息，而``Listener 2``与``Talker 2``处于不同的分区，因此不会接收来自它的消息。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>一旦两个端点（ROS节点）相互发现，它们在彼此之间不需要发现服务器网络来监听彼此的消息。</p>
</div>
</div>
</div>
<div class="section" id="ros-2-introspection">
<h2><a class="toc-backref" href="#id16">ROS 2内省</a><a class="headerlink" href="#ros-2-introspection" title="永久链接至标题"></a></h2>
<p><code class="xref any docutils literal notranslate"><span class="pre">ROS</span> <span class="pre">2命令行界面&lt;https://github.com/ros2/ros2cli&gt;`__支持多种内省工具，用于分析ROS</span> <span class="pre">2网络的行为。这些工具（例如``ros2</span> <span class="pre">bag</span> <span class="pre">record`</span></code>、<a href="#id1"><span class="problematic" id="id2">``</span></a>ros2 topic list``等）非常有助于理解ROS 2的工作网络。</p>
<p>大多数这些工具使用DDS简单发现机制与每个现有的参与者交换主题信息（使用简单发现，网络中的每个参与者彼此连接）。然而，新的Discovery Server v2实现了一种网络流量减少方案，限制了不共享主题的参与者之间的发现数据。这意味着只有当节点对该主题拥有写入者或读取者时，它才会接收到主题的发现数据。由于大多数ROS 2 CLIs需要一个节点在网络中（其中一些依赖于运行中的ROS 2守护程序，而一些则创建自己的节点），使用Discovery Server v2，这些节点将无法获取到所有的网络信息，因此它们的功能将受到限制。</p>
<p>Discovery Server v2功能允许每个参与者作为**超级客户端**（Super Client）运行，这是一种连接到**服务器**的**客户端**（Client），从服务器接收所有可用的发现信息（而不仅仅是它所需的）。在这个意义上，ROS 2内省工具可以被配置为**超级客户端**，因此能够发现网络中使用Discovery Server协议的每个实体。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>在本节中，我们使用术语*参与者*表示DDS实体。每个DDS <a href="#id1"><span class="problematic" id="id2">*</span></a>参与者*对应于ROS 2 <a href="#id3"><span class="problematic" id="id4">*</span></a>上下文*（Context），ROS 2是对DDS的抽象。<code class="xref any docutils literal notranslate"><span class="pre">节点（Nodes）&lt;ROS2Nodes&gt;`是依赖于DDS通信接口（``DataWriter``和``DataReader`</span></code>）的ROS 2实体。每个*参与者*可以持有多个ROS 2节点。有关这些概念的更多详细信息，请访问`节点到参与者映射设计文档&lt;<a class="reference external" href="http://design.ros2.org/articles/Node_to_Participant_mapping.html">http://design.ros2.org/articles/Node_to_Participant_mapping.html</a>&gt;`__。</p>
</div>
<div class="section" id="daemon-s-related-tools">
<h3><a class="toc-backref" href="#id17">守护程序相关工具</a><a class="headerlink" href="#daemon-s-related-tools" title="永久链接至标题"></a></h3>
<p>ROS 2守护程序在几个ROS 2 CLI内省工具中使用。它创建自己的参与者，将ROS 2节点添加到网络图中，以接收发送的所有数据。当使用Discovery Server机制时，为了使ROS 2 CLI正常工作，ROS 2守护程序需要配置为**超级客户端**。因此，本节旨在解释如何使用运行为**超级客户端**的ROS 2守护程序来使用ROS 2 CLI。这将允许守护程序发现整个节点图，并接收所有主题和端点信息。为此，使用Fast DDS XML配置文件来配置ROS 2守护程序和CLI工具。</p>
<p>在下面，您可以找到一个XML配置文件，对于本教程，它应该被保存在工作目录中，命名为```super_client_configuration_file.xml```。该文件将配置使用它的每个新参与者为**超级客户端**。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
 <span class="nt">&lt;dds&gt;</span>
     <span class="nt">&lt;profiles</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.eprosima.com/XMLSchemas/fastRTPS_Profiles&quot;</span><span class="nt">&gt;</span>
         <span class="nt">&lt;participant</span> <span class="na">profile_name=</span><span class="s">&quot;super_client_profile&quot;</span> <span class="na">is_default_profile=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
             <span class="nt">&lt;rtps&gt;</span>
                 <span class="nt">&lt;builtin&gt;</span>
                     <span class="nt">&lt;discovery_config&gt;</span>
                         <span class="nt">&lt;discoveryProtocol&gt;</span>SUPER_CLIENT<span class="nt">&lt;/discoveryProtocol&gt;</span>
                         <span class="nt">&lt;discoveryServersList&gt;</span>
                             <span class="nt">&lt;RemoteServer</span> <span class="na">prefix=</span><span class="s">&quot;44.53.00.5f.45.50.52.4f.53.49.4d.41&quot;</span><span class="nt">&gt;</span>
                                 <span class="nt">&lt;metatrafficUnicastLocatorList&gt;</span>
                                     <span class="nt">&lt;locator&gt;</span>
                                         <span class="nt">&lt;udpv4&gt;</span>
                                             <span class="nt">&lt;address&gt;</span>127.0.0.1<span class="nt">&lt;/address&gt;</span>
                                             <span class="nt">&lt;port&gt;</span>11811<span class="nt">&lt;/port&gt;</span>
                                         <span class="nt">&lt;/udpv4&gt;</span>
                                     <span class="nt">&lt;/locator&gt;</span>
                                 <span class="nt">&lt;/metatrafficUnicastLocatorList&gt;</span>
                             <span class="nt">&lt;/RemoteServer&gt;</span>
                         <span class="nt">&lt;/discoveryServersList&gt;</span>
                     <span class="nt">&lt;/discovery_config&gt;</span>
                 <span class="nt">&lt;/builtin&gt;</span>
             <span class="nt">&lt;/rtps&gt;</span>
         <span class="nt">&lt;/participant&gt;</span>
     <span class="nt">&lt;/profiles&gt;</span>
 <span class="nt">&lt;/dds&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>在*RemoteServer*标签下，<a href="#id1"><span class="problematic" id="id2">*</span></a>prefix*属性值应根据传递给CLI的服务器ID进行更新（请参阅`Fast DDS CLI &lt;<a class="reference external" href="https://fast-dds.docs.eprosima.com/en/latest/fastddscli/cli/cli.html#discovery">https://fast-dds.docs.eprosima.com/en/latest/fastddscli/cli/cli.html#discovery</a>&gt;`__）。在所示的XML片段中指定的值对应于值为0的ID。</p>
</div>
<p>首先，使用`Fast DDS CLI &lt;<a class="reference external" href="https://fast-dds.docs.eprosima.com/en/latest/fastddscli/cli/cli.html#discovery">https://fast-dds.docs.eprosima.com/en/latest/fastddscli/cli/cli.html#discovery</a>&gt;`__实例化一个Discovery Server，指定一个值为0的ID。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">fastdds discovery -i 0 -l 127.0.0.1 -p 11811</span>
</pre></div>
</div>
<p>运行一个talker和一个listener，它们将通过服务器相互发现（请注意，<a href="#id1"><span class="problematic" id="id2">``</span></a>ROS_DISCOVERY_SERVER``配置与``super_client_configuration_file.xml``中的配置相同）。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export ROS_DISCOVERY_SERVER=&quot;127.0.0.1:11811&quot;</span>
<span class="go">ros2 run demo_nodes_cpp listener --ros-args --remap __node:=listener</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export ROS_DISCOVERY_SERVER=&quot;127.0.0.1:11811&quot;</span>
<span class="go">ros2 run demo_nodes_cpp talker --ros-args --remap __node:=talker</span>
</pre></div>
</div>
<p>然后，使用**Super Client**配置实例化一个ROS 2 Daemon（记得在每个新终端中运行ROS 2安装文件）。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export FASTRTPS_DEFAULT_PROFILES_FILE=super_client_configuration_file.xml</span>
<span class="go">ros2 daemon stop</span>
<span class="go">ros2 daemon start</span>
<span class="go">ros2 topic list</span>
<span class="go">ros2 node info /talker</span>
<span class="go">ros2 topic info /chatter</span>
<span class="go">ros2 topic echo /chatter</span>
</pre></div>
</div>
<p>我们还可以使用ROS 2工具``rqt_graph``查看节点图，如下所示（你可能需要按下刷新按钮）：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export FASTRTPS_DEFAULT_PROFILES_FILE=super_client_configuration_file.xml</span>
<span class="go">rqt_graph</span>
</pre></div>
</div>
</div>
<div class="section" id="no-daemon-tools">
<h3><a class="toc-backref" href="#id18">没有守护进程工具</a><a class="headerlink" href="#no-daemon-tools" title="永久链接至标题"></a></h3>
<p>一些ROS 2 CLI工具不使用ROS 2守护进程。为了使这些工具能够与发现服务器连接并接收所有主题信息，它们需要被实例化为一个连接到**服务器**的**超级客户端**。</p>
<p>按照先前的配置，构建一个包含一个讲话者和一个监听者的简单系统。首先，运行一个**服务器**：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">fastdds discovery -i 0 -l 127.0.0.1 -p 11811</span>
</pre></div>
</div>
<p>然后，在不同的终端中运行讲话者和监听者：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export ROS_DISCOVERY_SERVER=&quot;127.0.0.1:11811&quot;</span>
<span class="go">ros2 run demo_nodes_cpp listener --ros-args --remap __node:=listener</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export ROS_DISCOVERY_SERVER=&quot;127.0.0.1:11811&quot;</span>
<span class="go">ros2 run demo_nodes_cpp talker --ros-args --remap __node:=talker</span>
</pre></div>
</div>
<p>继续使用带有``--no-daemon``选项的ROS 2 CLI和新配置。新节点将连接到现有的服务器并了解每个主题。不需要导出``ROS_DISCOVERY_SERVER``，因为ROS 2工具将通过``FASTRTPS_DEFAULT_PROFILES_FILE``进行配置。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export FASTRTPS_DEFAULT_PROFILES_FILE=super_client_configuration_file.xml</span>
<span class="go">ros2 topic list --no-daemon</span>
<span class="go">ros2 node info /talker --no-daemon --spin-time 2</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="compare-fast-dds-discovery-server-with-simple-discovery-protocol">
<h2><a class="toc-backref" href="#id19">将Fast DDS Discovery Server与Simple Discovery Protocol进行比较</a><a class="headerlink" href="#compare-fast-dds-discovery-server-with-simple-discovery-protocol" title="永久链接至标题"></a></h2>
<p>为了比较使用“Simple Discovery”协议（作为分布式发现的默认DDS机制）或“Discovery Server”的执行节点，提供了两个脚本来执行一个讲话者和多个侦听者，并在此期间分析网络流量。在进行此实验时，需要在您的系统上安装“tshark”。配置文件是强制性的，以避免使用进程内模式。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>这些脚本需要一个关闭发现服务器功能，该功能仅在ROS 2 Foxy提供的版本更新版本中可用。为了使用此功能，需使用Fast DDS v2.1.0或更高版本编译ROS 2。</p>
</div>
<p>这些脚本的功能是为高级用途提供参考，其研究留给用户自行完成。</p>
<ul class="simple">
<li><p><a class="reference download internal" download="" href="../../../_downloads/4091f7105a6c8d10b26927288ede29fc/generate_discovery_packages.bash"><code class="xref download docutils literal notranslate"><span class="pre">bash网络流量生成器</span></code></a></p></li>
<li><p><a class="reference download internal" download="" href="../../../_downloads/617a6849c029c43a931e24db314cb224/discovery_packets.py"><code class="xref download docutils literal notranslate"><span class="pre">python3图形生成器</span></code></a></p></li>
<li><p><a class="reference download internal" download="" href="../../../_downloads/358434c24ca02455545e1739688b839b/no_intraprocess_configuration.xml"><code class="xref download docutils literal notranslate"><span class="pre">XML配置文件</span></code></a></p></li>
</ul>
<p>使用路径``setup.bash``文件作为参数运行bash脚本，以源化ROS 2。这将生成用于简单发现的流量跟踪。使用第二个参数``SERVER``执行相同的脚本。它将生成使用发现服务器的跟踪。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>根据您的``tcpdump``配置，该脚本可能需要``sudo``特权以读取您的网络设备上的流量。</p>
</div>
<p>在两次执行完成后，运行Python脚本生成类似下面的图形。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">export</span> <span class="nv">FASTRTPS_DEFAULT_PROFILES_FILE</span><span class="o">=</span><span class="s2">&quot;no_intraprocess_configuration.xml&quot;</span>
<span class="gp">$ </span>sudo bash generate_discovery_packages.bash ~/ros2_foxy/install/local_setup.bash
<span class="gp">$ </span>sudo bash generate_discovery_packages.bash ~/ros2_foxy/install/local_setup.bash SERVER
<span class="gp">$ </span>python3 discovery_packets.py
</pre></div>
</div>
<img alt="../../../_images/discovery_packets.svg" class="align-center" src="../../../_images/discovery_packets.svg" /><p>这个图形是特定实验运行的结果。读者可以执行脚本并生成自己的结果进行比较。很容易看出，在使用发现服务时，网络流量减少了。</p>
<p>流量的减少是因为避免了每个节点宣告自己并等待网络中的每个其他节点的响应。在大型架构中，这会产生大量的流量。这种方法的减少量随节点数量增加而增加，使得这种架构比简单发现协议方法更具可扩展性。</p>
<p>新的Fast DDS Discovery Server v2自*Fast DDS* v2.0.2起可用，取代了旧的发现服务器。在这个新版本中，那些不共享主题的节点将自动不会相互发现，从而节省了连接它们及其端点所需的整个发现数据。上面的实验并未显示这种情况，但即使如此，由于ROS 2节点的隐藏基础设施主题，仍然可以看到大规模的流量显著减少。</p>
</div>
</div>

  <div id="footer">
    <p>欢迎帮助改进！</p>
  </div>
</body>
</html>