<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tutorials/Advanced/Security/Access-Controls</title>
</head>
<body>
  <div class="section" id="setting-access-controls">
<span id="access-controls"></span><h1>设置访问控制<a class="headerlink" href="#setting-access-controls" title="永久链接至标题"></a></h1>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a>目标：<a href="#id3"><span class="problematic" id="id4">**</span></a>限制节点可以使用的主题。</p>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a>教程级别：<a href="#id3"><span class="problematic" id="id4">**</span></a>高级</p>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a>时间：<a href="#id3"><span class="problematic" id="id4">**</span></a>20分钟</p>
<div class="contents local topic" id="contents">
<p class="topic-title">内容</p>
<ul class="simple">
<li><p><a class="reference internal" href="#background" id="id1">背景</a></p>
<ul>
<li><p><a class="reference internal" href="#modify-permissions-xml" id="id2">修改“permissions.xml”</a></p></li>
<li><p><a class="reference internal" href="#sign-the-policy-file" id="id3">签署策略文件</a></p></li>
<li><p><a class="reference internal" href="#launch-the-node" id="id4">启动节点</a></p></li>
<li><p><a class="reference internal" href="#use-the-templates" id="id5">使用模板</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="background">
<h2><a class="toc-backref" href="#id1">背景</a><a class="headerlink" href="#background" title="永久链接至标题"></a></h2>
<p>权限非常灵活，可用于控制ROS图中的许多行为。</p>
<p>对于本教程，我们演示了一种只允许在默认“chatter”主题上发布消息的策略。这将防止例如在启动监听器时重新映射主题或将相同的安全隔离用于其他目的。</p>
<p>为了执行此策略，在启动节点之前，我们需要更新“permissions.xml”文件并重新签名。可以通过手动修改权限文件或使用XML模板来完成此操作。</p>
<div class="section" id="modify-permissions-xml">
<h3><a class="toc-backref" href="#id2">修改“permissions.xml”</a><a class="headerlink" href="#modify-permissions-xml" title="永久链接至标题"></a></h3>
<p>首先，备份您的权限文件，并打开“permissions.xml”以进行编辑：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> ~/sros2_demo/demo_keys/enclaves/talker_listener/talker
mv permissions.p7s permissions.p7s~
mv permissions.xml permissions.xml~
vi permissions.xml
</pre></div>
</div>
<p>我们将修改``&lt;allow_rule&gt;``中的``&lt;publish&gt;``和``&lt;subscribe&gt;``。此XML文件中的主题使用DDS命名格式，而不是ROS名称。有关在ROS和DDS之间映射主题名称的详细信息，请参阅`Topic and Service Names设计文档 &lt;<a class="reference external" href="https://design.ros2.org/articles/topic_and_service_names.html#mapping-of-ros-2-topic-and-service-names-to-dds-concepts">https://design.ros2.org/articles/topic_and_service_names.html#mapping-of-ros-2-topic-and-service-names-to-dds-concepts</a>&gt;`_。</p>
<p>将以下XML内容粘贴到``permission.xml``中，保存文件并退出文本编辑器。这将显示``chatter``和``rosout`` ROS主题分别重命名为DDS的``rt/chatter``和``rt/rosout``主题：</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;dds</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xsi:noNamespaceSchemaLocation=</span><span class="s">&quot;http://www.omg.org/spec/DDS-SECURITY/20170901/omg_shared_ca_permissions.xsd&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;permissions&gt;</span>
    <span class="nt">&lt;grant</span> <span class="na">name=</span><span class="s">&quot;/talker_listener/talker&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;subject_name&gt;</span>CN=/talker_listener/talker<span class="nt">&lt;/subject_name&gt;</span>
      <span class="nt">&lt;validity&gt;</span>
        <span class="nt">&lt;not_before&gt;</span>2021-06-01T16:57:53<span class="nt">&lt;/not_before&gt;</span>
        <span class="nt">&lt;not_after&gt;</span>2031-05-31T16:57:53<span class="nt">&lt;/not_after&gt;</span>
      <span class="nt">&lt;/validity&gt;</span>
      <span class="nt">&lt;allow_rule&gt;</span>
        <span class="nt">&lt;domains&gt;</span>
          <span class="nt">&lt;id&gt;</span>0<span class="nt">&lt;/id&gt;</span>
        <span class="nt">&lt;/domains&gt;</span>
        <span class="nt">&lt;publish&gt;</span>
          <span class="nt">&lt;topics&gt;</span>
<span class="hll">            <span class="nt">&lt;topic&gt;</span>rt/chatter<span class="nt">&lt;/topic&gt;</span>
</span><span class="hll">            <span class="nt">&lt;topic&gt;</span>rt/rosout<span class="nt">&lt;/topic&gt;</span>
</span><span class="hll">            <span class="nt">&lt;topic&gt;</span>rt/parameter_events<span class="nt">&lt;/topic&gt;</span>
</span><span class="hll">            <span class="nt">&lt;topic&gt;</span>*/talker/*<span class="nt">&lt;/topic&gt;</span>
</span>          <span class="nt">&lt;/topics&gt;</span>
        <span class="nt">&lt;/publish&gt;</span>
        <span class="nt">&lt;subscribe&gt;</span>
          <span class="nt">&lt;topics&gt;</span>
<span class="hll">            <span class="nt">&lt;topic&gt;</span>rt/parameter_events<span class="nt">&lt;/topic&gt;</span>
</span><span class="hll">            <span class="nt">&lt;topic&gt;</span>*/talker/*<span class="nt">&lt;/topic&gt;</span>
</span>          <span class="nt">&lt;/topics&gt;</span>
        <span class="nt">&lt;/subscribe&gt;</span>
      <span class="nt">&lt;/allow_rule&gt;</span>
      <span class="nt">&lt;allow_rule&gt;</span>
        <span class="nt">&lt;domains&gt;</span>
          <span class="nt">&lt;id&gt;</span>0<span class="nt">&lt;/id&gt;</span>
        <span class="nt">&lt;/domains&gt;</span>
        <span class="nt">&lt;publish&gt;</span>
          <span class="nt">&lt;topics&gt;</span>
            <span class="nt">&lt;topic&gt;</span>ros_discovery_info<span class="nt">&lt;/topic&gt;</span>
          <span class="nt">&lt;/topics&gt;</span>
        <span class="nt">&lt;/publish&gt;</span>
        <span class="nt">&lt;subscribe&gt;</span>
          <span class="nt">&lt;topics&gt;</span>
            <span class="nt">&lt;topic&gt;</span>ros_discovery_info<span class="nt">&lt;/topic&gt;</span>
          <span class="nt">&lt;/topics&gt;</span>
        <span class="nt">&lt;/subscribe&gt;</span>
      <span class="nt">&lt;/allow_rule&gt;</span>
      <span class="nt">&lt;default&gt;</span>DENY<span class="nt">&lt;/default&gt;</span>
    <span class="nt">&lt;/grant&gt;</span>
  <span class="nt">&lt;/permissions&gt;</span>
<span class="nt">&lt;/dds&gt;</span>
</pre></div>
</div>
<p>此策略允许talker在``chatter``和``rosout``主题上进行发布。它还包括talker节点管理参数所需的发布和订阅权限（所有节点的要求）。与原始模板相比，发现权限保持不变。</p>
</div>
<div class="section" id="sign-the-policy-file">
<h3><a class="toc-backref" href="#id3">签署策略文件</a><a class="headerlink" href="#sign-the-policy-file" title="永久链接至标题"></a></h3>
<p>下一个命令从更新的XML文件 <code class="docutils literal notranslate"><span class="pre">permissions.xml</span></code> 创建新的S/MIME签名策略文件 <code class="docutils literal notranslate"><span class="pre">permissions.p7s</span></code>。该文件必须使用权限CA证书进行签名，<strong>这需要访问权限CA私钥</strong>。如果私钥已经受保护，根据您的安全计划可能需要额外的步骤来解锁和使用它。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>openssl smime -sign -text -in permissions.xml -out permissions.p7s <span class="se">\</span>
  --signer permissions_ca.cert.pem <span class="se">\</span>
  -inkey ~/sros2_demo/demo_keys/private/permissions_ca.key.pem
</pre></div>
</div>
</div>
<div class="section" id="launch-the-node">
<h3><a class="toc-backref" href="#id4">启动节点</a><a class="headerlink" href="#launch-the-node" title="永久链接至标题"></a></h3>
<p>在更新的权限设置生效后，我们可以使用之前教程中相同的命令成功启动节点：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2 run demo_nodes_cpp talker --ros-args --enclave /talker_listener/talker
</pre></div>
</div>
<p>但是，尝试重新映射 <code class="docutils literal notranslate"><span class="pre">chatter</span></code> 主题将阻止节点启动（请注意，这需要将 <code class="docutils literal notranslate"><span class="pre">ROS_SECURITY_STRATEGY</span></code> 设置为 <code class="docutils literal notranslate"><span class="pre">Enforce</span></code>）。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2 run demo_nodes_cpp talker --ros-args --enclave /talker_listener/talker <span class="se">\</span>
  --remap chatter:<span class="o">=</span>not_chatter
</pre></div>
</div>
</div>
<div class="section" id="use-the-templates">
<h3><a class="toc-backref" href="#id5">使用模板</a><a class="headerlink" href="#use-the-templates" title="永久链接至标题"></a></h3>
<p>安全策略很容易变得混乱，因此``sros2``工具添加了从模板创建策略的功能。可以通过使用``sros2``仓库中提供的`样例策略文件&lt;<a class="reference external" href="https://github.com/ros2/sros2/blob/humble/sros2/test/policies/sample.policy.xml#L1">https://github.com/ros2/sros2/blob/humble/sros2/test/policies/sample.policy.xml#L1</a>&gt;`_来实现。让我们为``talker``和``listener``创建一个策略，限制它们仅使用``chatter``主题。</p>
<p>首先下载包含样例策略文件的``sros2``仓库：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/ros2/sros2.git /tmp/sros2
</pre></div>
</div>
<p>然后使用``create_permission``命令，并指向样例策略文件以生成XML权限文件：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2 security create_permission demo_keystore <span class="se">\</span>
  /talker_listener/talker <span class="se">\</span>
  /tmp/sros2/sros2/test/policies/sample.policy.xml
ros2 security create_permission demo_keystore <span class="se">\</span>
  /talker_listener/listener <span class="se">\</span>
  /tmp/sros2/sros2/test/policies/sample.policy.xml
</pre></div>
</div>
<p>这些权限文件允许节点仅发布或订阅``chatter``主题，并启用参数所需的通信。</p>
<p>在一个启用了安全性的终端中，运行之前安全教程中的``talker``演示程序：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2 run demo_nodes_cpp talker --ros-args -e /talker_listener/talker
</pre></div>
</div>
<p>在另一个终端中，使用``listener``程序执行相同的操作：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2 run demo_nodes_py listener --ros-args -e /talker_listener/listener
</pre></div>
</div>
<p>此时，您的``talker``和``listener``节点将使用显式访问控制列表进行安全通信。然而，<a href="#id1"><span class="problematic" id="id2">``</span></a>listener``节点尝试订阅``chatter``以外的主题将失败：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2 run demo_nodes_py listener --ros-args --enclave /talker_listener/listener <span class="se">\</span>
  --remap chatter:<span class="o">=</span>not_chatter
</pre></div>
</div>
</div>
</div>
</div>

  <div id="footer">
    <p>欢迎帮助改进！</p>
  </div>
</body>
</html>