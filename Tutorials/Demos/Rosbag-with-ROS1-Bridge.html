<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tutorials/Demos/Rosbag-with-ROS1-Bridge</title>
</head>
<body>
  <div class="section" id="recording-and-playing-back-data-with-rosbag-using-the-ros-1-bridge">
<h1>使用ROS 1桥接在`rosbag`中记录和回放数据 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5238">[5238]</a><a class="headerlink" href="#recording-and-playing-back-data-with-rosbag-using-the-ros-1-bridge" title="永久链接至标题"></a></h1>
<p>本教程是“在ROS 1和ROS 2之间进行桥接通信”的后续教程，可以在此处找到：<a href="#id1"><span class="problematic" id="id2">`https://github.com/ros2/ros1_bridge/blob/master/README.md`__</span></a>，在下文中假设您已经完成了该教程。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5239">[5239]</a></p>
<p>对于这些示例，可以从 <a class="reference internal" href="../../How-To-Guides/Using-ros1_bridge-Jammy-upstream.html"><span class="doc">源代码</span></a> 构建ros1_bridge。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5240">[5240]</a></p>
<p>接下来是一系列额外的示例，类似于上述 <em>ROS 1和ROS 2之间的桥接通信</em> 演示中的示例。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5241">[5241]</a></p>
<div class="section" id="recording-topic-data-with-rosbag-and-ros-1-bridge">
<h2>使用rosbag和ROS 1 Bridge记录主题数据 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5242">[5242]</a><a class="headerlink" href="#recording-topic-data-with-rosbag-and-ros-1-bridge" title="永久链接至标题"></a></h2>
<p>在这个示例中，我们将使用ROS 2附带的``cam2image``演示程序和一个Python脚本来模拟一个简单的类似于turtlebot的机器人的传感器数据，以便我们可以将其桥接到ROS 1并使用rosbag进行记录。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5243">[5243]</a></p>
<p>首先，在新的终端窗口中运行ROS 1的``roscore``： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5244">[5244]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Shell A:</span>
. /opt/ros/kinetic/setup.bash
<span class="c1"># Or, on OSX, something like:</span>
<span class="c1"># . ~/ros_catkin_ws/install_isolated/setup.bash</span>
roscore
</pre></div>
</div>
<p>然后，在另一个终端窗口中运行ROS 1 &lt;=&gt; ROS 2的``dynamic_bridge``，使用``--bridge-all-topics``选项（这样我们可以执行``rostopic list``并查看它们）： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5245">[5245]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Shell B:</span>
. /opt/ros/kinetic/setup.bash
<span class="c1"># Or, on OSX, something like:</span>
<span class="c1"># . ~/ros_catkin_ws/install_isolated/setup.bash</span>
. /opt/ros/ardent/setup.bash
<span class="c1"># Or, if building ROS 2 from source:</span>
<span class="c1"># . &lt;workspace-with-bridge&gt;/install/setup.bash</span>
<span class="nb">export</span> <span class="nv">ROS_MASTER_URI</span><span class="o">=</span>http://localhost:11311
ros2 run ros1_bridge dynamic_bridge --bridge-all-topics
</pre></div>
</div>
<p>请记得将``&lt;workspace-with-bridge&gt;``替换为你提取ROS 2二进制文件的路径或者构建ROS 2源码的路径。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5246">[5246]</a></p>
<hr class="docutils" />
<p>现在我们可以启动模拟海龟机器人的ROS 2程序。首先，我们将使用``-b``选项运行``cam2image``程序，这样它就不需要相机就能工作： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5247">[5247]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Shell C:</span>
. /opt/ros/ardent/setup.bash
<span class="c1"># Or, if building ROS 2 from source:</span>
<span class="c1"># . &lt;workspace-with-bridge&gt;/install/setup.bash</span>
ros2 run image_tools cam2image -- -b
</pre></div>
</div>
<p>TODO: 使用命名空间的主题名 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5248">[5248]</a></p>
<p>然后，我们将运行一个简单的Python脚本来模拟Kobuki基座的``odom``和``imu_data``主题。我会使用更准确的``~sensors/imu_data``主题名来表示IMU数据，但是在ROS 2中还没有命名空间支持（即将推出！）。将这个脚本保存到一个名为``emulate_kobuki_node.py``的文件中： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5249">[5249]</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">rclpy</span>

<span class="kn">from</span> <span class="nn">nav_msgs.msg</span> <span class="kn">import</span> <span class="n">Odometry</span>
<span class="kn">from</span> <span class="nn">sensor_msgs.msg</span> <span class="kn">import</span> <span class="n">Imu</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>

    <span class="n">node</span> <span class="o">=</span> <span class="n">rclpy</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;emulate_kobuki_node&#39;</span><span class="p">)</span>

    <span class="n">imu_publisher</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span><span class="n">Imu</span><span class="p">,</span> <span class="s1">&#39;imu_data&#39;</span><span class="p">)</span>
    <span class="n">odom_publisher</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span><span class="n">Odometry</span><span class="p">,</span> <span class="s1">&#39;odom&#39;</span><span class="p">)</span>

    <span class="n">imu_msg</span> <span class="o">=</span> <span class="n">Imu</span><span class="p">()</span>
    <span class="n">odom_msg</span> <span class="o">=</span> <span class="n">Odometry</span><span class="p">()</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">%</span> <span class="mi">50</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">odom_msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stamp</span><span class="o">.</span><span class="n">sec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
            <span class="n">odom_msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stamp</span><span class="o">.</span><span class="n">nanosec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">now</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1000000000</span>
            <span class="n">odom_publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">odom_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">imu_msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stamp</span><span class="o">.</span><span class="n">sec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
            <span class="n">imu_msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stamp</span><span class="o">.</span><span class="n">nanosec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">now</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1000000000</span>
            <span class="n">imu_publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">imu_msg</span><span class="p">)</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
<p>你可以在一个新的ROS 2终端中运行这个Python脚本： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5250">[5250]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Shell D:</span>
. /opt/ros/ardent/setup.bash
<span class="c1"># Or, if building ROS 2 from source:</span>
<span class="c1"># . &lt;workspace-with-bridge&gt;/install/setup.bash</span>
python3 emulate_kobuki_node.py
</pre></div>
</div>
<hr class="docutils" />
<p>现在，所有的数据源和动态桥接都在运行，我们可以在一个新的ROS 1终端中查看可用的主题： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5251">[5251]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Shell E:</span>
. /opt/ros/kinetic/setup.bash
<span class="c1"># Or, on OSX, something like:</span>
<span class="c1"># . ~/ros_catkin_ws/install_isolated/setup.bash</span>
rostopic list
</pre></div>
</div>
<p>你应该看到类似这样的内容： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5072">[5072]</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">rostopic</span> <span class="nb">list</span>
<span class="o">/</span><span class="n">image</span>
<span class="o">/</span><span class="n">imu_data</span>
<span class="o">/</span><span class="n">odom</span>
<span class="o">/</span><span class="n">rosout</span>
<span class="o">/</span><span class="n">rosout_agg</span>
</pre></div>
</div>
<p>我们现在可以在同一个终端中使用``rosbag record``记录这些数据： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5252">[5252]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Shell E:</span>
rosbag record /image /imu_data /odom
</pre></div>
</div>
<p>几秒钟后，您可以使用``Ctrl-c``停止``rosbag``命令，并使用``ls -lh``查看文件的大小，您可能会看到类似以下内容： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5253">[5253]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>% ls -lh
total <span class="m">0</span>
-rw-rw-r-- <span class="m">1</span> william william  12M Feb <span class="m">23</span> <span class="m">16</span>:59 <span class="m">2017</span>-02-23-16-59-47.bag
</pre></div>
</div>
<p>尽管您的包文件名将不同（因为它是从日期和时间派生的）。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5254">[5254]</a></p>
</div>
<div class="section" id="playing-back-topic-data-with-rosbag-and-ros-1-bridge">
<h2>使用rosbag和ROS 1 Bridge播放主题数据 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5255">[5255]</a><a class="headerlink" href="#playing-back-topic-data-with-rosbag-and-ros-1-bridge" title="永久链接至标题"></a></h2>
<p>现在，我们有了一个包文件，您可以使用任何ROS 1工具来检查包文件，例如``rosbag info &lt;包文件&gt;``, <code class="docutils literal notranslate"><span class="pre">rostopic</span> <span class="pre">list</span> <span class="pre">-b</span> <span class="pre">&lt;包文件&gt;</span></code>, 或``rqt_bag &lt;包文件&gt;``。然而，我们也可以使用``rosbag play``和ROS 1 &lt;=&gt; ROS 2 <a href="#id1"><span class="problematic" id="id2">``</span></a>dynamic_bridge``将包数据回放到ROS 2中。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5256">[5256]</a></p>
<p>首先关闭您为上一个教程打开的所有终端，并停止任何正在运行的程序。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5257">[5257]</a></p>
<p>然后在新的终端中启动 <code class="docutils literal notranslate"><span class="pre">roscore</span></code>: <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5258">[5258]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Shell P:</span>
. /opt/ros/kinetic/setup.bash
<span class="c1"># Or, on OSX, something like:</span>
<span class="c1"># . ~/ros_catkin_ws/install_isolated/setup.bash</span>
roscore
</pre></div>
</div>
<p>然后在另一个终端中运行 <code class="docutils literal notranslate"><span class="pre">dynamic_bridge</span></code>: <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5259">[5259]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Shell Q:</span>
. /opt/ros/kinetic/setup.bash
<span class="c1"># Or, on OSX, something like:</span>
<span class="c1"># . ~/ros_catkin_ws/install_isolated/setup.bash</span>
. /opt/ros/ardent/setup.bash
<span class="c1"># Or, if building ROS 2 from source:</span>
<span class="c1"># . &lt;workspace-with-bridge&gt;/install/setup.bash</span>
<span class="nb">export</span> <span class="nv">ROS_MASTER_URI</span><span class="o">=</span>http://localhost:11311
ros2 run ros1_bridge dynamic_bridge --bridge-all-topics
</pre></div>
</div>
<p>然后在另一个新的终端中使用 <code class="docutils literal notranslate"><span class="pre">rosbag</span> <span class="pre">play</span></code> 播放包数据，使用 <code class="docutils literal notranslate"><span class="pre">--loop</span></code> 选项，这样我们就不必为短包文件不断重新启动它: <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5260">[5260]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Shell R:</span>
. /opt/ros/kinetic/setup.bash
<span class="c1"># Or, on OSX, something like:</span>
<span class="c1"># . ~/ros_catkin_ws/install_isolated/setup.bash</span>
rosbag play --loop path/to/bag_file
</pre></div>
</div>
<p>请确保将 <code class="docutils literal notranslate"><span class="pre">path/to/bag_file</span></code> 替换为您要播放的包文件的路径。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5261">[5261]</a></p>
<hr class="docutils" />
<p>现在数据正在回放，桥接程序正在运行，我们可以在ROS 2中看到数据传输过来。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5262">[5262]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Shell S:</span>
. /opt/ros/ardent/setup.bash
<span class="c1"># Or, if building ROS 2 from source:</span>
<span class="c1"># . &lt;workspace-with-bridge&gt;/install/setup.bash</span>
ros2 topic list
ros2 topic <span class="nb">echo</span> /odom
</pre></div>
</div>
<p>您应该会看到类似以下的内容: <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5263">[5263]</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">ros2</span> <span class="n">topic</span> <span class="nb">list</span>
<span class="o">/</span><span class="n">clock</span>
<span class="o">/</span><span class="n">image</span>
<span class="o">/</span><span class="n">imu_data</span>
<span class="o">/</span><span class="n">odom</span>
<span class="o">/</span><span class="n">parameter_events</span>
</pre></div>
</div>
<p>您还可以使用``showimage``工具查看从包中播放的图像： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=5264">[5264]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2 run image_tools showimage
</pre></div>
</div>
</div>
</div>

  <div id="footer">
    <p>欢迎帮助改进！</p>
  </div>
</body>
</html>