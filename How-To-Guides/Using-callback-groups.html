<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>How-To-Guides/Using-callback-groups</title>
</head>
<body>
  <div class="section" id="using-callback-groups">
<h1>使用回调组<a class="headerlink" href="#using-callback-groups" title="永久链接至标题"></a></h1>
<p>在多线程执行器中运行节点时，ROS 2 提供了回调组作为控制不同回调执行的工具。本页面旨在指导如何高效使用回调组。假设读者对 <a class="reference internal" href="../Concepts/About-Executors.html"><span class="doc">执行器</span></a> 的概念有基本了解。</p>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title">目录</p>
<ul class="simple">
<li><p><a class="reference internal" href="#basics-of-callback-groups" id="id1">回调组的基础知识</a></p>
<ul>
<li><p><a class="reference internal" href="#about-callbacks" id="id2">关于回调</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#controlling-execution" id="id3">控制执行</a></p></li>
<li><p><a class="reference internal" href="#avoiding-deadlocks" id="id4">避免死锁</a></p></li>
<li><p><a class="reference internal" href="#examples" id="id5">示例</a></p>
<ul>
<li><p><a class="reference internal" href="#demo-code" id="id6">演示代码</a></p></li>
<li><p><a class="reference internal" href="#the-problem" id="id7">问题</a></p></li>
<li><p><a class="reference internal" href="#solution" id="id8">解决方案</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="basics-of-callback-groups">
<h2><a class="toc-backref" href="#id1">回调组的基础知识</a><a class="headerlink" href="#basics-of-callback-groups" title="永久链接至标题"></a></h2>
<p>在使用多线程执行器（Multi-Threaded Executor）运行节点时，ROS 2 提供了两种不同类型的回调组（callback groups）来控制回调函数的执行：</p>
<ul class="simple">
<li><p>互斥回调组（Mutually Exclusive Callback Group）</p></li>
<li><p>可重入回调组（Reentrant Callback Group）</p></li>
</ul>
<p>这些回调组以不同的方式限制其回调函数的执行。简而言之</p>
<ul class="simple">
<li><p>互斥回调组阻止其回调并行执行 - 实际上使得回调组中的回调像由单线程执行器执行一样。</p></li>
<li><p>可重入回调组允许执行器按照任意方式调度和执行组中的回调，没有任何限制。这意味着，除了不同的回调之间可以并行运行外，同一个回调的不同实例也可以同时执行。</p></li>
<li><p>属于不同回调组（任何类型）的回调始终可以并行执行。</p></li>
</ul>
<p>还要注意的是，不同的ROS 2实体将其回调组传递给它们生成的所有回调。例如，如果将回调组分配给一个动作客户端，客户端创建的所有回调都将分配给该回调组。</p>
<p>回调组可以通过节点的 <code class="docutils literal notranslate"><span class="pre">create_callback_group</span></code> 函数在 rclcpp 中创建，并通过在 rclpy 中调用组的构造函数进行创建。当创建订阅、定时器等时，可以将回调组作为参数/选项进行传递。</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-Qysr" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-Qysr" name="Qysr" role="tab" tabindex="0">C++</button><button aria-controls="panel-0-UHl0aG9u" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="-1">Python</button></div><div aria-labelledby="tab-0-Qysr" class="sphinx-tabs-panel group-tab" id="panel-0-Qysr" name="Qysr" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">my_callback_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_callback_group</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">CallbackGroupType</span><span class="o">::</span><span class="n">MutuallyExclusive</span><span class="p">);</span><span class="w"></span>

<span class="n">rclcpp</span><span class="o">::</span><span class="n">SubscriptionOptions</span><span class="w"> </span><span class="n">options</span><span class="p">;</span><span class="w"></span>
<span class="n">options</span><span class="p">.</span><span class="n">callback_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">my_callback_group</span><span class="p">;</span><span class="w"></span>

<span class="n">my_subscription</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_subscription</span><span class="o">&lt;</span><span class="n">Int32</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;/topic&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">SensorDataQoS</span><span class="p">(),</span><span class="w"></span>
<span class="w">                                              </span><span class="n">callback</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-UHl0aG9u" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_callback_group</span> <span class="o">=</span> <span class="n">MutuallyExclusiveCallbackGroup</span><span class="p">()</span>
<span class="n">my_subscription</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span><span class="n">Int32</span><span class="p">,</span> <span class="s2">&quot;/topic&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">,</span> <span class="n">qos_profile</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                            <span class="n">callback_group</span><span class="o">=</span><span class="n">my_callback_group</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<p>如果用户在创建订阅、定时器等时未指定任何回调组，则该实体将被分配给节点的默认回调组。默认回调组是一个互斥回调组，可以通过 <code class="docutils literal notranslate"><span class="pre">NodeBaseInterface::get_default_callback_group()</span></code> 在 rclcpp 中查询，并通过 <code class="docutils literal notranslate"><span class="pre">Node.default_callback_group</span></code> 在 rclpy 中查询。</p>
<div class="section" id="about-callbacks">
<h3><a class="toc-backref" href="#id2">关于回调</a><a class="headerlink" href="#about-callbacks" title="永久链接至标题"></a></h3>
<p>在 ROS 2 和执行器的上下文中，回调是指由执行器处理调度和执行的函数。在这个上下文中，回调的例子有：</p>
<ul class="simple">
<li><p>订阅回调（从主题接收和处理数据），</p></li>
<li><p>定时器回调，</p></li>
<li><p>服务回调（用于在服务器中执行服务请求），</p></li>
<li><p>动作服务器和客户端中的不同回调，</p></li>
<li><p>Futures的完成回调。</p></li>
</ul>
<p>以下是在使用回调组时需要记住的一些重要要点。</p>
<ul class="simple">
<li><p>在ROS 2中，几乎所有的东西都是回调！每个由执行器运行的函数都是回调的定义。在ROS 2系统中，非回调函数主要位于系统的边缘（用户和传感器输入等）。</p></li>
<li><p>有时，回调是隐藏的，从用户/开发者API来看可能并不明显。这尤其适用于对服务或操作进行任何类型的“同步”调用（在rclpy中）。例如，对服务进行同步调用``Client.call(request)``会添加一个Future的完成回调，该回调需要在函数调用期间执行，但此回调对用户来说不直接可见。</p></li>
</ul>
</div>
</div>
<div class="section" id="controlling-execution">
<h2><a class="toc-backref" href="#id3">控制执行</a><a class="headerlink" href="#controlling-execution" title="永久链接至标题"></a></h2>
<p>为了使用回调组来控制执行，可以考虑以下准则。</p>
<p>对于一个回调函数与其自身的交互：</p>
<ul class="simple">
<li><p>如果希望它能够与自身并行执行，将其注册到一个可重入回调组中。例如，一个需要能够并行处理多个动作调用的动作/服务服务器。</p></li>
<li><p>如果它**永远不应**与自身并行执行，请将其注册到一个互斥回调组中。一个示例情况可能是一个定时器回调，它运行一个控制循环以发布控制命令。</p></li>
</ul>
<p>对于不同回调之间的相互作用：</p>
<ul class="simple">
<li><p>如果它们**永远不应**并行执行，请将它们注册到同一个互斥回调组中。一个示例情况可能是这些回调正在访问共享的关键资源和非线程安全资源。</p></li>
</ul>
<p>如果它们应该并行执行，根据个别回调是否可以重叠，您有两个选择：</p>
<ul class="simple">
<li><p>将它们注册到不同的互斥回调组（个别回调之间不重叠）</p></li>
<li><p>将它们注册到可重入回调组（个别回调之间有重叠）</p></li>
</ul>
<p>并行运行不同回调函数的一个示例情况是一个具有同步服务客户端和定时器调用该服务的节点。请参考下面的详细示例。</p>
</div>
<div class="section" id="avoiding-deadlocks">
<h2><a class="toc-backref" href="#id4">避免死锁</a><a class="headerlink" href="#avoiding-deadlocks" title="永久链接至标题"></a></h2>
<p>设置节点的回调组不正确可能会导致死锁（或其他不希望的行为），特别是如果希望在回调中使用同步调用服务或动作。事实上，ROS 2 的 API 文档甚至提到在回调中不应该进行同步调用动作或服务，因为这可能会导致死锁。虽然在这方面使用异步调用确实更安全，但同步调用也可以正常工作。另一方面，同步调用也有其优点，例如使代码更简单易懂。因此，本节提供了一些关于如何正确设置节点的回调组以避免死锁的指南。</p>
<p>这里需要注意的第一点是，每个节点的默认回调组是互斥的回调组（Mutually Exclusive Callback Group）。如果用户在创建定时器、订阅、客户端等时没有指定其他回调组，那么这些实体创建的任何回调都将使用节点的默认回调组。此外，如果节点中的所有内容都使用相同的互斥回调组，即使指定了多线程执行器，该节点实际上也会像单线程执行器一样处理！因此，当决定使用多线程执行器时，应始终指定一个或多个回调组，以使执行器的选择有意义。</p>
<p>在上述内容的基础上，以下是一些指南，可帮助避免死锁：</p>
<ul class="simple">
<li><p>如果在任何类型的回调中进行同步调用，该回调和进行调用的客户端需要属于</p>
<ul>
<li><p>不同的回调组（任意类型），或者</p></li>
<li><p>一个可重入回调组。</p></li>
</ul>
</li>
<li><p>如果由于其他要求（如线程安全和/或在等待结果时阻塞其他回调）而无法满足上述配置要求，或者您希望确保绝对不会发生死锁的可能性，请使用异步调用。</p></li>
</ul>
<p>不满足第一个要点将始终导致死锁。这种情况的一个示例是在定时器回调中进行同步服务调用（请参阅下一节的示例）。</p>
</div>
<div class="section" id="examples">
<h2><a class="toc-backref" href="#id5">示例</a><a class="headerlink" href="#examples" title="永久链接至标题"></a></h2>
<p>让我们来看一些不同回调组设置的简单示例。下面的演示代码考虑在计时器回调中同步调用一个服务。</p>
<div class="section" id="demo-code">
<h3><a class="toc-backref" href="#id6">演示代码</a><a class="headerlink" href="#demo-code" title="永久链接至标题"></a></h3>
<p>我们有两个节点 - 一个提供简单服务：</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-Qysr" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-1-Qysr" name="Qysr" role="tab" tabindex="0">C++</button><button aria-controls="panel-1-UHl0aG9u" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-1-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="-1">Python</button></div><div aria-labelledby="tab-1-Qysr" class="sphinx-tabs-panel group-tab" id="panel-1-Qysr" name="Qysr" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rclcpp/rclcpp.hpp&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;std_srvs/srv/empty.hpp&quot;</span><span class="cp"></span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">std</span><span class="o">::</span><span class="nn">placeholders</span><span class="p">;</span><span class="w"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">cb_group_demo</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">ServiceNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">ServiceNode</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="s">&quot;service_node&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">service_ptr_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">create_service</span><span class="o">&lt;</span><span class="n">std_srvs</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">Empty</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="s">&quot;test_service&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ServiceNode</span><span class="o">::</span><span class="n">service_callback</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">_1</span><span class="p">,</span><span class="w"> </span><span class="n">_2</span><span class="p">,</span><span class="w"> </span><span class="n">_3</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Service</span><span class="o">&lt;</span><span class="n">std_srvs</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">Empty</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">service_ptr_</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">service_callback</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">rmw_request_id_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">request_header</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">std_srvs</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">Empty</span><span class="o">::</span><span class="n">Request</span><span class="o">&gt;</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">std_srvs</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">Empty</span><span class="o">::</span><span class="n">Response</span><span class="o">&gt;</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">request_header</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">request</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">response</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Received request, responding...&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w">  </span><span class="c1">// class ServiceNode</span>
<span class="p">}</span><span class="w">   </span><span class="c1">// namespace cb_group_demo</span>

<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">service_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">cb_group_demo</span><span class="o">::</span><span class="n">ServiceNode</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">service_node</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Starting server node, shut down with CTRL-C&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">spin</span><span class="p">(</span><span class="n">service_node</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">service_node</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Keyboard interrupt, shutting down.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-UHl0aG9u" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-1-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">rclpy</span>
<span class="kn">from</span> <span class="nn">rclpy.node</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="nn">std_srvs.srv</span> <span class="kn">import</span> <span class="n">Empty</span>

<span class="k">class</span> <span class="nc">ServiceNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;service_node&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">srv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_service</span><span class="p">(</span><span class="n">Empty</span><span class="p">,</span> <span class="s1">&#39;test_service&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">service_callback</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">service_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Received request, responding...&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">ServiceNode</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">node</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting server node, shut down with CTRL-C&quot;</span><span class="p">)</span>
        <span class="n">rclpy</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">node</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Keyboard interrupt, shutting down.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">node</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</pre></div>
</div>
</div></div>
<p>另一个包含一个客户端和一个用于进行服务调用的计时器：</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-Qysr" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-2-Qysr" name="Qysr" role="tab" tabindex="0">C++</button><button aria-controls="panel-2-UHl0aG9u" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-2-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="-1">Python</button></div><div aria-labelledby="tab-2-Qysr" class="sphinx-tabs-panel group-tab" id="panel-2-Qysr" name="Qysr" role="tabpanel" tabindex="0"><p><em>注意:</em> rclcpp 中的服务客户端 API 不提供类似于 rclpy 中的同步调用方法，因此我们等待 future 对象来模拟同步调用的效果。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;chrono&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rclcpp/rclcpp.hpp&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;std_srvs/srv/empty.hpp&quot;</span><span class="cp"></span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">std</span><span class="o">::</span><span class="nn">chrono_literals</span><span class="p">;</span><span class="w"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">cb_group_demo</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">DemoNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">DemoNode</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="s">&quot;client_node&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">client_cb_group_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">timer_cb_group_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">client_ptr_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">create_client</span><span class="o">&lt;</span><span class="n">std_srvs</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">Empty</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;test_service&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rmw_qos_profile_services_default</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                                </span><span class="n">client_cb_group_</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">timer_ptr_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">create_wall_timer</span><span class="p">(</span><span class="mi">1</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DemoNode</span><span class="o">::</span><span class="n">timer_callback</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">),</span><span class="w"></span>
<span class="w">                                            </span><span class="n">timer_cb_group_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">CallbackGroup</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">client_cb_group_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">CallbackGroup</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">timer_cb_group_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Client</span><span class="o">&lt;</span><span class="n">std_srvs</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">Empty</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">client_ptr_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">TimerBase</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">timer_ptr_</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">timer_callback</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Sending request&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">std_srvs</span><span class="o">::</span><span class="n">srv</span><span class="o">::</span><span class="n">Empty</span><span class="o">::</span><span class="n">Request</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">result_future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client_ptr_</span><span class="o">-&gt;</span><span class="n">async_send_request</span><span class="p">(</span><span class="n">request</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">future_status</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result_future</span><span class="p">.</span><span class="n">wait_for</span><span class="p">(</span><span class="mi">10</span><span class="n">s</span><span class="p">);</span><span class="w">  </span><span class="c1">// timeout to guarantee a graceful finish</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">future_status</span><span class="o">::</span><span class="n">ready</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Received response&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w">  </span><span class="c1">// class DemoNode</span>
<span class="p">}</span><span class="w">   </span><span class="c1">// namespace cb_group_demo</span>

<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">client_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">cb_group_demo</span><span class="o">::</span><span class="n">DemoNode</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">executors</span><span class="o">::</span><span class="n">MultiThreadedExecutor</span><span class="w"> </span><span class="n">executor</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">executor</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">client_node</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">client_node</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Starting client node, shut down with CTRL-C&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">executor</span><span class="p">.</span><span class="n">spin</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">client_node</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Keyboard interrupt, shutting down.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">shutdown</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-UHl0aG9u" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-2-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">rclpy</span>
<span class="kn">from</span> <span class="nn">rclpy.executors</span> <span class="kn">import</span> <span class="n">MultiThreadedExecutor</span>
<span class="kn">from</span> <span class="nn">rclpy.callback_groups</span> <span class="kn">import</span> <span class="n">MutuallyExclusiveCallbackGroup</span><span class="p">,</span> <span class="n">ReentrantCallbackGroup</span>
<span class="kn">from</span> <span class="nn">rclpy.node</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="nn">std_srvs.srv</span> <span class="kn">import</span> <span class="n">Empty</span>


<span class="k">class</span> <span class="nc">CallbackGroupDemo</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;client_node&#39;</span><span class="p">)</span>

        <span class="n">client_cb_group</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">timer_cb_group</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_client</span><span class="p">(</span><span class="n">Empty</span><span class="p">,</span> <span class="s1">&#39;test_service&#39;</span><span class="p">,</span> <span class="n">callback_group</span><span class="o">=</span><span class="n">client_cb_group</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer_cb</span><span class="p">,</span> <span class="n">callback_group</span><span class="o">=</span><span class="n">timer_cb_group</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_timer_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Sending request&#39;</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">Empty</span><span class="o">.</span><span class="n">Request</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Received response&#39;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">CallbackGroupDemo</span><span class="p">()</span>
    <span class="n">executor</span> <span class="o">=</span> <span class="n">MultiThreadedExecutor</span><span class="p">()</span>
    <span class="n">executor</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">node</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Beginning client, shut down with CTRL-C&#39;</span><span class="p">)</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">spin</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">node</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Keyboard interrupt, shutting down.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">node</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">()</span>
    <span class="n">rclpy</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</pre></div>
</div>
</div></div>
<p>客户端节点的构造函数包含设置服务客户端和定时器的回调组的选项。在上述默认设置中（都为 <code class="docutils literal notranslate"><span class="pre">nullptr</span></code> / <code class="docutils literal notranslate"><span class="pre">None</span></code>），定时器和客户端都将使用节点的默认互斥回调组。</p>
</div>
<div class="section" id="the-problem">
<h3><a class="toc-backref" href="#id7">问题</a><a class="headerlink" href="#the-problem" title="永久链接至标题"></a></h3>
<p>由于我们使用 1 秒定时器进行服务调用，预期的结果是服务每秒调用一次，客户端始终收到响应并打印 <code class="docutils literal notranslate"><span class="pre">Received</span> <span class="pre">response</span></code>。如果我们尝试在终端中运行服务器和客户端节点，则会得到以下输出。</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-Q2xpZW50" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-3-Q2xpZW50" name="Q2xpZW50" role="tab" tabindex="0">Client</button><button aria-controls="panel-3-U2VydmVy" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-3-U2VydmVy" name="U2VydmVy" role="tab" tabindex="-1">Server</button></div><div aria-labelledby="tab-3-Q2xpZW50" class="sphinx-tabs-panel group-tab" id="panel-3-Q2xpZW50" name="Q2xpZW50" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">[INFO] [1653034371.758739131] [client_node]: Starting client node, shut down with CTRL-C</span>
<span class="go">[INFO] [1653034372.755865649] [client_node]: Sending request</span>
<span class="go">^C[INFO] [1653034398.161674869] [client_node]: Keyboard interrupt, shutting down.</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-3-U2VydmVy" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-3-U2VydmVy" name="U2VydmVy" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">[INFO] [1653034355.308958238] [service_node]: Starting server node, shut down with CTRL-C</span>
<span class="go">[INFO] [1653034372.758197320] [service_node]: Received request, responding...</span>
<span class="go">^C[INFO] [1653034416.021962246] [service_node]: Keyboard interrupt, shutting down.</span>
</pre></div>
</div>
</div></div>
<p>所以，事实证明，服务被反复调用，但是第一次调用的响应从未接收到，之后客户端节点似乎陷入了困境，并且不再进行进一步的调用。也就是说，执行在一个僵局中停止了！</p>
<p>导致这种情况的原因是计时器回调和客户端使用了相同的互斥回调组（节点的默认组）。当进行服务调用时，客户端将其回调组传递给了Future对象（在Python版本中隐藏在调用方法内部），而该回调需要执行以便使服务调用的结果可用。但是，由于该回调和计时器回调位于相同的互斥组中，并且计时器回调仍在执行（等待服务调用的结果），因此该回调永远不会执行。卡住的计时器回调还会阻止它本身的任何其他执行，因此计时器不会第二次触发。</p>
</div>
<div class="section" id="solution">
<h3><a class="toc-backref" href="#id8">解决方案</a><a class="headerlink" href="#solution" title="永久链接至标题"></a></h3>
<p>我们可以很容易地解决这个问题 - 例如 - 通过将定时器和客户端分配给不同的回调组。因此，让我们将客户端节点构造函数的前两行更改为如下（其他所有内容保持不变）：</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-Qysr" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-4-Qysr" name="Qysr" role="tab" tabindex="0">C++</button><button aria-controls="panel-4-UHl0aG9u" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-4-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="-1">Python</button></div><div aria-labelledby="tab-4-Qysr" class="sphinx-tabs-panel group-tab" id="panel-4-Qysr" name="Qysr" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">client_cb_group_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">create_callback_group</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">CallbackGroupType</span><span class="o">::</span><span class="n">MutuallyExclusive</span><span class="p">);</span><span class="w"></span>
<span class="n">timer_cb_group_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">create_callback_group</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">CallbackGroupType</span><span class="o">::</span><span class="n">MutuallyExclusive</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-4-UHl0aG9u" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-4-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">client_cb_group</span> <span class="o">=</span> <span class="n">MutuallyExclusiveCallbackGroup</span><span class="p">()</span>
<span class="n">timer_cb_group</span> <span class="o">=</span> <span class="n">MutuallyExclusiveCallbackGroup</span><span class="p">()</span>
</pre></div>
</div>
</div></div>
<p>现在我们得到了预期的结果，即定时器重复触发，并且每个服务调用都按照应有的方式得到结果：</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-5-Q2xpZW50" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-5-Q2xpZW50" name="Q2xpZW50" role="tab" tabindex="0">Client</button><button aria-controls="panel-5-U2VydmVy" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-5-U2VydmVy" name="U2VydmVy" role="tab" tabindex="-1">Server</button></div><div aria-labelledby="tab-5-Q2xpZW50" class="sphinx-tabs-panel group-tab" id="panel-5-Q2xpZW50" name="Q2xpZW50" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">[INFO] [1653067523.431731177] [client_node]: Starting client node, shut down with CTRL-C</span>
<span class="go">[INFO] [1653067524.431912821] [client_node]: Sending request</span>
<span class="go">[INFO] [1653067524.433230445] [client_node]: Received response</span>
<span class="go">[INFO] [1653067525.431869330] [client_node]: Sending request</span>
<span class="go">[INFO] [1653067525.432912803] [client_node]: Received response</span>
<span class="go">[INFO] [1653067526.431844726] [client_node]: Sending request</span>
<span class="go">[INFO] [1653067526.432893954] [client_node]: Received response</span>
<span class="go">[INFO] [1653067527.431828287] [client_node]: Sending request</span>
<span class="go">[INFO] [1653067527.432848369] [client_node]: Received response</span>
<span class="go">^C[INFO] [1653067528.400052749] [client_node]: Keyboard interrupt, shutting down.</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-5-U2VydmVy" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-5-U2VydmVy" name="U2VydmVy" role="tabpanel" tabindex="0"><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">[INFO] [1653067522.052866001] [service_node]: Starting server node, shut down with CTRL-C</span>
<span class="go">[INFO] [1653067524.432577720] [service_node]: Received request, responding...</span>
<span class="go">[INFO] [1653067525.432365009] [service_node]: Received request, responding...</span>
<span class="go">[INFO] [1653067526.432300261] [service_node]: Received request, responding...</span>
<span class="go">[INFO] [1653067527.432272441] [service_node]: Received request, responding...</span>
<span class="go">^C[INFO] [1653034416.021962246] [service_node]: KeyboardInterrupt, shutting down.</span>
</pre></div>
</div>
</div></div>
<p>有人可能会考虑是否仅仅避免使用节点的默认回调组就足够了。但事实并非如此：用不同的互斥组替换默认组并没有改变什么。因此，以下配置也会导致之前发现的死锁问题。</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-6-Qysr" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-6-Qysr" name="Qysr" role="tab" tabindex="0">C++</button><button aria-controls="panel-6-UHl0aG9u" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-6-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="-1">Python</button></div><div aria-labelledby="tab-6-Qysr" class="sphinx-tabs-panel group-tab" id="panel-6-Qysr" name="Qysr" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">client_cb_group_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">create_callback_group</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">CallbackGroupType</span><span class="o">::</span><span class="n">MutuallyExclusive</span><span class="p">);</span><span class="w"></span>
<span class="n">timer_cb_group_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client_cb_group_</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-6-UHl0aG9u" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-6-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">client_cb_group</span> <span class="o">=</span> <span class="n">MutuallyExclusiveCallbackGroup</span><span class="p">()</span>
<span class="n">timer_cb_group</span> <span class="o">=</span> <span class="n">client_cb_group</span>
</pre></div>
</div>
</div></div>
<p>事实上，在这种情况下，一切正常工作的确切条件是计时器和客户端不能属于同一互斥组。因此，以下所有配置（以及其他一些配置）都会产生所需的结果，即计时器重复触发并完成服务调用。</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-7-Qysr" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-7-Qysr" name="Qysr" role="tab" tabindex="0">C++</button><button aria-controls="panel-7-UHl0aG9u" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-7-UHl0aG9u" name="UHl0aG9u" role="tab" tabindex="-1">Python</button></div><div aria-labelledby="tab-7-Qysr" class="sphinx-tabs-panel group-tab" id="panel-7-Qysr" name="Qysr" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">client_cb_group_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">create_callback_group</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">CallbackGroupType</span><span class="o">::</span><span class="n">Reentrant</span><span class="p">);</span><span class="w"></span>
<span class="n">timer_cb_group_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client_cb_group_</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>或</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">client_cb_group_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">create_callback_group</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">CallbackGroupType</span><span class="o">::</span><span class="n">MutuallyExclusive</span><span class="p">);</span><span class="w"></span>
<span class="n">timer_cb_group_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>或</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">client_cb_group_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
<span class="n">timer_cb_group_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">create_callback_group</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">CallbackGroupType</span><span class="o">::</span><span class="n">MutuallyExclusive</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>或</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">client_cb_group_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">create_callback_group</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">CallbackGroupType</span><span class="o">::</span><span class="n">Reentrant</span><span class="p">);</span><span class="w"></span>
<span class="n">timer_cb_group_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</div><div aria-labelledby="tab-7-UHl0aG9u" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-7-UHl0aG9u" name="UHl0aG9u" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">client_cb_group</span> <span class="o">=</span> <span class="n">ReentrantCallbackGroup</span><span class="p">()</span>
<span class="n">timer_cb_group</span> <span class="o">=</span> <span class="n">client_cb_group</span>
</pre></div>
</div>
<p>或</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">client_cb_group</span> <span class="o">=</span> <span class="n">MutuallyExclusiveCallbackGroup</span><span class="p">()</span>
<span class="n">timer_cb_group</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<p>或</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">client_cb_group</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">timer_cb_group</span> <span class="o">=</span> <span class="n">MutuallyExclusiveCallbackGroup</span><span class="p">()</span>
</pre></div>
</div>
<p>或</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">client_cb_group</span> <span class="o">=</span> <span class="n">ReentrantCallbackGroup</span><span class="p">()</span>
<span class="n">timer_cb_group</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</div></div>
</div>
</div>
</div>

  <div id="footer">
    <p>欢迎帮助改进！</p>
  </div>
</body>
</html>