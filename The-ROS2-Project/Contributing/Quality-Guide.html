<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>The-ROS2-Project/Contributing/Quality-Guide</title>
</head>
<body>
  <div class="section" id="quality-guide-ensuring-code-quality">
<h1>质量指南：确保代码质量 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2231">[2231]</a><a class="headerlink" href="#quality-guide-ensuring-code-quality" title="永久链接至标题"></a></h1>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title">目录 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=1329">[]</a></p>
<ul class="simple">
<li><p><a class="reference internal" href="#static-code-analysis-as-part-of-the-ament-package-build" id="id1">作为ament软件包构建的一部分的静态代码分析 [2234]</a></p></li>
<li><p><a class="reference internal" href="#static-thread-safety-analysis-via-code-annotation" id="id2">通过代码注释进行静态线程安全性分析 [2257]</a></p></li>
<li><p><a class="reference internal" href="#dynamic-analysis-data-races-deadlocks" id="id3">动态分析（数据竞争和死锁）。 [2305]</a></p></li>
</ul>
</div>
<p>本页面提供关于如何改善ROS 2软件包的软件质量的指导，重点是比《开发者指南》的质量实践部分更具体的领域。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2232">[2232]</a></p>
<p>以下各节旨在解决ROS 2核心、应用和生态系统软件包以及核心客户端库（C++和Python）的问题。所提出的解决方案受到设计和实现考虑的推动，以改善&quot;可靠性&quot;、&quot;安全性&quot;、&quot;可维护性&quot;、&quot;确定性&quot;等质量属性，这些属性与非功能性需求有关。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2233">[2233]</a></p>
<div class="section" id="static-code-analysis-as-part-of-the-ament-package-build">
<h2>作为ament软件包构建的一部分的静态代码分析 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2234">[2234]</a><a class="headerlink" href="#static-code-analysis-as-part-of-the-ament-package-build" title="永久链接至标题"></a></h2>
<p><strong>上下文</strong>： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2235">[2235]</a></p>
<ul class="simple">
<li><p>您已经开发了您的C++生产代码。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2236">[2236]</a></p></li>
<li><p>您已经创建了一个具有``ament``构建支持的ROS 2包。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2237">[2237]</a></p></li>
</ul>
<p><strong>问题</strong>： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2238">[2238]</a></p>
<ul class="simple">
<li><p>在软件包构建过程中，不会运行库级静态代码分析。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2239">[2239]</a></p></li>
<li><p>需要手动执行库级静态代码分析。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2240">[2240]</a></p></li>
<li><p>在构建新的软件包版本之前，有可能会忘记执行库级静态代码分析。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2241">[2241]</a></p></li>
</ul>
<p><strong>解决方案</strong>： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2242">[2242]</a></p>
<ul class="simple">
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">ament</span></code> 的集成能力，在软件包构建过程中执行静态代码分析。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2243">[2243]</a></p></li>
</ul>
<p><strong>实现</strong>： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2244">[2244]</a></p>
<ul class="simple">
<li><p>将其插入到软件包的 <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> 文件中。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2245">[2245]</a></p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>...
<span class="k">if</span><span class="o">(</span>BUILD_TESTING<span class="o">)</span>
  find_package<span class="o">(</span>ament_lint_auto REQUIRED<span class="o">)</span>
  ament_lint_auto_find_test_dependencies<span class="o">()</span>
  ...
endif<span class="o">()</span>
...
</pre></div>
</div>
<ul class="simple">
<li><p>将 <code class="docutils literal notranslate"><span class="pre">ament_lint</span></code> 的测试依赖项插入到软件包的 <code class="docutils literal notranslate"><span class="pre">package.xml</span></code> 文件中。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2246">[2246]</a></p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>...
&lt;package <span class="nv">format</span><span class="o">=</span><span class="s2">&quot;2&quot;</span>&gt;
  ...
  &lt;test_depend&gt;ament_lint_auto&lt;/test_depend&gt;
  &lt;test_depend&gt;ament_lint_common&lt;/test_depend&gt;
  ...
&lt;/package&gt;
</pre></div>
</div>
<p><strong>示例</strong>: <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2247">[2247]</a></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rclcpp</span></code>: <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2248">[2248]</a></p>
<ul>
<li><p><a class="reference external" href="https://github.com/ros2/rclcpp/blob/humble/rclcpp/CMakeLists.txt">rclcpp/rclcpp/CMakeLists.txt</a> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2249">[2249]</a></p></li>
<li><p><a class="reference external" href="https://github.com/ros2/rclcpp/blob/humble/rclcpp/package.xml">rclcpp/rclcpp/package.xml</a> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2250">[2250]</a></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">rclcpp_lifecycle</span></code>: <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2251">[2251]</a></p>
<ul>
<li><p><a class="reference external" href="https://github.com/ros2/rclcpp/blob/humble/rclcpp_lifecycle/CMakeLists.txt">rclcpp/rclcpp_lifecycle/CMakeLists.txt</a> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2252">[2252]</a></p></li>
<li><p><a class="reference external" href="https://github.com/ros2/rclcpp/blob/humble/rclcpp_lifecycle/package.xml">rclcpp/rclcpp_lifecycle/package.xml</a> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2253">[2253]</a></p></li>
</ul>
</li>
</ul>
<p><strong>产生的上下文</strong>： <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2254">[2254]</a></p>
<ul class="simple">
<li><p><a href="#id1"><span class="problematic" id="id2">``</span></a>ament``支持的静态代码分析工具是作为软件包构建的一部分运行的。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2255">[2255]</a></p></li>
<li><p><a href="#id1"><span class="problematic" id="id2">``</span></a>ament``不支持的静态代码分析工具需要单独执行。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2256">[2256]</a></p></li>
</ul>
</div>
<div class="section" id="static-thread-safety-analysis-via-code-annotation">
<h2>通过代码注释进行静态线程安全性分析 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2257">[2257]</a><a class="headerlink" href="#static-thread-safety-analysis-via-code-annotation" title="永久链接至标题"></a></h2>
<p><strong>上下文：</strong> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2258">[2258]</a></p>
<ul class="simple">
<li><p>您正在开发/调试多线程的C++生产代码 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2259">[2259]</a></p></li>
<li><p>您在C++代码中从多个线程访问数据 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2260">[2260]</a></p></li>
</ul>
<p><strong>问题：</strong> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2261">[2261]</a></p>
<ul class="simple">
<li><p>数据竞争和死锁可能导致关键错误。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2262">[2262]</a></p></li>
</ul>
<p><strong>解决方案:</strong> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2263">[2263]</a></p>
<ul class="simple">
<li><p>通过为线程代码添加注释，利用Clang的静态`Thread Safety Analysis &lt;<a class="reference external" href="https://clang.llvm.org/docs/ThreadSafetyAnalysis.html">https://clang.llvm.org/docs/ThreadSafetyAnalysis.html</a>&gt;`__ <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2264">[2264]</a></p></li>
</ul>
<p><strong>实现的上下文:</strong> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2265">[2265]</a></p>
<p>要启用线程安全分析，必须对代码进行注释，以便编译器了解代码的语义。这些注释是特定于Clang的属性，例如``__attribute__(capability()))``。ROS 2提供了预处理宏来代替直接使用这些属性，在使用其他编译器时这些宏会被擦除。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2266">[2266]</a></p>
<p>这些宏可以在 <a class="reference external" href="https://github.com/ros2/rcpputils/blob/humble/include/rcpputils/thread_safety_annotations.hpp">rcpputils/thread_safety_annotations.hpp</a> 中找到 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2267">[2267]</a></p>
<dl class="simple">
<dt>线程安全分析文档说明如下 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2268">[2268]</a></dt><dd><p>线程安全分析可以与任何线程库一起使用，但需要将线程 API 包装在具有适当注释的类和方法中 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2269">[2269]</a></p>
</dd>
</dl>
<p>我们决定允许 ROS 2 开发人员直接使用 <code class="docutils literal notranslate"><span class="pre">std::</span></code> 线程原语进行开发，而不提供上述建议中的自定义包装类型 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2270">[2270]</a></p>
<p>有三个 C++ 标准库需要注意 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2271">[2271]</a></p>
<ul class="simple">
<li><p>GNU 标准库 <code class="docutils literal notranslate"><span class="pre">libstdc++</span></code> - 在 Linux 上为默认选项，可以通过编译器选项 <code class="docutils literal notranslate"><span class="pre">-stdlib=libstdc++</span></code> 显式设置 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2272">[2272]</a></p></li>
<li><p>LLVM 标准库 <code class="docutils literal notranslate"><span class="pre">libc++``（也称为</span> <span class="pre">``libcxx</span></code>）- 在 macOS 上为默认选项，可以通过编译器选项 <code class="docutils literal notranslate"><span class="pre">-stdlib=libc++</span></code> 显式设置 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2273">[2273]</a></p></li>
<li><p>Windows C++ 标准库 - 对于此用例无关 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2274">[2274]</a></p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">libcxx</span></code> 在其 <code class="docutils literal notranslate"><span class="pre">std::mutex</span></code> 和 <code class="docutils literal notranslate"><span class="pre">std::lock_guard</span></code> 实现中添加了线程安全分析的注释。当使用 GNU <code class="docutils literal notranslate"><span class="pre">libstdc++</span></code> 时，这些注释不存在，因此无法在未包装的 <code class="docutils literal notranslate"><span class="pre">std::</span></code> 类型上使用线程安全分析。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2275">[2275]</a></p>
<p><em>因此，要直接使用线程安全分析与</em> <code class="docutils literal notranslate"><span class="pre">std::</span></code> <em>类型，我们必须使用</em> <code class="docutils literal notranslate"><span class="pre">libcxx</span></code> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2276">[2276]</a></p>
<p><strong>实施方法：</strong> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2277">[2277]</a></p>
<p>这里提供的代码迁移建议并不完整 - 在编写（或注释现有）线程代码时，建议根据您的使用情况尽可能多地使用注释。然而，这个逐步过程是一个很好的起点！ <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2278">[2278]</a></p>
<ul>
<li><p>启用包/目标的分析功能 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2279">[2279]</a></p>
<p>当C++编译器为Clang时，启用``-Wthread-safety``标志。以下是基于CMake的项目示例 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2280">[2280]</a></p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">if</span><span class="p">(</span><span class="s">CMAKE_CXX_COMPILER_ID</span><span class="w"> </span><span class="s">MATCHES</span><span class="w"> </span><span class="s2">&quot;Clang&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">add_compile_options</span><span class="p">(</span><span class="s">-Wthread-safety</span><span class="p">)</span><span class="w">   </span><span class="c"># for your whole package</span>
<span class="w">  </span><span class="nb">target_compile_options</span><span class="p">(</span><span class="o">${</span><span class="nv">MY_TARGET</span><span class="o">}</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="s">-Wthread-safety</span><span class="p">)</span><span class="w">  </span><span class="c"># for a single library or executable</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>注释代码 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2281">[2281]</a></p>
<ul>
<li><p>步骤1 - 注释数据成员 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2282">[2282]</a></p>
<ul class="simple">
<li><p>找到任何使用 <code class="docutils literal notranslate"><span class="pre">std::mutex</span></code> 保护某些成员数据的地方 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2283">[2283]</a></p></li>
<li><p>在由互斥锁保护的数据上添加 <code class="docutils literal notranslate"><span class="pre">RCPPUTILS_TSA_GUARDED_BY(mutex_name)</span></code> 注释 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2284">[2284]</a></p></li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">incr</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">bar</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">amount</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bar</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="k">mutable</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="w"> </span><span class="n">mutex_</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">bar</span><span class="w"> </span><span class="nf">RCPPUTILS_TSA_GUARDED_BY</span><span class="p">(</span><span class="n">mutex_</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>步骤2 - 修复警告 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2285">[2285]</a></p>
<ul class="simple">
<li><p>在上面的示例中，<code class="docutils literal notranslate"><span class="pre">Foo::get</span></code> 会产生编译器警告！为了修复它，在返回 bar 之前进行锁定 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2286">[2286]</a></p></li>
</ul>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">get</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">bar</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>步骤3 - （可选但建议）将现有代码重构为私有互斥模式 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2287">[2287]</a></p>
<p>在使用多线程的C++代码中，推荐的模式是将 <code class="docutils literal notranslate"><span class="pre">mutex</span></code> 作为数据结构的 <code class="docutils literal notranslate"><span class="pre">private:</span></code> 成员始终保留。这样可以使数据安全成为包含结构的责任，减轻了结构的使用者的责任，并最大程度地减少了受影响代码的表面积。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2288">[2288]</a></p>
<p>将锁定操作设为私有可能需要重新思考数据的接口。这是一个很好的练习 - 下面是一些需要考虑的事项 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2289">[2289]</a></p>
<ul class="simple">
<li><p>您可能希望为执行需要复杂锁定逻辑的分析提供专门的接口，例如，在受互斥保护的映射结构的过滤集合中计算成员数，而不是实际返回底层结构给使用者。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2290">[2290]</a></p></li>
<li><p>考虑进行复制以避免阻塞，当数据量较小时。这样可以让其他线程继续访问共享数据，从而可能带来更好的整体性能。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2291">[2291]</a></p></li>
</ul>
</li>
<li><p>步骤4 - （可选）启用负能力分析 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2292">[2292]</a></p>
<p><a class="reference external" href="https://clang.llvm.org/docs/ThreadSafetyAnalysis.html#negative-capabilities">https://clang.llvm.org/docs/ThreadSafetyAnalysis.html#negative-capabilities</a> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2293">[2293]</a></p>
<p>负能力分析允许您指定“调用此函数时不得持有此锁”。它可以揭示其他注释无法发现的潜在死锁情况。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2294">[2294]</a></p>
<ul class="simple">
<li><p>在您指定了``-Wthread-safety``的地方，添加额外的标志``-Wthread-safety-negative`` <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2295">[2295]</a></p></li>
<li><p>在任何获取锁的函数中，使用``RCPPUTILS_TSA_REQUIRES(!mutex)``模式 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2296">[2296]</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p>如何运行分析 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2297">[2297]</a></p>
<ul>
<li><p>ROS CI构建系统每晚会运行一个带有``libcxx``的作业，在Thread Safety Analysis引发警告时，ROS 2核心堆栈中的任何问题都将被标记为&quot;不稳定&quot; <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2298">[2298]</a></p></li>
<li><p>对于本地运行，您有以下选项，全部等效 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2299">[2299]</a></p>
<ul>
<li><p>使用 colcon <a class="reference external" href="https://github.com/colcon/colcon-mixin-repository/blob/master/README.md">clang-libcxx mixin &lt;https://github.com/colcon/colcon-mixin-repository/blob/master/clang-libcxx.mixin&gt;`__（参见`文档</a> 以配置 mixin）:: <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2300">[2300]</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">colcon</span> <span class="n">build</span> <span class="o">--</span><span class="n">mixin</span> <span class="n">clang</span><span class="o">-</span><span class="n">libcxx</span>
</pre></div>
</div>
</li>
<li><p>将编译器传递给 CMake:: <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2301">[2301]</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">colcon</span> <span class="n">build</span> <span class="o">--</span><span class="n">cmake</span><span class="o">-</span><span class="n">args</span> <span class="o">-</span><span class="n">DCMAKE_C_COMPILER</span><span class="o">=</span><span class="n">clang</span> <span class="o">-</span><span class="n">DCMAKE_CXX_COMPILER</span><span class="o">=</span><span class="n">clang</span><span class="o">++</span> <span class="o">-</span><span class="n">DCMAKE_CXX_FLAGS</span><span class="o">=</span><span class="s1">&#39;-stdlib=libc++ -D_LIBCPP_ENABLE_THREAD_SAFETY_ANNOTATIONS&#39;</span> <span class="o">-</span><span class="n">DFORCE_BUILD_VENDOR_PKG</span><span class="o">=</span><span class="n">ON</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">warn</span><span class="o">-</span><span class="n">unused</span><span class="o">-</span><span class="n">cli</span>
</pre></div>
</div>
</li>
<li><p>覆盖系统编译器:: <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2302">[2302]</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CC</span><span class="o">=</span><span class="n">clang</span> <span class="n">CXX</span><span class="o">=</span><span class="n">clang</span><span class="o">++</span> <span class="n">colcon</span> <span class="n">build</span> <span class="o">--</span><span class="n">cmake</span><span class="o">-</span><span class="n">args</span> <span class="o">-</span><span class="n">DCMAKE_CXX_FLAGS</span><span class="o">=</span><span class="s1">&#39;-stdlib=libc++ -D_LIBCPP_ENABLE_THREAD_SAFETY_ANNOTATIONS&#39;</span> <span class="o">-</span><span class="n">DFORCE_BUILD_VENDOR_PKG</span><span class="o">=</span><span class="n">ON</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">warn</span><span class="o">-</span><span class="n">unused</span><span class="o">-</span><span class="n">cli</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>结果上下文：</strong> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2303">[2303]</a></p>
<ul class="simple">
<li><p>使用Clang和`libcxx`时，可能会在编译时检测到潜在的死锁和竞态条件。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2304">[2304]</a></p></li>
</ul>
</div>
<div class="section" id="dynamic-analysis-data-races-deadlocks">
<h2>动态分析（数据竞争和死锁）。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2305">[2305]</a><a class="headerlink" href="#dynamic-analysis-data-races-deadlocks" title="永久链接至标题"></a></h2>
<p><strong>上下文：</strong> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2258">[2258]</a></p>
<ul class="simple">
<li><p>您正在开发/调试多线程的C++生产代码。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2306">[2306]</a></p></li>
<li><p>您使用 pthreads 或 C++11 线程 + llvm libc++（在 ThreadSanitizer 的情况下）。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2307">[2307]</a></p></li>
<li><p>您不使用 Libc/libstdc++ 的静态链接（在 ThreadSanitizer 的情况下）。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2308">[2308]</a></p></li>
<li><p>您不构建非位置无关的可执行文件（在 ThreadSanitizer 的情况下）。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2309">[2309]</a></p></li>
</ul>
<p><strong>问题：</strong> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2261">[2261]</a></p>
<ul class="simple">
<li><p>数据竞争和死锁可能导致关键错误。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2262">[2262]</a></p></li>
<li><p>使用静态分析无法检测数据竞争和死锁（原因：静态分析的限制）。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2310">[2310]</a></p></li>
<li><p>在开发调试/测试期间不应出现数据竞争和死锁（原因：通常不会对生产代码中的所有可能控制路径进行测试）。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2311">[2311]</a></p></li>
</ul>
<p><strong>解决方案:</strong> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2263">[2263]</a></p>
<ul class="simple">
<li><p>使用一个专注于查找数据竞争和死锁的动态分析工具（例如 clang ThreadSanitizer）。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2312">[2312]</a></p></li>
</ul>
<p><strong>实施方法：</strong> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2277">[2277]</a></p>
<ul class="simple">
<li><p>使用选项“-fsanitize=thread”将生产代码编译和链接到 clang 中（这会对生产代码进行插桩）。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2313">[2313]</a></p></li>
<li><p>如果在分析期间需要执行不同的生产代码，请考虑条件编译，例如 ThreadSanitizers <a class="reference external" href="https://clang.llvm.org/docs/ThreadSanitizer.html#has-feature-thread-sanitizer">_has_feature(thread_sanitizer)</a>。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2314">[2314]</a></p></li>
<li><p>如果有些代码不需要进行插桩，考虑使用 <a class="reference external" href="https://clang.llvm.org/docs/ThreadSanitizer.html#attribute-no-sanitize-thread">ThreadSanitizers _/*attribute*/_((no_sanitize(&quot;thread&quot;)))</a>。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2315">[2315]</a></p></li>
<li><p>如果有些文件或函数不需要进行插桩，考虑使用文件级别或函数级别的排除 <a class="reference external" href="https://clang.llvm.org/docs/ThreadSanitizer.html#ignorelist">ThreadSanitizers黑名单</a>，更具体地说，使用 <a class="reference external" href="https://clang.llvm.org/docs/SanitizerSpecialCaseList.html">ThreadSanitizers Sanitizer特例列表</a> 或者使用 <a class="reference external" href="https://clang.llvm.org/docs/ThreadSanitizer.html#ignorelist">ThreadSanitizers no_sanitize(&quot;thread&quot;)</a> 并且使用选项 <code class="docutils literal notranslate"><span class="pre">--fsanitize-blacklist</span></code>。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2316">[2316]</a></p></li>
</ul>
<p><strong>结果上下文：</strong> <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2317">[2317]</a></p>
<ul class="simple">
<li><p>在部署之前，生产代码中更有可能发现数据竞争和死锁问题。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2318">[2318]</a></p></li>
<li><p>分析结果可能缺乏可靠性，工具处于测试阶段（在ThreadSanitizer的情况下）。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2319">[2319]</a></p></li>
<li><p>生产代码仪器化导致的开销（为仪器化和非仪器化生产代码维护不同的分支等）。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2320">[2320]</a></p></li>
<li><p>仪器化代码每个线程需要更多内存（在ThreadSanitizer的情况下）。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2321">[2321]</a></p></li>
<li><p>仪器化代码映射了大量的虚拟地址空间（在ThreadSanitizer的情况下）。 <a class="reference external" href="http://fishros.org/page/calib/#/home?apihost=http://fishros.org:2023/ros2/calib&amp;msgid=2322">[2322]</a></p></li>
</ul>
</div>
</div>

  <div id="footer">
    <p>欢迎帮助改进！</p>
  </div>
</body>
</html>